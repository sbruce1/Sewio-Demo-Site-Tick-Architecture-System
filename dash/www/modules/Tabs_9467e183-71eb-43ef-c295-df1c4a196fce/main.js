define(["backbone","Handlebars","QuickBase","css!./css/main.css"],function(e,t,l){"use strict";var o,i=this&&this.__extends||(o=function(e,t){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)},function(e,t){function i(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}),c=(n.getGUID=function(){function e(){return Math.floor(65536*Math.random()).toString(16)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},n);function n(){}var s=(a.getComponentDefinition=function(e){var t={id:26,componentName:"tabs",componentDescription:"Tab control.",appKey:"Tabs",disable_array_reorder:!0,listViewThumb:e.websiteUrl+"Images/tabs.png",ghostViewThumb:null,buildViewThumb:null,appArgs:{json:{version:"4.2.0s2",dropdownPossibleValues:[],Selection:{target_tab:"",unloadInactive:"",SetViewStateOnSelect:{ViewState:"",Value:""}},Basics:{ComponentName:"tabs"},Items:[{Id:c.getGUID(),Name:"Tab 1",Tooltip:"",HideTab:!1},{Id:c.getGUID(),Name:"Tab 2",Tooltip:"",HideTab:!1}],Style:{advanced:""}},schema:{type:"object",title:"Properties",properties:{dropdownPossibleValues:{type:"array",format:"table",items:{type:"object",properties:{Id:{type:"string"},Name:{type:"string"}}},options:{hidden:!0,disable_array_reorder:!0}},Selection:{type:"object",title:"View State",options:{collapsed:!1,disable_array_reorder:!0},properties:{target_tab:{type:"string",title:"Selected Tab",watch:{dashboards:"root.dropdownPossibleValues"},enumSource:{source:"dashboards",title:"Name",value:"Id"}},unloadInactive:{type:"boolean",title:"Unload Inactive Tabs",format:"checkbox",default:!1},SetViewStateOnSelect:{type:"object",title:"Set View State On Tab Change",options:{collapsed:!0},properties:{ViewState:{title:"View State",type:"viewstate"},Value:{type:"string",default:"<tabname>"}}}}},Basics:{type:"object",title:"Basics",options:{hidden:!0,disable_array_reorder:!0},properties:{ComponentName:{type:"string",title:"hide me",default:"tabs"}}},Items:{type:"array",format:"object",title:"Tabs",uniqueItems:!0,options:{collapsed:!1},items:{type:"object",title:"Tab",properties:{Id:{type:"string",default:"",options:{hidden:!0}},Name:{type:"string"},Tooltip:{type:"string",default:""},HideTab:{type:"boolean",title:"Hide",format:"checkbox",default:!1}}}},Style:{type:"object",title:"Style",options:{collapsed:!0},properties:{advanced:{type:"css",title:"Advanced CSS",default:""}}}}}}};if(0<_.keys(e.settingsModel.attributes).length)for(var i=void 0,o=a.upgrades.indexOf(_.find(a.upgrades,{version:e.settingsModel.get("version")}))+1;o<a.upgrades.length;o+=1)(i=a.upgrades[o]).fn(e.settingsModel),e.settingsModel.set("version",i.version);return t},a.upgrades=[{version:"4.0.0d14",fn:function(e){_.each(e.get("Items"),function(e){return e.HideTab=!1})}},{version:"4.1.0s1",fn:function(e){_.each(e.get("Items"),function(e){e.Tooltip=""})}},{version:"4.2.0s2",fn:function(e){_.isUndefined(e.get("Selection.unloadInactive"))&&e.set("Selection.unloadInactive",!1)}}],a);function a(){}var d,r=(p.app=t.template({compiler:[7,">= 4.0.0"],main:function(e,t,i,o,n){return'<div class="tabs-div">\r\n    <ul></ul>\r\n\r\n    <div class="interaction-div">\r\n        <div class="selection-div">\r\n            <div class="fa fa-times remove-btn"></div>\r\n        </div>\r\n    </div>\r\n</div>'},useData:!0}),p);function p(){}function h(e){var t,n=d.call(this,e)||this;return n.ignoreItemsChange=!1,n.ignoreWidgetSelect=!1,n.options=e,n.api=e.api,n.viewModel=e.viewModel,n.dataModel=e.dataModel,n.dashboardAppModel=e.dashboardAppModel,n.dashboardViewModel=e.dashboardViewModel,n.settingsModel=e.settingsModel,n.websiteUrl=e.websiteUrl,n.componentModel=e.componentModel,n.DeltaClientLib=e.DeltaClientLib,n.quickView=e.quickView||!1,n.viewModel=new window.Backbone.DeepModel({dropdownPossibleValues:[]}),n.tabsItems=[],n.initializeEvents(),t=!(t=parseInt(n.api.getProperty("Selection.target_tab"),10))||t>=n.settingsModel.get("Items").length?0:t,_.defer(function(){n.render(),n.refreshDropdownItems(),n.onSelectionChanged(null,{target_tab:_.isUndefined(t)?n.viewModel.get("Selection.target_tab"):t});var i=[],o=[];_.each(n.viewModel.get("Items"),function(e,t){_.isEmpty(e)||(e.HideTab?i:o).push(t)}),n.toggleTabs(i,o)}),n.api.setProperty("Selection.target_tab",t),n.setTheme(null),n.onBuildModeChanged(),n}return d=Backbone.View,i(h,d),h.prototype.initializeEvents=function(){var i=this;this.listenTo(this.viewModel,"change:Items",function(e,t){return i.onItemsChanged(e,t)}),this.listenTo(this.viewModel,"change:Selection.target_tab",function(e,t){return i.onSelectionChanged(e,t)}),this.listenTo(this.componentModel.get("components"),"add",function(e,t){return i.onComponentAdded(e,t)}),this.listenTo(this.componentModel.get("components"),"remove",function(e){return i.onComponentRemoved(e)}),this.listenTo(this.dashboardViewModel,"change:buildMode",function(){return i.onBuildModeChanged()}),this.listenTo(this.dashboardViewModel,"change:DashboardTheme",function(e,t){i.setTheme(t)}),this.listenTo(this.dashboardViewModel,"change:selectedWidget",function(e,t){return i.onSelectedWidgetChanged(e,t)}),this.listenTo(this.dashboardViewModel,"change:selectedSubComponent",function(e,t){return i.onSubComponentChanged(e,t)}),this.listenTo(this.viewModel,"change:Selection.unloadInactive change:Selection.target_tab",function(){return i.onUnloadInactive()}),this.listenTo(this.dashboardAppModel,"change:pendingSelectionWidgetId",function(e,t){return i.onSelectingWidget(e,t)}),this.$el.on("dragenter",function(e){return i.onDragEnter(e)}),this.$el.on("dragover",function(e){return i.onDragOver(e)}),this.$el.on("dragleave",function(){return i.onDragLeave()}),this.$el.on("drop",function(){return i.onDragLeave()})},h.prototype.addApp=function(e,t){var n=this,i=t.attr("id"),o=this.getSelectedDocument(),s=new l.Widget({id:e.id},{},{});s.set("component",e);var a=new l.ComponentView({model:e,dashboardAppModel:this.dashboardAppModel,dashboardViewModel:this.dashboardViewModel,docViewModel:o.get("viewState"),docDataModel:o.get("data"),deltaClient:this.DeltaClientLib,quickView:this.quickView,websiteUrl:this.websiteUrl,widgetId:s.id}),d={containerId:i,$div:t,widgetId:s.id,model:s,view:a};t.empty();var r=$(document.createElement("div"));r.addClass("fa fa-times remove-btn"),r.attr("title",a.getComponentName()),r.appendTo(t),r.click(function(e){e.preventDefault(),e.stopPropagation(),s.trigger("removeWidget")});o=_.find(this.tabsItems,{Id:i});e.set("containerId",i),o.widgetItem=d,a.model&&t.attr("data-componentid",a.model.get("key")),t.attr("data-widgetid",s.id),a.$el.appendTo(t),t.off("click"),t.on("click",function(e){return n.onAppClick(d,e)}),this.listenTo(s,"removeWidget",_.bind(function(e,t,i,o){t.off(),i.remove(),n.componentModel.get("components").commandRemove(e),o.widgetItem=null,n.dashboardViewModel.set("selectedWidget",null),n.dashboardViewModel.set("selectedWidgetView",null,{silent:!0})},this,e,t,r,o))},h.prototype.addTab=function(e,t,i,o,n){var s=$(document.createElement("li")),a=$(document.createElement("div")),d=$(document.createElement("a")),o={Id:e,Name:t,Index:o,Tooltip:n=n||""};return this.tabsItems.push(o),d.attr("title",this.convertTooltipNewlines(n)),d.attr("href","#"+e),d.text(t),d.appendTo(s),a.attr("id",e),s.appendTo(this.$ul),a.appendTo(this.$root),o},h.prototype.convertTooltipNewlines=function(e){return(e||"").replace(/(?:\\r\\n|\\r|\\n)/g,"\r\n")},h.prototype.findTabItem=function(t){return _.find(this.tabsItems,function(e){return e.widgetItem&&e.widgetItem.widgetId===t})},h.prototype.getSelectedDocument=function(){return this.dashboardAppModel.get("documents").get(this.dashboardViewModel.get("selectedDocumentId"))},h.prototype.isInteger=function(e){return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e},h.prototype.onAppClick=function(e,t){this.ignoreWidgetSelect||(t&&t.stopPropagation&&t.stopPropagation(),this.dashboardViewModel.get("selectedWidget")===e.model?(this.dashboardViewModel.set("selectedWidget",null),this.dashboardViewModel.set("selectedWidgetView",null,{silent:!0})):(this.dashboardViewModel.set("selectedWidget",e.model),this.dashboardViewModel.set("selectedWidgetView",e.view,{silent:!0})))},h.prototype.onBuildModeChanged=function(){this.dashboardViewModel.get("buildMode")&&!this.quickView?this.ignoreWidgetSelect=!1:this.ignoreWidgetSelect=!0},h.prototype.onComponentAdded=function(e,t){this.currentTabItem.widgetItem&&this.currentTabItem.widgetItem.view&&t.remove(this.currentTabItem.widgetItem.view.model),this.addApp(e,this.$currentDiv)},h.prototype.onComponentRemoved=function(e){e=e.get("containerId"),e=_.find(this.tabsItems,{Id:e});e.widgetItem.view&&e.widgetItem.view&&e.widgetItem.view.remove&&e.widgetItem.view.remove()},h.prototype.onDragEnter=function(e){this.api.isBuildMode()&&this.onDragOver(e)},h.prototype.onDragLeave=function(){this.api.isBuildMode()&&this.$el.removeClass("drop-target")},h.prototype.onDragOver=function(e){if(this.api.isBuildMode()){if(l.ComponentDropView.prototype.isDraggingSupportedFile(e))return!1;if(_.includes(["Accordion","FlexPanel","Panel","Tabs"],_.get(this.currentTabItem,"widgetItem.model.attributes.component.attributes.key")))return!1;this.$el.addClass("drop-target")}return!0},h.prototype.onItemsChanged=function(e,t){var i=this;if(!this.rendered||this.ignoreItemsChange)return!1;var o,n=!1,s=!1,a=[],d=[],r=[];_.each(t,function(e,t){_.isEmpty(e)||(e.Id.length<=0&&(e.Id=c.getGUID(),n=!0),(o=_.find(i.tabsItems,{Id:e.Id}))?(o.Name!==e.Name&&(i.updateTabName(o.Id,e.Name),n=!0),o.Tooltip!==e.Tooltip&&i.updateTabTooltip(o.Id,e.Tooltip),o.Index!==t&&(s=!0,o.Index=t),a.push(o)):(i.api.setProperty("Items."+t+".Name","Tab "+(t+1)),e.Name="Tab "+(t+1),a.push(i.addTab(e.Id,e.Name,e,t,e.Tooltip))),(e.HideTab?d:r).push(t))});var l=_.filter(this.tabsItems,function(e){return!_.includes(a,e)});return 0<l.length&&(n=!0,_.each(l,function(e){i.onRemoveTab(e)})),n&&(this.ignoreItemsChange=!0,_.each(t,function(e,t){i.api.setProperty("Items."+t+".Id",e.Id)}),this.refreshDropdownItems(),this.ignoreItemsChange=!1),s&&this.updateTabsOrder(),this.toggleTabs(d,r),this.updateDivPosition(this.$currentDiv),!0},h.prototype.onSelectedWidgetChanged=function(e,t){this.selected&&this.selected.$div.removeClass("selected"),t?(t=this.findTabItem(t.id))&&t.widgetItem&&(this.selected=t.widgetItem,this.selected.$div.addClass("selected")):this.selected=null},h.prototype.onSelectingWidget=function(e,t){var i;e&&(_.each(this.tabsItems,function(e){e.widgetItem&&e.widgetItem.widgetId===t&&(i=e.widgetItem)}),i&&this.onAppClick(i,null),this.dashboardAppModel.set("pendingSelectionWidgetId",null,{silent:!0}))},h.prototype.onRemoveTab=function(e){var t=this.$ul.find('a[href="#'+e.Id+'"]').parent(),i=this.$("#"+e.Id),o=this.tabsItems.indexOf(e);this.tabsItems.splice(o,1),t.remove(),e.widgetItem&&e.widgetItem.view&&e.widgetItem.view.remove&&e.widgetItem.view.remove(),i.remove()},h.prototype.onResize=function(e){this.currentTabItem&&this.currentTabItem.widgetItem&&this.currentTabItem.widgetItem.view&&this.currentTabItem.widgetItem.view.onResize&&this.currentTabItem.widgetItem.view.onResize(e),this.$currentDiv&&this.updateDivPosition(this.$currentDiv)},h.prototype.onResizeStart=function(){this.currentTabItem&&this.currentTabItem.widgetItem&&this.currentTabItem.widgetItem.view&&this.currentTabItem.widgetItem.view.onResizeStart&&this.currentTabItem.widgetItem.view.onResizeStart()},h.prototype.onResizeStop=function(){this.currentTabItem&&this.currentTabItem.widgetItem&&this.currentTabItem.widgetItem.view&&this.currentTabItem.widgetItem.view.onResizeStop&&this.currentTabItem.widgetItem.view.onResizeStop()},h.prototype.onSelectionChanged=function(e,t){if(!this.rendered)return!1;var i,o,n;switch(this.isInteger(parseInt(t,10))?i=parseInt(t,10):this.isInteger(parseInt(t.target_tab,10))&&(i=parseInt(t.target_tab,10)),this.isInteger(i)?o=this.viewModel.get("Items")[i]?this.viewModel.get("Items")[i].Id:null:(o=t.target_tab,t=this.$ul.find('a[href="#'+o+'"]').parent(),i=this.$ul.find("li").index(t)),this.$root.tabs("option","active",i),this.$currentDiv=this.$("#"+o),this.currentTabItem=_.find(this.tabsItems,{Id:o}),this.currentTabItem&&this.currentTabItem.widgetItem&&this.currentTabItem.widgetItem.view||(e=this.componentModel.get("components").findWhere({containerId:o}))&&this.addApp(e,this.$currentDiv),this.onResizeStart(),this.onResize(!0),this.onResizeStop(),n=this.viewModel.get("Selection.SetViewStateOnSelect.Value")){case"<tabName>":n=this.currentTabItem.Name;break;case"<tabIndex>":n=i}return _.isUndefined(n)&&(n=""),this.api.setProperty("Selection.SetViewStateOnSelect.ViewState",n),!0},h.prototype.onSettingsChange=function(e){var i=this;_.each(e,function(e,t){i.viewModel.set(t,e)})},h.prototype.onSubComponentChanged=function(e,t){t?this.currentTabItem&&this.currentTabItem.widgetItem.view&&this.currentTabItem.widgetItem.view.model&&t===this.currentTabItem.widgetItem.view.model&&this.$selectionDiv.show():this.$selectionDiv.hide()},h.prototype.onUnloadInactive=function(){var t=this;this.viewModel.get("Selection.unloadInactive")&&this.currentTabItem&&_.each(this.tabsItems,function(e){e&&t.currentTabItem.Id!==e.Id&&e.widgetItem&&(e.widgetItem.view.remove&&e.widgetItem.view.remove(),e.widgetItem=null)})},h.prototype.refreshDropdownItems=function(){var e=this,t=this.viewModel.get("dropdownPossibleValues").slice();t.length=0,_.each(this.tabsItems,function(e){t.push({Id:e.Index,Name:e.Name})}),_.defer(function(){e.api.setProperty("dropdownPossibleValues",t)})},h.prototype.remove=function(){var t=this;return _.each(this.tabsItems,function(e){e.widgetItem&&e.widgetItem.widgetId===t.options.dashboardViewModel.get("selectedWidgetId")&&t.options.dashboardViewModel.set("selectedWidget",null),e.widgetItem&&e.widgetItem.view&&e.widgetItem.view.remove()}),this.stopListening(),this.$el.remove(),this},h.prototype.render=function(){var i=this;return this.$el.addClass("basic-components-tabs"),this.$el.html(r.app()),this.$root=this.$(".tabs-div"),this.$ul=this.$("ul"),this.$selectionDiv=this.$(".selection-div"),this.$selectionDiv.hide(),_.each(this.viewModel.get("Items"),function(e,t){i.addTab(e.Id,e.Name,e,t,e.Tooltip)}),this.$root.tabs({activate:function(e,t){i.api.setProperty("Selection.target_tab",t.newTab.index())}}),this.rendered=!0,this},h.prototype.setTheme=function(e){var t=this,i=e||"Dark";!e&&this.options.dashboardViewModel&&this.options.dashboardViewModel.get("DashboardTheme")&&(i=this.options.dashboardViewModel.get("DashboardTheme")),_.defer(function(){t.$el.removeClass("Dark").removeClass("Light").addClass(i),_.each(t.tabsItems,function(e){e.widgetItem&&e.widgetItem.view&&e.widgetItem.view.app&&_.isFunction(e.widgetItem.view.app.setTheme)&&e.widgetItem.view.app.setTheme(i)})})},h.prototype.toggleTabs=function(e,t){this.$root.tabs("option","disabled",e),t.length?(e=this.$root.tabs("option","active"),t=-1!==t.indexOf(e)?e:t[0],this.$root.show(),this.$root.tabs("option","active",t)):this.$root.hide(),this.$root.tabs("refresh")},h.prototype.updateDivPosition=function(e){this.$el.find(".ui-tabs-nav").is(":visible")?e.css("top",this.$ul.height()):e.css("top",0)},h.prototype.updateTabName=function(e,t){var i=_.find(this.tabsItems,{Id:e});i&&(i.Name=t,this.$ul.find('a[href="#'+e+'"]').text(t))},h.prototype.updateTabTooltip=function(e,t){var i=_.find(this.tabsItems,{Id:e});i&&(i.Tooltip=t,this.$ul.find('a[href="#'+e+'"]').attr("title",this.convertTooltipNewlines(t)))},h.prototype.updateTabsOrder=function(){var t,i,o=this;_.each(_.sortBy(this.tabsItems,function(e){return e.Index}),function(e){t=o.$ul.find('a[href="#'+e.Id+'"]'),(t=t.parent()).detach(),i?i.after(t):t.prependTo(o.$ul),i=t})},h.getComponentDefinition=s.getComponentDefinition,h});