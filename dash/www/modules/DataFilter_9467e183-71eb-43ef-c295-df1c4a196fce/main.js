define(["QuickBase","backbone","Forms","Handlebars","moment","chartjs","d3","css!./css/app.css"],function(o,e,a,t,r,n,d){var s,i=this&&this.__extends||(s=function(t,e){return(s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)},function(t,e){function i(){this.constructor=t}s(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}),l=(h.onItemDataTransform=function(s,o,t,r){var a,n,d;"data"===t?(t=(a=s).data,a.DataSourceMapping||(a.DataSourceMapping={Value:"",Text:""}),a.DropdownPossibleValues||(a.DropdownPossibleValues=[]),n=a.DataSourceMapping.Value instanceof e.Model,d=a.DataSourceMapping.Text instanceof e.Model,t?t.getMeta(function(t){var e=_.fromPairs(_.map(t.columns.collection.models,function(t){return[t.get("id"),t.toJSON()]})),i=_.keys(e),t=_.find(e,function(t){return 0===t.kdbType||11===t.kdbType}),e=a.DropdownPossibleValues;e&&!_.isEqual(e.sort(),i.sort())&&(a.DropdownPossibleValues=i,n||(a.DataSourceMapping.Value=i[0]||""),d||(a.DataSourceMapping.Text=t&&t.id||i[0]||"")),console.log("DFilter transform: ",s,o),r(s,o)}):(a.DropdownPossibleValues=[],n||(a.DataSourceMapping.Value=""),d||(a.DataSourceMapping.Text=""),r(s,o))):r(s,o)},h.getComponentDefinition=function(t){var e,i,s={id:101,componentName:"Data Filter",componentDescription:"Filter data sources.",appKey:"DataFilter",listViewThumb:"fa fa-fw fa-filter",ghostViewThumb:null,buildViewThumb:null,appArgs:{quickStart:[{path:"Basics.data",message:"populate Data Source"}],json:{version:"4.5.1",Basics:{data:"",queryModel:"",kdbString:"",UseViewStates:!1},Bindings:[],Items:[]},schema:{type:"object",title:"Properties",properties:{Basics:{type:"object",title:"Basics",options:{collapsed:!1},properties:{data:{propertyOrder:1001,type:"data",title:"Data Source"},queryModel:{propertyOrder:1002,type:"string",title:"Query Model"},kdbString:{propertyOrder:1003,title:"KDB String",type:"string"},UseViewStates:{type:"boolean",default:!1,options:{hidden:!0}}}},Bindings:{type:"array",format:"table",title:"Bindings",uniqueItems:!0,options:{collapsed:!0},items:{type:"object",properties:{Key:{type:"string"},ViewState:{type:"viewstate"}}}},Items:{title:"Fields",type:"array",format:"object",options:{collapsed:!0,disable_array_add:!0,disable_array_delete:!0,no_additional_properties:!0},items:{id:"arr_item",title:"ViewState",type:"object",headerTemplate:"{{#if self.propertyName}}{{ self.propertyName }}{{else}}Field{{/if}}",_transform:h.onItemDataTransform,options:{hidden:!1,collapsed:!0,keep_oneof_values:!1},properties:{DropdownPossibleValues:{type:"array",items:{type:"string"},default:[],options:{hidden:!0}},propertyName:{type:"string",title:"Property Name",options:{hidden:!0}},data:{type:"data",title:"Data Source"},DataSourceMapping:{type:"object",title:"Data Source Mapping",properties:{Value:{type:"string",enumSource:"possible_values",default:"",watch:{possible_values:"arr_item.DropdownPossibleValues"}},Text:{type:"string",enumSource:"possible_values",default:"",watch:{possible_values:"arr_item.DropdownPossibleValues"}}}},items:{type:"array",format:"table",title:"Items",uniqueItems:!0,options:{collapsed:!1},items:{type:"object",properties:{Value:{type:"string"},Text:{type:"string"}}}}}}}}}}};if(t.settingsModel&&0<_.keys(t.settingsModel.attributes).length)for(i=h.upgrades.indexOf(_.find(h.upgrades,{version:t.settingsModel.get("version")}))+1;i<h.upgrades.length;i+=1)(e=h.upgrades[i]).fn(t.settingsModel),t.settingsModel.set("version",e.version);return s},h.defaults=function(){return h.getComponentDefinition({settingsModel:new e.Model}).appArgs.json},h);function h(){}l.upgrades=[{version:"4.4.0S2",fn:function(t){t.set("Style",{advanced:"",cssClasses:""})}},{version:"4.4.1",fn:function(t){t.get("Bindings")||t.set("Bindings",[])}},{version:"4.5.0",fn:function(t){t.get("Basics.UseViewStates")||t.set("Basics.UseViewStates",!1)}},{version:"4.5.1",fn:function(i){_.each(i.get("Items"),function(t,e){i.unset("Items."+e+".useDataSource")})}}];var p=(u.QueryItem=t.template({1:function(t,e,i,s,o){var r=null!=e?e:t.nullContext||{},a=i.helperMissing,n="function",d=t.escapeExpression;return'<div class="group-toolbar">\r\n\r\n    <div class="radio-group">\r\n        <input type="radio" id="'+d(typeof(t=null!=(t=i.andId||(null!=e?e.andId:e))?t:a)==n?t.call(r,{name:"andId",hash:{},data:o}):t)+'" name="'+d(typeof(t=null!=(t=i.radioName||(null!=e?e.radioName:e))?t:a)==n?t.call(r,{name:"radioName",hash:{},data:o}):t)+'">\r\n        <label for="'+d(typeof(t=null!=(t=i.andId||(null!=e?e.andId:e))?t:a)==n?t.call(r,{name:"andId",hash:{},data:o}):t)+'">AND</label>\r\n        <input type="radio" id="'+d(typeof(t=null!=(t=i.orId||(null!=e?e.orId:e))?t:a)==n?t.call(r,{name:"orId",hash:{},data:o}):t)+'" name="'+d(typeof(t=null!=(t=i.radioName||(null!=e?e.radioName:e))?t:a)==n?t.call(r,{name:"radioName",hash:{},data:o}):t)+'">\r\n        <label for="'+d(typeof(t=null!=(t=i.orId||(null!=e?e.orId:e))?t:a)==n?t.call(r,{name:"orId",hash:{},data:o}):t)+'">OR</label>\r\n    </div>\r\n\r\n    <svg width="10" height="15" xmlns="http://www.w3.org/2000/svg">\r\n\r\n        <g>\r\n            <title>background</title>\r\n            <rect fill="none" id="canvas_background" height="17" width="12" y="-1" x="-1" />\r\n        </g>\r\n        <g>\r\n            <title>Layer 1</title>\r\n            <g id="svg_19">\r\n                <g id="svg_2">\r\n                    <g id="svg_3">\r\n                        <path id="svg_4" d="m2.610779,4.717635c-0.982506,0 -1.791629,-0.809123 -1.791629,-1.791629c0,-0.982506 0.809123,-1.791629 1.791629,-1.791629s1.791629,0.809123 1.791629,1.791629c0,0.982506 -0.809123,1.791629 -1.791629,1.791629z"\r\n                        />\r\n                    </g>\r\n                    <g id="svg_5">\r\n                        <path id="svg_6" d="m7.465516,4.717635c-0.982506,0 -1.791629,-0.809123 -1.791629,-1.791629c0,-0.982506 0.809123,-1.791629 1.791629,-1.791629c0.982506,0 1.791629,0.809123 1.791629,1.791629c0,0.982506 -0.809123,1.791629 -1.791629,1.791629z"\r\n                        />\r\n                    </g>\r\n                </g>\r\n                <g id="svg_10">\r\n                    <path id="svg_11" d="m2.610779,9.341194c-0.982506,0 -1.791629,-0.809123 -1.791629,-1.791629s0.809123,-1.791629 1.791629,-1.791629s1.791629,0.809123 1.791629,1.791629s-0.809123,1.791629 -1.791629,1.791629z"\r\n                    />\r\n                </g>\r\n                <g id="svg_12">\r\n                    <path id="svg_13" d="m7.465516,9.341194c-0.982506,0 -1.791629,-0.809123 -1.791629,-1.791629s0.809123,-1.791629 1.791629,-1.791629c0.982506,0 1.791629,0.809123 1.791629,1.791629s-0.809123,1.791629 -1.791629,1.791629z"\r\n                    />\r\n                </g>\r\n                <g id="svg_14">\r\n                    <g id="svg_15">\r\n                        <path id="svg_16" d="m2.610779,13.964753c-0.982506,0 -1.791629,-0.809123 -1.791629,-1.791629c0,-0.982506 0.809123,-1.791629 1.791629,-1.791629s1.791629,0.809123 1.791629,1.791629c0,0.982506 -0.809123,1.791629 -1.791629,1.791629z"\r\n                        />\r\n                    </g>\r\n                    <g id="svg_17">\r\n                        <path id="svg_18" d="m7.465516,13.964753c-0.982506,0 -1.791629,-0.809123 -1.791629,-1.791629c0,-0.982506 0.809123,-1.791629 1.791629,-1.791629c0.982506,0 1.791629,0.809123 1.791629,1.791629c0,0.982506 -0.809123,1.791629 -1.791629,1.791629z"\r\n                        />\r\n                    </g>\r\n                </g>\r\n            </g>\r\n        </g>\r\n    </svg>\r\n\r\n    <div class="align-right">\r\n        \r\n        <span class="add-rule-button-group">\r\n            <select class="add-rule-menu">\r\n                <option value="normal">Rule</option>\r\n                <option value="histogram">Histogram</option>\r\n            </select>\r\n            <button class="add-rule">Rule</button>\r\n        </span>\r\n\r\n        <button class="add-group">Group</button>\r\n        <button class="delete-group">Delete</button>\r\n    </div>\r\n</div>\r\n'},3:function(t,e,i,s,o){return" group "},5:function(t,e,i,s,o){return" rule "},compiler:[7,">= 4.0.0"],main:function(t,e,i,s,o){var r,a=null!=e?e:t.nullContext||{};return(null!=(r=i.if.call(a,null!=e?e.isGroup:e,{name:"if",hash:{},fn:t.program(1,o,0),inverse:t.noop,data:o}))?r:"")+'\r\n<div class="items-div '+(null!=(r=i.if.call(a,null!=e?e.isGroup:e,{name:"if",hash:{},fn:t.program(3,o,0),inverse:t.program(5,o,0),data:o}))?r:"")+'">\r\n    <div class="branch"></div>\r\n    <div class="drag-div">\r\n        <svg width="10" height="15" xmlns="http://www.w3.org/2000/svg">\r\n\r\n            <g>\r\n                <title>background</title>\r\n                <rect fill="none" id="canvas_background" height="17" width="12" y="-1" x="-1" />\r\n            </g>\r\n            <g>\r\n                <title>Layer 1</title>\r\n                <g id="svg_19">\r\n                    <g id="svg_2">\r\n                        <g id="svg_3">\r\n                            <path id="svg_4" d="m2.610779,4.717635c-0.982506,0 -1.791629,-0.809123 -1.791629,-1.791629c0,-0.982506 0.809123,-1.791629 1.791629,-1.791629s1.791629,0.809123 1.791629,1.791629c0,0.982506 -0.809123,1.791629 -1.791629,1.791629z"\r\n                            />\r\n                        </g>\r\n                        <g id="svg_5">\r\n                            <path id="svg_6" d="m7.465516,4.717635c-0.982506,0 -1.791629,-0.809123 -1.791629,-1.791629c0,-0.982506 0.809123,-1.791629 1.791629,-1.791629c0.982506,0 1.791629,0.809123 1.791629,1.791629c0,0.982506 -0.809123,1.791629 -1.791629,1.791629z"\r\n                            />\r\n                        </g>\r\n                    </g>\r\n                    <g id="svg_10">\r\n                        <path id="svg_11" d="m2.610779,9.341194c-0.982506,0 -1.791629,-0.809123 -1.791629,-1.791629s0.809123,-1.791629 1.791629,-1.791629s1.791629,0.809123 1.791629,1.791629s-0.809123,1.791629 -1.791629,1.791629z"\r\n                        />\r\n                    </g>\r\n                    <g id="svg_12">\r\n                        <path id="svg_13" d="m7.465516,9.341194c-0.982506,0 -1.791629,-0.809123 -1.791629,-1.791629s0.809123,-1.791629 1.791629,-1.791629c0.982506,0 1.791629,0.809123 1.791629,1.791629s-0.809123,1.791629 -1.791629,1.791629z"\r\n                        />\r\n                    </g>\r\n                    <g id="svg_14">\r\n                        <g id="svg_15">\r\n                            <path id="svg_16" d="m2.610779,13.964753c-0.982506,0 -1.791629,-0.809123 -1.791629,-1.791629c0,-0.982506 0.809123,-1.791629 1.791629,-1.791629s1.791629,0.809123 1.791629,1.791629c0,0.982506 -0.809123,1.791629 -1.791629,1.791629z"\r\n                            />\r\n                        </g>\r\n                        <g id="svg_17">\r\n                            <path id="svg_18" d="m7.465516,13.964753c-0.982506,0 -1.791629,-0.809123 -1.791629,-1.791629c0,-0.982506 0.809123,-1.791629 1.791629,-1.791629c0.982506,0 1.791629,0.809123 1.791629,1.791629c0,0.982506 -0.809123,1.791629 -1.791629,1.791629z"\r\n                            />\r\n                        </g>\r\n                    </g>\r\n                </g>\r\n            </g>\r\n        </svg>\r\n    </div>\r\n\r\n    <div class="droppie"></div>\r\n</div>'},useData:!0}),u.app=t.template({compiler:[7,">= 4.0.0"],main:function(t,e,i,s,o){return'<div class="query-builder"></div>'},useData:!0}),u.bindingSelect=t.template({compiler:[7,">= 4.0.0"],main:function(t,e,i,s,o){var r;return'<div class="binding-wrap">\n    <i class="fa fa-fw watermark fa-eye binding-apply"></i>\n\n    <div class="binding-container" style="display:none">\n        <i class="fa fa-fw watermark fa-eye viewstate-icon"></i>\n        <input class="viewstate-display" type="text" tabindex="-1" value="'+t.escapeExpression("function"==typeof(r=null!=(r=i.viewstateDisplay||(null!=e?e.viewstateDisplay:e))?r:i.helperMissing)?r.call(null!=e?e:t.nullContext||{},{name:"viewstateDisplay",hash:{},data:o}):r)+'" readonly />\n        <i class="fa fa-fw watermark fa-eraser binding-clear-dialog"></i>\n        <div class="binding-dropdown">\n            <select class="binding-select"></select>\n        </div>\n    </div>\n</div>'},useData:!0}),u);function u(){}var g,m=(g=e.View,i(c,g),c.prototype.addChild=function(t){var e=new c({model:t,appModel:this.options.appModel});this.$items.append(e.$el),this.items[t.cid]=e},c.prototype.allowBindings=function(){this.$bindings||this.updateValueEditor()},c.prototype.createRuleForm=function(){this.$form=$(document.createElement("div")),this.$form.addClass("the-form"),this.form={},this.form.active=new a.editors.Checkbox({model:this.model,schema:this.model.schema.active,key:"active"}).render(),this.form.active.on("change",$.proxy(this.onFormActiveChanged,this)),this.form.propertyName=new a.editors.Select({model:this.model,schema:this.model.schema.propertyName,key:"propertyName"}).render(),this.form.propertyName.on("change",$.proxy(this.onFormPropertyNameChanged,this)),this.$form.append(this.wrapInDiv(this.form.active.$el,"editor active")),this.$form.append(this.wrapInDiv(this.form.propertyName.$el,"editor property-name type-"+this.model.get("type"))),"histogram"!==this.model.get("type")&&(this.form.operator=new a.editors.Select({model:this.model,schema:this.model.schema.operator,key:"operator"}).render(),this.form.operator.on("change",$.proxy(this.onFormOperatorChanged,this)),this.$form.append(this.wrapInDiv(this.form.operator.$el,"editor operator"))),this.proxiedDragStart=$.proxy(this.dragStart,this),this.proxiedDragEnd=$.proxy(this.dragEnd,this),this.$form[0].addEventListener("dragstart",this.proxiedDragStart),this.$form[0].addEventListener("dragend",this.proxiedDragEnd),"histogram"!==this.model.get("type")&&this.$form.hover(this.displayOptions.bind(this,!0),this.displayOptions.bind(this,!1)),this.updateValueEditor(),this.$items.prepend(this.$form)},c.prototype.displayOptions=function(t){var e;this.$form.find(".value > div").toggleClass("three-options",t&&!this.useBindings),this.$form.find(".value > div").toggleClass("two-options",t&&this.useBindings),this.$form.find(".value-wrap > div").toggleClass("show-options",t),null!==(e=this.$bindingContainer)&&void 0!==e&&e.toggleClass("show-options",t),null!==(e=this.$bindingClear)&&void 0!==e&&e.toggle(t)},c.prototype.dragStart=function(t){this.onDragStart(t)},c.prototype.dragEnd=function(t){this.$el.removeClass("draggie"),this.options.appModel.trigger("drag-finished")},c.prototype.getValueIndex=function(i){var s=0,t=new Number(i).valueOf();return isNaN(t)?_.isString(i)&&(i=r(i).valueOf()):i=t,t===this.maxValue?(this.pickMaxValue=!0,s=this.chartData.length-1):_.find(this.chartData,function(t,e){return!(i>=t.x)||(s=e,!1)}),s},c.prototype.histogramDragMouseDown=function(t){t.stopPropagation(),t.preventDefault();var e=$(t.target);this.histogramIsDragging=!0,this.$histogramDragHandle=e.hasClass("grabber")?e.parent():e,this.leftHandleWidth=this.$histogramHandleL.width(),this.$histogramHandleL.css("pointer-events","none"),this.$histogramHandleR.css("pointer-events","none"),this.$histogramDragMiddle.css("pointer-events","none"),this.dragDelta=t.offsetX,this.histogramDragMiddleWidth=this.$histogramDragMiddle.width(),this.middleRightLimit=this.chart.width-(this.histogramDragMiddleWidth+1),this.isDraggingLeft=this.$histogramDragHandle[0]===this.$histogramHandleL[0],this.leftLimit=this.isDraggingLeft?0:parseInt(this.$histogramHandleL.css("left"))+this.leftHandleWidth,this.rightLimit=this.isDraggingLeft?parseInt(this.$histogramHandleR.css("left"))-this.leftHandleWidth:this.chart.width-2},c.prototype.histogramDragMouseMove=function(t){var e,i;this.histogramIsDragging&&(this.$histogramDragHandle[0]===this.$histogramDragMiddle[0]?((e=t.offsetX-this.dragDelta)<=0?(e=0,this.pickMaxValue=!1):e>=this.middleRightLimit?(e=this.middleRightLimit,this.pickMaxValue=!0):this.pickMaxValue=!1,i=e+this.histogramDragMiddleWidth,this.$histogramDragMiddle.css({left:e,right:this.chart.width-i}),this.$histogramHandleL.css("left",e),this.$histogramHandleR.css("left",i),this.$histogramGreyoutL.css("right",this.chart.width-(e+4)),this.$histogramGreyoutR.css("left",i)):(t.offsetX<=this.leftLimit?(e=this.leftLimit,this.pickMaxValue=this.pickMaxValue&&this.isDraggingLeft):t.offsetX>=this.rightLimit?(e=this.rightLimit,this.pickMaxValue=!this.isDraggingLeft):(e=t.offsetX,this.pickMaxValue=this.pickMaxValue&&this.isDraggingLeft),this.$histogramDragHandle.css("left",e),this.isDraggingLeft?(this.$histogramGreyoutL.css("right",this.chart.width-(e+4)),this.$histogramDragMiddle.css("left",e)):(this.$histogramGreyoutR.css("left",e),this.$histogramDragMiddle.css("right",this.chart.width-e))),this.updateSelectedIndex(e,this.$histogramDragHandle,i))},c.prototype.histogramDragMouseUp=function(){this.histogramIsDragging=!1,this.pointerId&&(this.$chartCanvas[0].releasePointerCapture(this.pointerId),this.pointerId=null),this.$histogramHandleL.css("pointer-events","auto"),this.$histogramHandleR.css("pointer-events","auto"),this.$histogramDragMiddle.css("pointer-events","auto"),this.$histogramDragHandle=null},c.prototype.hitTest=function(t,e){var i=this.$el,s={};if(i){var o=i.offset();if(s.top=o.top,s.left=o.left,s.right=o.left+i.outerWidth(),s.bottom=o.top+i.outerHeight(),t>=s.left)if(t<=s.right)if(e>=s.top)if(e<=s.bottom)return{test:!0,top:e<s.top+i.outerHeight()/2}}return{test:!1}},c.prototype.initGroup=function(){var e=this;this.$el.addClass("group"),this.$el.attr("data-id",this.id),this.options.isRoot&&this.$el.addClass("rootGroup"),this.proxiedDragOver=$.proxy(this.onDragOver,this),this.$items[0].addEventListener("dragover",this.proxiedDragOver),this.proxiedDrop=$.proxy(this.onDrop,this),this.$items[0].addEventListener("drop",this.proxiedDrop),this.proxiedDragLeave=$.proxy(this.onDragLeave,this),this.$items[0].addEventListener("dragleave",this.proxiedDragLeave),this.initGroupRadio(),this.initGroupToolbar(),this.listenTo(this.model.get("children"),"add",this.onItemAdded),this.listenTo(this.model.get("children"),"remove",this.onItemRemoved),this.model.get("children").each(function(t){e.addChild(t)}),this.listenTo(this.options.appModel,"drag-started",this.onDragStarted),this.listenTo(this.options.appModel,"drag-finished",this.onDragFinished),this.proxiedDragStart=$.proxy(this.dragStart,this),this.proxiedDragEnd=$.proxy(this.dragEnd,this),this.$el[0].addEventListener("dragstart",this.proxiedDragStart),this.$el[0].addEventListener("dragend",this.proxiedDragEnd)},c.prototype.initGroupRadio=function(){this.$and=this.$el.find("#"+this.renderModel.andId),this.$or=this.$el.find("#"+this.renderModel.orId),"AND"===this.model.get("operator")?this.$and.prop("checked",!0):"OR"===this.model.get("operator")&&this.$or.attr("checked","checked"),this.$radioGroup.buttonset(),this.$radioGroup.on("change",$.proxy(this.onRadioChanged,this))},c.prototype.initGroupToolbar=function(){var i=this,t=this;this.$toolbar=this.$el.find(".group-toolbar"),this.$addRuleBtn=this.$el.find(".add-rule"),this.$addRuleBtn.button({icons:{primary:"fa fa-plus"}}).click($.proxy(this.onAddRule,this)),this.$addRuleMenu=this.$el.find(".add-rule-menu"),this.$addRuleMenu.select2({theme:"dashboards",width:"71px",minimumResultsForSearch:1/0}),this.$addRuleMenu.val(null).trigger("change"),this.$addRuleMenu.on("select2:select",function(t){var e=i.$addRuleMenu.val();e&&(i.onAddRuleMenu(e),i.$addRuleMenu.val(null).trigger("change"))}),this.$addGroupBtn=this.$el.find(".add-group"),this.$addGroupBtn.button({icons:{primary:"fa fa-plus"}}).click(function(){i.model.get("children").add(new T({appModel:t.options.appModel}))}),this.$deleteGroupRuleBtn=this.$el.find(".delete-group"),this.$deleteGroupRuleBtn.button({icons:{primary:"fa fa-times"}}).click(function(){return i.model.destroy()}),this.$toolbar[0].addEventListener("drop",this.proxiedDrop),this.$toolbar[0].addEventListener("dragover",this.proxiedDragOver),this.$toolbar[0].addEventListener("dragleave",this.proxiedDragLeave)},c.prototype.initRule=function(){var t,e=this;this.$el.addClass("rule"),this.createRuleForm(),(t=$(document.createElement("button"))).addClass("delete-row"),t.text("Delete"),this.$form.append(t),t.button({icons:{primary:"fa fa-trash"},text:!1}).click(function(){return e.model.destroy()}),"histogram"!==this.model.get("type")&&(this.$compareFields=$(document.createElement("button")),this.$compareFields.addClass("compare-fields"),this.$compareFields.text("Compare fields"),this.$compareFields.toggle(!this.useBindings),this.$form.append(this.$compareFields),this.setCompareBtnProps(this.model.get("compareFields")),this.$compareFields.button().click(function(){return e.onCompareFieldsClick(!e.model.get("compareFields"))})),this.listenTo(this.options.appModel.get("data.items"),"add remove",this.onFieldsCountChanged),this.listenTo(this.options.appModel.get("data.items"),"change",this.onFieldsItemChanged),this.listenTo(this.model,"change:propertyName",this.onModelPropertyNameChanged),this.listenTo(this.model,"change:operator",this.onModelOperatorChanged),this.listenTo(this.model,"change:value",this.onModelValueChanged),"histogram"===this.model.get("type")&&this.listenTo(this.model,"change:value2",this.onModelValueChanged)},c.prototype.onAddRule=function(t){this.model.get("children").add(new E({appModel:this.options.appModel}))},c.prototype.onAddRuleMenu=function(t){this.model.get("children").add(new E({appModel:this.options.appModel,type:t}))},c.prototype.onDragLeave=function(t){_.forEach(this.items,function(t){t.$el.removeClass("drag-over")}),this.$el.find("> .items-div.group > .droppie").hide()},c.prototype.onDragOver=function(s){var o=this;return this.draggie.queryItem.id===this.id||(($(s.currentTarget).hasClass("group-toolbar")?this.$el.find("> .items-div.group > .droppie").show():_.forEach(this.items,function(t){var e,i;t.$form&&(e=t.hitTest(s.pageX,s.pageY),t.$el.removeClass("drag-over-top"),t.$el.removeClass("drag-over-bottom"),e.test&&(i=void 0,i=e.top?(t.$el.addClass("drag-over-top"),"top"):(t.$el.addClass("drag-over-bottom"),"bottom"),o.draggie&&(o.draggie.lastHitTest={item:t,side:i})))}),!s.preventDefault)||(s.preventDefault(),!1))},c.prototype.onDragStart=function(t){t.dataTransfer.setData("text","kx dashboards"),this.options.appModel.trigger("drag-started",this),this.$el.addClass("draggie"),t.stopPropagation()},c.prototype.onDragStarted=function(t){this.draggie={queryItem:t}},c.prototype.onDragFinished=function(){this.draggie=null,$(".drag-over-top").removeClass("drag-over-top"),$(".drag-over-bottom").removeClass("drag-over-bottom"),this.$el.find("[draggable]").prop("draggable",!1)},c.prototype.onDrop=function(t){if(this.draggie.queryItem.id===this.id)return!0;var e=-1,i=-1,s=!1;!$(t.currentTarget).hasClass("group-toolbar")&&this.draggie.lastHitTest&&this.draggie.lastHitTest.item?(this.draggie.queryItem.model.collection===this.draggie.lastHitTest.item.model.collection&&(s=this.draggie.queryItem.renderModel.isGroup&&!0,e=this.draggie.queryItem.model.collection.indexOf(this.draggie.queryItem.model)),i=this.model.get("children").indexOf(this.draggie.lastHitTest.item.model),"bottom"===this.draggie.lastHitTest.side?!(i<e)&&s||(i+=1):"top"===this.draggie.lastHitTest.side&&s&&i-1===e&&--i):i=this.model.get("children").length;e=this.draggie.queryItem.model.toJSON();this.draggie.queryItem.model.destroy();e=_.extend({appModel:this.options.appModel},e),e=new(this.draggie.queryItem.renderModel.isGroup?T:E)(e);return this.model.get("children").add(e,{at:i}),this.renderModel.isGroup&&_.each(this.items,function(t){t.removeEventHandlers()}),this.removeEventHandlers(),this.render(),this.options.appModel.trigger("drag-finished"),!1},c.prototype.onEmptyChanged=function(){!this.model.get("children")||0<_.keys(this.items).length?this.$items.removeClass("empty"):this.$items.addClass("empty")},c.prototype.onFieldsCountChanged=function(){this.model.setSchema(),this.updateValueEditor()},c.prototype.onFieldsItemChanged=function(e,t,i){var s,o,r;this.form.propertyName&&(r=this.model,e.get("propertyName")===r.get("propertyName")&&(!(s=JSON.parse(r.get("appModel").get("Basics").queryModel))||(o=_.find(s.children,function(t){return t.propertyName===e.get("propertyName")}))&&r.set(o)),o=void 0,r.setSchema(),r=this.form.propertyName.$el.parent(),this.form.propertyName.off(),this.form.propertyName.remove(),o=r.parent().find(".active"),r.remove(),this.form.propertyName=new a.editors.Select({model:this.model,schema:this.model.schema.propertyName,key:"propertyName"}).render(),this.form.propertyName.on("change",$.proxy(this.onFormPropertyNameChanged,this)),o.after(this.wrapInDiv(this.form.propertyName.$el,"editor property-name type-"+this.model.get("type")))),this.updateValueEditor()},c.prototype.onItemAdded=function(t,e,i){this.addChild(t),this.onEmptyChanged()},c.prototype.onItemRemoved=function(t,e,i){var s=this.items[t.cid];delete this.items[t.cid],s&&s.remove(!0),this.onEmptyChanged()},c.prototype.onFormActiveChanged=function(t,e){this.model.set({active:t.getValue()})},c.prototype.onFormPropertyNameChanged=function(t,e){var i=t.getValue(),s=this.options.appModel.get("data.meta.columns").get(i);s?(t={propertyName:s.get("id"),propertyType:s.get("kdbType")},s.get("kdbType")!==this.model.get("propertyType")&&(i=s.get("kdbType"),s=this.model.get("propertyType"),s=this.model.get("compareFields")&&4<=i&&i<=9&&4<=s&&s<=9,t=_.extend(t,{operator:"histogram"===this.model.get("type")?null:"equal",value:1!==i&&(s?this.model.get("value"):null),value2:null}),this.leftIndex=void 0,this.rightIndex=void 0),this.model.set(t)):this.model.set({propertyName:null,propertyType:null,operator:"histogram"===this.model.get("type")?null:"equal",value:null,value2:null})},c.prototype.onFormOperatorChanged=function(t,e){this.model.set({operator:t.getValue()}),null!==(t=this.$compareFields)&&void 0!==t&&t.toggle(!_.includes(["is_blank","is_not_blank"],this.model.get("operator"))&&!this.useBindings)},c.prototype.onFormValueChanged=function(){!this.useBindings&&(this.form.value.validate()||"histogram"===this.model.get("type")&&this.model.validate(this.form.value.getValue(),this.model.get("value2")))?this.form.value.setValue(this.model.get("value")):"histogram"===this.model.get("type")?(this.form.value.momentFormat?this.model.set("value",r(this.form.value.getValue()).valueOf()):this.model.set({value:this.form.value.getValue()}),this.leftIndex=this.getValueIndex(this.model.get("value")),this.updateHandlesPosition()):this.model.set({value:this.useBindings?"<%"+(this.$bindingSelect.val()||this.$viewstateDisplay.val())+"%>":this.form.value.getValue()})},c.prototype.onFormValue2Changed=function(){this.form.value2.validate()||"histogram"===this.model.get("type")&&this.model.validate(this.model.get("value"),this.form.value2.getValue())?this.form.value2.setValue(this.model.get("value2")):(this.form.value2.momentFormat?this.model.set("value2",r(this.form.value2.getValue()).valueOf()):this.model.set({value2:this.form.value2.getValue()}),this.rightIndex=this.getValueIndex(this.model.get("value2")),this.updateHandlesPosition())},c.prototype.onModelOperatorChanged=function(t,e,i){this.model.setSchema(),this.updateValueEditor()},c.prototype.onModelPropertyNameChanged=function(t,e,i){var s=this.model;s.setSchema(),this.form.operator&&this.form.operator.setOptions(s.schema.operator.options),"histogram"===this.model.get("type")&&(this.leftIndex=void 0,this.rightIndex=void 0,this.model.set({value:null,value2:null})),"histogram"!==this.model.get("type")&&this.model.get("compareFields")?this.onCompareFieldsClick(!0):this.updateValueEditor()},c.prototype.onModelValueChanged=function(t,e,i){this.model.trigger("change")},c.prototype.onResizeStart=function(){this.chart&&(this.$histogramHandleL.hide(),this.$histogramHandleR.hide())},c.prototype.onResize=function(){this.chart&&(this.chart.resize(),this.updateHandlesPosition())},c.prototype.onResizeStop=function(){this.chart&&(this.chart.resize(),this.$histogramHandleL.show(),this.$histogramHandleR.show(),this.updateHandlesPosition())},c.prototype.onRadioChanged=function(){!0===this.$and.is(":checked")?this.model.set("operator","AND"):!0===this.$or.is(":checked")&&this.model.set("operator","OR")},c.prototype.onSelectViewState=function(t){this.$viewstateDisplay.val(t),this.toggleBindings(!1);t=this.model.get("value");t&&(!t||t.match(c.VSRx))||(this.previousValue=t),this.onFormValueChanged()},c.prototype.render=function(){return this.renderModel={radioName:_.uniqueId("_andor"),andId:_.uniqueId("_and"),orId:_.uniqueId("_or"),isGroup:!!this.model.get("children")},this.$el.html(p.QueryItem(this.renderModel)),this.$items=this.$el.find(".items-div"),this.$radioGroup=this.$el.find(".radio-group"),this.$el.addClass("query-item"),this.model.get("children")?(this.initGroup(),this.$el.mousedown(function(t){t=$(t.target);t.hasClass("group-toolbar")&&!t.parent().hasClass("rootGroup")&&t.prop("draggable",!0)})):(this.initRule(),this.$el.mousedown(function(t){t=$(t.target);t.hasClass("the-form")&&t.prop("draggable",!0)})),this},c.prototype.remove=function(){return this.renderModel.isGroup&&_.each(this.items,function(t){t.remove()}),this.removeEventHandlers(),this.$el.remove(),this},c.prototype.removeEventHandlers=function(){var t;this.stopListening(),this.$form?(this.$form[0].removeEventListener("dragstart",this.proxiedDragStart),this.$form[0].removeEventListener("dragend",this.proxiedDragEnd)):this.model.get("children")&&(this.$radioGroup.off(),this.$addRuleBtn.button("destroy"),this.$addGroupBtn.button("destroy"),this.$deleteGroupRuleBtn.button("destroy"),this.$items[0].removeEventListener("dragover",this.proxiedDragOver),this.$items[0].removeEventListener("drop",this.proxiedDrop),this.$items[0].removeEventListener("dragleave",this.proxiedDragLeave),this.$toolbar[0].removeEventListener("drop",this.proxiedDrop),this.$toolbar[0].removeEventListener("dragleave",this.proxiedDragLeave),this.$el[0].removeEventListener("dragstart",this.proxiedDragStart),this.$el[0].removeEventListener("dragend",this.proxiedDragEnd)),this.$items.off(),this.$el.off(),null!==(t=this.$compareFields)&&void 0!==t&&t.off()},c.prototype.setCompareBtnProps=function(t){this.$compareFields.button({icons:{primary:t?"fa fa-pencil":"fa fa-columns"},text:!1}),this.$compareFields.prop("title",t?"Untoggle compare fields":"Compare fields")},c.prototype.updateChart=function(){var e=this,t=this.model.get("propertyType"),i=_.includes([12,13,14,15,16,17,18,19],t),s=_.includes([8,9],t);this.$chartCanvas=$(document.createElement("canvas")),this.form.propertyName.$el.parent().after(this.wrapInDiv(this.wrapInDiv(this.$chartCanvas,"inner-wrap"),"editor histogram"));t=this.options.appModel.get("dataCollection").map(function(t){return i?o.Tools.convertKDBTemporalToMoment(t.get(e.model.get("propertyName"))).valueOf():t.get(e.model.get("propertyName"))});this.maxValue=_.max(t),this.chartData=_.map(d.layout.histogram().bins(51).range([_.min(t),this.maxValue])(t),function(t,e){return{x:i?Math.round(t.x):s?t.x.toFixed(6):t.x,y:t.y}});t={type:"linear",display:!1,minBarLength:2,ticks:{max:_.maxBy(this.chartData,"y").y}};this.chart=new n(this.$chartCanvas[0].getContext("2d"),{type:"bar",data:{datasets:[{data:_.map(this.chartData,function(t,e){return{x:e+"",y:t.y}}),backgroundColor:"#0071cd"}]},options:{responsive:!1,maintainAspectRatio:!1,legend:{display:!1},scales:{yAxes:[t],xAxes:[{type:"linear",display:!1}]},tooltips:{enabled:!1}},plugins:[{afterDatasetsDraw:function(s,t){var e=s.getDatasetMeta(0),o=s.config.data.datasets[0].data;e.data.forEach(function(t,e){var i;0===o[e].y&&(i=t._view,e=s.chart.ctx,t=i.x-i.width/2,e.clearRect(t-1,i.y,i.width+2,2))})}}]}),this.$histogramGreyoutL=$(document.createElement("div")),this.$histogramGreyoutR=$(document.createElement("div")),this.$histogramGreyoutL.addClass("greyout left"),this.$histogramGreyoutR.addClass("greyout right"),this.$chartCanvas.parent().append(this.$histogramGreyoutL),this.$chartCanvas.parent().append(this.$histogramGreyoutR),this.$histogramDragMiddle=$(document.createElement("div")),this.$histogramDragMiddle.addClass("drag-middle"),this.$chartCanvas.parent().append(this.$histogramDragMiddle),this.$histogramDragMiddle.mousedown($.proxy(this.histogramDragMouseDown,this)),this.$histogramHandleL=$(document.createElement("div"));t=$(document.createElement("div"));t.addClass("grabber"),this.$histogramHandleL.append(t),this.$histogramHandleR=$(document.createElement("div")),(t=$(document.createElement("div"))).addClass("grabber"),this.$histogramHandleR.append(t),this.$histogramHandleL.addClass("left-handle"),this.$histogramHandleR.addClass("right-handle"),this.$chartCanvas.parent().append(this.$histogramHandleL),this.$chartCanvas.parent().append(this.$histogramHandleR),this.$histogramHandleL.mousedown($.proxy(this.histogramDragMouseDown,this)),this.$histogramHandleR.mousedown($.proxy(this.histogramDragMouseDown,this)),this.$chartCanvas.mousemove($.proxy(this.histogramDragMouseMove,this)),this.$chartCanvas[0].onpointermove=function(t){e.histogramIsDragging&&!e.pointerId&&(e.$chartCanvas[0].setPointerCapture(t.pointerId),e.pointerId=t.pointerId)},this.$chartCanvas.mouseup($.proxy(this.histogramDragMouseUp,this)),_.isUndefined(this.leftIndex)&&(this.model.get("value")?this.leftIndex=this.getValueIndex(this.model.get("value")):this.leftIndex=0),_.isUndefined(this.rightIndex)&&(this.model.get("value2")?this.rightIndex=this.getValueIndex(this.model.get("value2")):this.rightIndex=this.chartData.length-1),this.updateSelectedValue(),this.updateHandlesPosition(),this.onResize()},c.prototype.updateHandlesPosition=function(){var t,e,i,s;this.chart&&(t=this.chart.width,e=this.chartData.length,i=this.leftIndex*(s=t/e)+1,this.$histogramHandleL.css("left",i),this.$histogramGreyoutL.css("right",this.chart.width-(4+i)),s=this.rightIndex===e-1?t:this.rightIndex*s,s-=this.$histogramHandleR.width(),this.$histogramHandleR.css("left",s=1+s),this.$histogramGreyoutR.css("left",s),this.$histogramDragMiddle.css({left:i,right:t-(4+s)}))},c.prototype.updateSelectedIndex=function(t,e,i){void 0===i&&(i=null);var s=this.chart.width,o=this.chartData.length,r=s/o,t=t<=0?0:s<=t?o=-1:Math.round(t/r);e[0]===this.$histogramHandleL[0]?this.leftIndex=t:e[0]===this.$histogramHandleR[0]?this.rightIndex=t:e[0]===this.$histogramDragMiddle[0]&&(this.leftIndex=t,t=i<=0?0:s<=i?o=-1:Math.round(i/r),this.rightIndex=t),this.rightIndex>o-1&&(this.rightIndex=o-1),this.leftIndex<0&&(this.leftIndex=0),this.rightIndex>o-1&&(this.rightIndex=o-1),this.rightIndex<0&&(this.rightIndex=0),this.leftIndex>o-1&&(this.leftIndex=o-1),this.leftIndex<0&&(this.leftIndex=0),this.updateSelectedValue()},c.prototype.updateSelectedValue=function(){var t=this.chartData,e=new Number(t[this.rightIndex].x).valueOf();this.pickMaxValue&&(e=this.maxValue),this.model.set({value:t[this.leftIndex].x,value2:e})},c.prototype.updateValueEditor=function(){"histogram"===this.model.get("type")?this.updateValueEditorHistogram():this.updateValueEditorNormal()},c.prototype.updateValueEditorHistogram=function(){var t,e=this.model;this.form.info&&(this.form.info.parent().parent().remove(),delete this.form.info),this.chart&&(this.$chartCanvas.off(),this.$histogramHandleL.off(),this.$histogramHandleR.off(),this.chart.destroy(),this.chart=null,this.$chartCanvas.parent().parent().remove(),delete this.form.chart),this.form.value2&&(t=this.form.value2.$el.parent().parent().parent(),this.form.value.off(),this.form.value.remove(),this.form.value2.off(),this.form.value2.remove(),t.parent().find(".value").remove(),t.remove()),this.model.get("propertyName")?this.debouncedUpdateChart():((t=$(document.createElement("span"))).addClass("field-info"),t.text("please select field"),this.form.info=t,this.form.propertyName.$el.parent().after(this.wrapInDiv(this.wrapInDiv(t,"inner-wrap"),"editor histogram-info"))),this.form.value=new a.editors[e.schema.value.type]({model:e,schema:e.schema.value,key:"value",id:"picker_"+_.uniqueId()}).render(),this.form.value2=new a.editors[e.schema.value.type]({model:e,schema:e.schema.value,key:"value2",id:"picker_"+_.uniqueId()}).render(),"Number"===e.schema.value.type?(this.form.value.$el.on("input",_.debounce($.proxy(this.onFormValueChanged,this),500)),this.form.value2.$el.on("input",_.debounce($.proxy(this.onFormValue2Changed,this),500))):(this.form.value.$el.on("change",_.debounce($.proxy(this.onFormValueChanged,this),500)),this.form.value2.$el.on("change",_.debounce($.proxy(this.onFormValue2Changed,this),500)));e=$(document.createElement("div"));e.append(this.form.value.$el),e.append(this.form.value2.$el),this.form.propertyName.$el.parent().after(this.wrapInDiv(this.wrapInDiv(e,"inner-wrap"),"editor value2 type-histogram"+(this.model.get("propertyName")?"":" disabled"))),this.form.propertyName.$el.parent().after(this.wrapInDiv(this.wrapInDiv($("<div class='empty-div type-histogram'></div>"),"inner-wrap"),"editor value type-histogram place-hiolder"))},c.prototype.updateValueEditorNormal=function(){var t,s,o=this,e=this.model,i="";this.form.value&&(t=this.form.value.$el.parent().parent(),this.form.value.off(),this.form.value.remove(),this.toggleCompareFields(!0),(0<t.find(".value-wrap").length?t.parent():t).remove()),"is_blank"!==this.model.get("operator")&&"is_not_blank"!==this.model.get("operator")?(_.isString(e.get("value"))&&e.get("value").match(c.VSRx)&&(i=e.get("value"),e.set("value","")),"Number"===e.schema.value.type?this.form.value=new a.editors.Text({model:e,schema:{type:"Text",validators:["number"]},key:"value",id:"picker_"+_.uniqueId()}).render():(s=e.get("compareFields")?this.options.appModel.get("data.meta.columns"):null,this.form.value=new a.editors[e.get("compareFields")?"Select":e.schema.value.type]({model:e,schema:e.get("compareFields")?_.mapValues(e.schema.propertyName,function(t,e){return"options"!==e?t:_.filter(t,function(t){var e=o.model.get("propertyType"),i=s.get(t.val).get("kdbType");return 4<=e&&e<=9&&4<=i&&i<=9||o.model.get("propertyType")===s.get(t.val).get("kdbType")})}):e.schema.value,key:"value",id:"picker_"+_.uniqueId()}).render()),this.form.value.$el.attr("data-name",e.get("propertyName")),"Text"===e.schema.value.type||"Number"===e.schema.value.type?(this.form.value.$el.attr("type","search"),this.form.value.$el.on("input",_.debounce($.proxy(this.onFormValueChanged,this),500)),this.form.value.on("changeList",this.onFormValueChanged)):(this.form.value.on("change changeList",$.proxy(this.onFormValueChanged,this)),this.onFormValueChanged())):(this.model.set("value",null),this.form.value={$el:$("<div class='empty-div'></div>"),off:function(){},remove:function(){this.$el.remove()}}),this.$bindings=null,!this.form.value.$el.hasClass("empty-div")&&(0<this.options.appModel.get("settingsModel").get("Bindings").length||this.options.appModel.get("settingsModel").get("Basics.UseViewStates"))&&(this.$bindings=$(p.bindingSelect({})),this.$bindingApply=this.$bindings.find(".binding-apply"),this.$bindingClear=this.$bindings.find(".binding-clear-dialog"),this.$bindingContainer=this.$bindings.find(".binding-container"),this.$bindingSelect=this.$bindings.find(".binding-select"),this.$viewstateDisplay=this.$bindings.find(".viewstate-display"),this.$viewstateIcon=this.$bindings.find(".viewstate-icon"),this.$bindingApply.click(this.showBindingsDropdown.bind(this)),this.$bindingClear.click(this.onBindingsClear.bind(this)),this.options.appModel.get("settingsModel").get("Basics.UseViewStates")?(this.$bindings.find(".binding-dropdown").hide(),this.$viewstateDisplay.click(this.showBindingsDropdown.bind(this))):(this.$viewstateIcon.hide(),this.$viewstateDisplay.hide(),this.$bindingSelect.on("select2:select",$.proxy(this.onFormValueChanged,this)))),this.$bindings&&this.form.value.$el.addClass("bindings-available");e=this.$bindings?(this.form.value.$el.is("div, select")?this.wrapInDiv(this.form.value.$el,"value-wrap"):this.form.value.$el).add(this.$bindings):this.form.value.$el;this.form.operator.$el.parent().after(this.wrapInDiv(this.wrapInDiv(e,"inner-wrap"),"editor value")),this.$bindingApply&&this.model.get("compareFields")?this.$bindingApply.hide():(i||this.useBindings)&&this.showBindingsDropdown(null,this.removeVSChars(i))},c.prototype.getBindings=function(){var e=this.form.value.model.get("propertyType");return null!==e?_.map(_.filter(this.options.appModel.get("settingsModel").get("Bindings"),function(t){return t.ViewState&&(t.ViewState.get("_type")===a.RTTI.getByQTypeNum(e).name||"string"===t.ViewState.get("_type")&&0===e)}),function(t){return t.Key}):[]},c.prototype.toggleBindings=function(t){var e=this.options.appModel.get("settingsModel").get("Basics.UseViewStates");(this.options.appModel.get("settingsModel").get("Bindings").length||e)&&((this.form.value.$el.parent().hasClass("value-wrap")?this.form.value.$el.parent():this.form.value.$el).toggle(t),this.form.value.$el.toggle(t),this.$bindingApply.toggle(t),this.$bindingContainer.toggle(!t),this.toggleCompareFields(t),this.useBindings=!t,e&&this.$bindingContainer.toggleClass("useViewState",!t))},c.prototype.onBindingsClear=function(){this.model.set("value",this.previousValue),this.toggleBindings(!0),this.displayOptions(!0)},c.prototype.showBindingsDropdown=function(t,e){var i;this.options.appModel.get("settingsModel").get("Basics.UseViewStates")?_.isNil(e)?this.options.appModel.get("api").renderViewStateDialog({path:this.removeVSChars((this.form.model||this.form.value.model).get("value")),selectCallback:this.onSelectViewState.bind(this)}):this.onSelectViewState(e):(this.toggleBindings(!1),this.previousValue=this.model.get("value"),i=this.getBindings(),this.$bindingSelect.select2({data:i,multiple:!1,theme:"dashboards",width:"100%",language:{noResults:function(){return"No matching bindings"}}}),this.$bindingSelect.val(e||""),this.$bindingSelect.trigger("change"),this.$bindingSelect.trigger("select2:select")),this.displayOptions(!0)},c.prototype.onCompareFieldsClick=function(t){var e=this.model;e.set("compareFields",t),e.setSchema(),t||e.set("value",null);var i=this.form.operator;i&&(i.setOptions(e.schema.operator.options),i.setValue(_.includes(e.schema.operator.options.map(function(t){return t.val}),i.getValue())?i.getValue():"equal"),e.set("operator",i.getValue())),this.toggleBindings(!0),this.updateValueEditor(),this.setCompareBtnProps(t),this.toggleCompareFields(!0)},c.prototype.toggleCompareFields=function(t){var e;null!==(e=this.$compareFields)&&void 0!==e&&e.toggle(t)},c.prototype.removeVSChars=function(t){return _.isString(t)?t.replace(c.VSRx,function(t){return t.substring(2,t.length-2)}):t},c.prototype.wrapInDiv=function(t,e){var i=$(document.createElement("div"));return e&&i.addClass(e),i.append(t),i},c.VSRx=/^<%[^<>%]*%>$/i,c);function c(t){var e=g.call(this,t)||this;return e.id=_.uniqueId("qi_"),e.items={},e.chart=null,e.proxiedDragStart=null,e.proxiedDragEnd=null,e.proxiedDragOver=null,e.proxiedDrop=null,e.proxiedDragLeave=null,e.pickMaxValue=!1,e.useBindings=!1,e.options=t,e.debouncedUpdateChart=_.debounce($.proxy(e.updateChart,e),500),e.render(),e.onEmptyChanged(),e}var v;v=e.Model,i(f,v),f.prototype.defaults=function(){return{id:null,index:null,kdbType:null,type:null}};function f(t){t=v.call(this,t)||this;t.idAttribute="id";return t}var y,D=(y=e.Collection,i(b,y),b);function b(t){t=y.call(this,t)||this;return t.comparator="id",t}var w,M=(w=e.Model,i(x,w),Object.defineProperty(x.prototype,"idAttribute",{get:function(){return"propertyName"},enumerable:!1,configurable:!0}),x.prototype.defaults=function(){return{propertyName:null,data:"",items:[]}},x.prototype.initializeEvents=function(){this.listenTo(this,"change:data",this.onDataChanged)},x.prototype.onDataChanged=function(){this.currentDataSource&&(this.currentDataSource.unsubscribe(this.subscriptionId),this.currentDataSource=void 0),this.unset("result");var t=_.findIndex(x.options.api.getProperty("Items"),{propertyName:this.get("propertyName")});-1!=t&&(x.options.api.setProperty("Items."+t+".DropdownPossibleValues",[],{silent:!0}),x.options.api.setProperty("Items."+t+".DataSourceMapping.Value","",{silent:!0}),x.options.api.setProperty("Items."+t+".DataSourceMapping.Text","",{silent:!0})),this.get("data")&&(this.currentDataSource=this.get("data"),this.currentDataSource.subscribe(this.subscriptionId,this))},x.prototype.onData=function(t,e,i){var s=this;t&&t.columns&&t.columns.reset&&(s.set("result",{meta:t,data:e,options:i}),-1!=(i=_.findIndex(x.options.api.getProperty("Items"),{propertyName:s.get("propertyName")}))&&(x.options.api.setProperty("Items."+i+".DropdownPossibleValues",_.flatMap(t.columns.reset,"id")),x.options.api.setProperty("Items."+i+".DataSourceMapping.Value",s.get("DataSourceMapping.Value")||s.get("propertyName")),x.options.api.setProperty("Items."+i+".DataSourceMapping.Text",s.get("DataSourceMapping.Text")||s.get("propertyName"))))},x.prototype.onRemoved=function(){this.currentDataSource&&(this.currentDataSource.unsubscribe(this.subscriptionId),this.currentDataSource=void 0)},x);function x(t){t=w.call(this,t)||this;return t.subscriptionId=_.uniqueId("DataFilterItem"),t.initializeEvents(),t.onDataChanged(),t}var C,I=(C=e.Collection,i(S,C),S);function S(t){t=C.call(this,t)||this;return t.model=M,t}var V,N=(V=e.DeepModel,i(R,V),R.prototype.defaults=function(){return{"data.meta.columns":new D,"data.items":new I}},R.prototype.onDataItemRemoved=function(t,e,i){t.onRemoved()},R.prototype.reset=function(){this.get("data.meta.columns").reset(),this.get("data.items").reset()},R);function R(t){var e=V.call(this,t)||this;return e.subscriptions=[],e.options=t,e.listenTo(e.get("data.items"),"remove",e.onDataItemRemoved),e}var k,E=o.DataFilter.RuleModel,T=o.DataFilter.GroupModel;function L(t){var e=k.call(this,t)||this;return e.newDS=!1,e.userChanging=!0,e.options=t,e.api=t.api,L.DeltaClientLib=e.options.DeltaClientLib,M.options=e.options,e.onDataCallback=$.proxy(e.onData,e),e.viewModel=new N(e.options),e.options.viewModel=e.viewModel,e.initializeEvents(),e}return k=o.DataFilter.App,i(L,k),L.prototype.clearData=function(){this.viewModel.reset(),this.rootGroup&&(this.stopListening(this.rootGroup.model),this.rootGroup.remove(),this.rootGroup=null),this.api.setProperty("Basics.queryModel",""),this.onMetaChanged()},L.prototype.initializeEvents=function(){this.listenTo(this.viewModel,"change:error",this.updateErrorMessage),this.listenTo(this.viewModel,"change:Basics.data",this.onDataSourceChanged),this.listenTo(this.viewModel,"change:Items",this.onMetaItemsChanged),this.listenTo(this.viewModel,"change:Basics.queryModel",this.onQueryModelChanged),this.onQueryModelChanged()},L.prototype.onDataSourceChanged=function(){var t=this.viewModel.get("Basics.data");this.currentDs!=t&&(this.api.hideQueryStatus(),this.currentDs&&(this.api.unsubscribe(this.currentDs),this.currentDs=null),t&&(this.currentDs=t,this.api.showQueryStatus({type:"Loading"}),this.newDS=!0,this.api.subscribe(this.currentDs,this.onData.bind(this))))},L.prototype.onData=function(t,e,i){i?this.viewModel.set("error",i):(i=this.viewModel.get("data.meta.columns"),this.api.hideErrorMessage(),this.api.hideQueryStatus(),t.columns.reset?i.reset(t.columns.reset):(i.remove(_.map(t.columns.remove,function(t){return t.id})),i.add(t.columns.add),i.add(t.columns.change,{merge:!0})),this.onMetaChanged(),this.newDS&&(this.newDS=!1,this.onQueryModelInit()),this.viewModel.set("dataCollection",e.collection))},L.prototype.onMetaChanged=function(){var i=[],s=this;this.viewModel.get("data.meta.columns").each(function(t){var e=s.viewModel.get("data.items").get(t.id);e?i.push(_.pick(e.attributes,"propertyName","data","items","DataSourceMapping")):i.push({propertyName:t.id,data:"",items:[]})}),this.api.setProperty("Items",i)},L.prototype.onMetaItemsChanged=function(){var e=this,i=this.viewModel.get("Items"),s=this,t=this.viewModel.get("data.items").filter(function(t){t={propertyName:t.get("propertyName")};return!_.some(i,t)});_.each(t,function(t){return e.viewModel.get("data.items").remove(t)}),_.each(i,function(t){s.viewModel.get("data.items").add(t,{merge:!0})})},L.prototype.rCall=function(e,t){var i=this;t&&(t[e]&&t[e](),_.each(t.items,function(t){i.rCall(e,t)}))},L.prototype.onResizeStart=function(){this.rCall("onResizeStart",this.rootGroup)},L.prototype.onResize=function(){this.rCall("onResize",this.rootGroup)},L.prototype.onResizeStop=function(){this.rCall("onResizeStop",this.rootGroup)},L.prototype.onSettingsChange=function(t){var i=this;_.each(t,function(t,e){i.viewModel.set(e,t),"Bindings"===e&&i.rootGroup?i.processAllItems(i.rootGroup.items,function(e){0===t.length||e.useBindings&&!_.find(t,function(t){return e.model.get("value")==="<%"+t.Key+"%>"})?e.preventBindings():e.allowBindings()}):_.includes(e,"Bindings")&&i.rootGroup&&(i.userChanging=!0,i.onQueryModelChanged(),i.userChanging=!1)})},L.prototype.onQueryModelInit=function(){var e=this,t=null,i=this.viewModel.get("Basics.queryModel");try{i?t=JSON.parse(i):this.viewModel.set("kdbString",""),this.renderTemplate(t)}catch(t){this.viewModel.set("error","Query model in view state contains errors. Bad JSON."),this.listenToOnce(this.viewModel,"change:queryModel",function(){e.viewModel.set("error",null)}),setTimeout(function(){e.viewModel.set({queryModel:"",kdbString:""}),e.renderTemplate(null)},3e3)}},L.prototype.onQueryModelChanged=function(){var t=this;this.rootGroup&&(this.kxStringUpdate&&clearTimeout(this.kxStringUpdate),this.kxStringUpdate=setTimeout(function(){t.api.setProperty("Basics.kdbString",o.ipc.Util.toHexString(o.ipc.Util.toMessage(t.rootGroup.model.toIPC())))},700),this.userChanging||(this.stopListening(this.rootGroup.model),this.rootGroup.remove(),this.onQueryModelInit()))},L.prototype.processAllItems=function(t,e){var i=this;_.each(t,function(t){t.renderModel.isGroup?i.processAllItems(t.items,e):e(t)})},L.prototype.remove=function(){this.currentDs&&this.api.unsubscribe(this.currentDs);var t=this.viewModel.get("data.items");return t&&_.each(t.models,function(t){return t.onRemoved()}),e.View.prototype.remove.call(this)},L.prototype.renderTemplate=function(t){var e,i=this;return this.$el.html(p.app({})),_.extend(t||{},{appModel:this.viewModel}),e=new T(t),this.rootGroup=new m({model:e,appModel:this.viewModel,el:this.$(".query-builder"),isRoot:!0}),this.listenTo(e,"change",function(){i.userChanging=!0,i.api.setProperty("Basics.queryModel",JSON.stringify(e.toJSON())),i.userChanging=!1}),this.userChanging&&this.onQueryModelChanged(),this.userChanging=!1,this},L.prototype.updateErrorMessage=function(t){this.viewModel.get("error")?this.api.showErrorMessage({error:t.get("error"),type:"Error"}):this.api.hideErrorMessage()},L.getComponentDefinition=l.getComponentDefinition,L.PROP_BINDINGS="Bindings",L});