define(["backbone","Handlebars","moment","mapbox","css!./css/app.css"],function(o,y,e,l){"use strict";var i,s=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o])})(e,t)},function(e,t){function o(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)}),r=(a.getComponentDefinition=function(e){var t,o,i={appArgs:{json:{version:"4.6.0",MapDetails:{Bearing:12,Key:"",Latitude:19.297668,Longitude:-99.5968,Pitch:14,Selected:"",SelectedCol:"",Zoom:8},Overlays:{GeoJSON:"",GeoJSONFull:"",GeoJSONLines:""},Points:{Color:"",DataSource:"",Icon:"",Latitude:"",Longitude:"",SubTitle:"",Title:"",Tooltip:"",Type:""},possibleColumns:[""],Style:{Theme:"Dark",advanced:""}},schema:{properties:{MapDetails:{options:{collapsed:!1},properties:{Key:{default:"",propertyOrder:1,title:"Map Box Key",type:"string"},Bearing:{default:0,maximum:15,minimum:0,propertyOrder:5,title:"Bearing",type:"number"},Latitude:{default:0,maximum:85,minimum:-85,propertyOrder:2,title:"Latitude",type:"number"},Longitude:{default:0,maximum:180,minimum:-180,propertyOrder:3,title:"Longitude",type:"number"},Pitch:{default:0,maximum:50,minimum:0,propertyOrder:4,title:"Pitch",type:"number"},Selected:{default:"",propertyOrder:6,type:"viewstate"},SelectedCol:{default:"lat",enumSource:"poss_rul_cols",propertyOrder:7,title:"Selected Column",type:"string",watch:{poss_rul_cols:"root.possibleColumns"}},Zoom:{default:8,maximum:17,minimum:0,propertyOrder:1,title:"Zoom",type:"number"}},propertyOrder:2,title:"Map",type:"object"},Overlays:{options:{collapsed:!0},properties:{GeoJSON:{default:"",propertyOrder:1,title:"GeoJSON Overlay Data",type:"json"},GeoJSONFull:{default:"",propertyOrder:3,title:"GeoJSON Full ",type:"json"},GeoJSONLines:{default:"",propertyOrder:2,title:"GeoJSON Lines Data",type:"json"}},propertyOrder:990,title:"Overlays",type:"object"},Points:{properties:{Color:{default:"",enumSource:"poss_rul_cols",propertyOrder:7,title:"Color",type:"string",watch:{poss_rul_cols:"root.possibleColumns"}},DataSource:{default:8,format:"data",maximum:17,minimum:0,propertyOrder:1,title:"DataSource",type:"data"},Icon:{default:"",enumSource:"poss_rul_cols",propertyOrder:8,title:"Icon",type:"string",watch:{poss_rul_cols:"root.possibleColumns"}},Latitude:{default:"lat",enumSource:"poss_rul_cols",propertyOrder:2,title:"Latitude Data",type:"string",watch:{poss_rul_cols:"root.possibleColumns"}},Longitude:{default:"lng",enumSource:"poss_rul_cols",propertyOrder:3,title:"Longitude Data",type:"string",watch:{poss_rul_cols:"root.possibleColumns"}},SubTitle:{default:"",enumSource:"poss_rul_cols",propertyOrder:6,title:"Sub Title",type:"string",watch:{poss_rul_cols:"root.possibleColumns"}},Title:{default:"",enumSource:"poss_rul_cols",propertyOrder:5,title:"Title",type:"string",watch:{poss_rul_cols:"root.possibleColumns"}},Tooltip:{default:"",propertyOrder:9,title:"Tooltip",type:"tooltipTemplate",disableTree:!0},Type:{default:"",enumSource:"poss_rul_cols",propertyOrder:4,title:"Marker Type",type:"string",watch:{poss_rul_cols:"root.possibleColumns"}}},propertyOrder:2,title:"Points",type:"object"},possibleColumns:{default:[],format:"table",items:{type:"string"},options:{collapsed:!0,hidden:!0},type:"array"},Style:{options:{collapsed:!0},properties:{DashboardTheme:{options:{hidden:!0}},Theme:{default:"Dark",enum:["Light","Dark"],options:{hidden:!0},title:"Theme",type:"string"},advanced:{default:"",propertyOrder:160,title:"Advanced CSS",type:"css"}},propertyOrder:991,title:"Style",type:"object"}},title:"Properties",type:"object"},websiteUrl:e.websiteUrl},appKey:"Mapbox",buildViewThumb:null,componentDescription:"Mapbox Widget (BETA)",componentName:"Mapbox",css:"mapbox",ghostViewThumb:null,id:10123};if(0<_.keys(e.settingsModel.attributes).length)for(o=a.upgrades.indexOf(_.find(a.upgrades,{version:e.settingsModel.get("version")}))+1;o<a.upgrades.length;o+=1)(t=a.upgrades[o]).fn(e.settingsModel,e),e.settingsModel.set("version",t.version);return i},a);function a(){}r.upgrades=[{fn:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t]},version:0},{version:"4.5.1",fn:function(e){e.set("possibleColumns",e.get("PossibleColumns"))}},{version:"4.6.0",fn:function(e){var t=e.get("MapDetails");t.Key=void 0===t.Key?"":t.Key,e.set("MapDetails",t)}}];var p=(n.alert=y.template({compiler:[7,">= 4.0.0"],main:function(e,t,o,i,s){var r=null!=t?t:e.nullContext||{},a=o.helperMissing,n="function",l=e.escapeExpression;return' <div>\n    <div style="display:inline-block;">\n        <div style="font-weight: 400; font-size: 13px;"> '+l(typeof(e=null!=(e=o.title||(null!=t?t.title:t))?e:a)==n?e.call(r,{name:"title",hash:{},data:s}):e)+' </div>\n        <div style="color: rgba(0,0,0,.54);"> '+l(typeof(e=null!=(e=o.subtitle||(null!=t?t.subtitle:t))?e:a)==n?e.call(r,{name:"subtitle",hash:{},data:s}):e)+'</div>\n        <div style="color: rgba(0,0,0,.54);"> '+l(typeof(e=null!=(e=o.timeAgo||(null!=t?t.timeAgo:t))?e:a)==n?e.call(r,{name:"timeAgo",hash:{},data:s}):e)+' </div>\n    </div>\n    <div style="float:right;">\n        <i aria- hidden="true" class="material-icons" style="color:'+l(typeof(e=null!=(e=o.color||(null!=t?t.color:t))?e:a)==n?e.call(r,{name:"color",hash:{},data:s}):e)+';"> '+l(typeof(e=null!=(e=o.icon||(null!=t?t.icon:t))?e:a)==n?e.call(r,{name:"icon",hash:{},data:s}):e)+" </i>\n        \n    </div>\n</div>"},useData:!0}),n.app=y.template({compiler:[7,">= 4.0.0"],main:function(e,t,o,i,s){var r;return'<div class="mapbox" id="mapbox-'+e.escapeExpression("function"==typeof(r=null!=(r=o.id||(null!=t?t.id:t))?r:o.helperMissing)?r.call(null!=t?t:e.nullContext||{},{name:"id",hash:{},data:s}):r)+'">\n</div>\n'},useData:!0}),n.markerTooltip=y.template({1:function(e,t,o,i,s){var r;return"<div>"+e.escapeExpression("function"==typeof(r=null!=(r=o.process||(null!=t?t.process:t))?r:o.helperMissing)?r.call(null!=t?t:e.nullContext||{},{name:"process",hash:{},data:s}):r)+"</div>"},compiler:[7,">= 4.0.0"],main:function(e,t,o,i,s){var r,a=null!=t?t:e.nullContext||{};return'  <div style="color:black">\n    <div style="padding:5px;">\n        <a style="font-size: 20px!important; font-weight: 500; color: #1976d2; cursor:pointer;">'+e.escapeExpression("function"==typeof(r=null!=(r=o.title||(null!=t?t.title:t))?r:o.helperMissing)?r.call(a,{name:"title",hash:{},data:s}):r)+"</a> \n        "+(null!=(s=o.if.call(a,null!=t?t.process:t,{name:"if",hash:{},fn:e.program(1,s,0),inverse:e.noop,data:s}))?s:"")+'\n    </div>\n    <div class="alertHtml" style="height:100%; padding-left:10px;padding-right:10px;"></div>\n</div>'},useData:!0}),n);function n(){}var u,c=["MapDetails.Selected","Points.Tooltip"];function d(e){var t=u.call(this,e)||this;return t.pointsSource=void 0,t.pointsData=[],t.ignoreOnSettingsChange=!1,t.errors={},t.listenersActive=!1,t.mapLoaded=!1,t.mapboxID="",t.ID=t.cid,t.lineID="line"+t.cid,t.pointID="point"+t.cid,t.markers=[],t.templateSubscrKey=null,t.templateVs={},t.api=e.api,t.mapboxID="mapbox-"+t.cid,t.$el.html(p.app({id:t.cid})),t.$el.addClass("mapbox-app"),t.$mapbox=t.$el.find(".mapbox"),t.viewModel=new o.DeepModel({}),t}return u=o.View,s(d,u),d.prototype.onResize=function(){this.renderMap()},d.prototype.onSettingsChange=function(e){var o=this;_.each(e,function(e,t){o.viewModel.set(t,e)}),!this.ignoreOnSettingsChange&&Object.keys(e).filter(function(e){return-1===c.indexOf(e)&&"string"==typeof e&&-1===c.indexOf(e.split(".")[0])}).length?this.renderMap():this.ignoreOnSettingsChange=!1,this.listenersActive||this.initializeListeners()},d.prototype.initializeListeners=function(){this.listenTo(this.viewModel,"change:Points.DataSource",this.onPointsChange),this.listenTo(this.viewModel,"change:Points.Tooltip",this.onTemplateChange),this.onPointsChange(this.viewModel,this.viewModel.get("Points.DataSource")),this.listenersActive=!0},d.prototype.destroyMap=function(){this.map&&this.map.remove()},d.prototype.onPointsData=function(e,t,o){if(o)return this.updateError("Points Source",o);o=this.pointsSource.dataSet.columns.map(function(e){return e.get("id")});this.api.setProperty("possibleColumns",[""].concat(o)),this.pointsData=t.items?t.items():this.pointsSource.dataSet.collection.models.map(function(e){return e.attributes}),this.renderMap()},d.prototype.onPointsChange=function(e,o){this.pointsSource&&(this.stopListening(this.pointsSource),this.api.unsubscribe(this.pointsSource),this.pointsSource=void 0),o&&(this.pointsSource=o,this.pointsSource&&this.pointsSource.attributes?(this.updateError("Point Source",void 0),this.api.subscribe(this.pointsSource,$.proxy(this.onPointsData,this))):this.updateError("Points Source",{error:t("Invalid Data Source: ")+o.path+" "+t("selected"),type:"Warning"}))},d.prototype.onTemplateChange=function(e,t){var o=this;this.unsubscribeTemplate(),t?this.templateSubscrKey=this.api.subscribeTemplateViewStates(t,function(e){o.templateVs=e,o.renderMap()}):this.templateVs={}},d.prototype.renderMap=function(){this.destroyMap();var e=this.viewModel.get("MapDetails"),t=e.Zoom,o=e.Bearing,i=e.Latitude,s=e.Longitude,r=e.Pitch,e=e.Key;(l.accessToken=e)?(this.api.hideQueryStatus(),this.map=new l.Map({bearing:o,center:[s,i],container:this.mapboxID,pitch:r,style:"mapbox://styles/mapbox/streets-v9",zoom:t}),this.map.on("load",this.onMapLoad.bind(this))):this.api.showQueryStatus({error:"Please add Mapbox API Key",type:"Error"})},d.prototype.refreshMapGeojson=function(){var e=this.viewModel.get("Overlays.GeoJSON");e&&(e=JSON.parse(e),this.mapLoaded&&(this.map.getLayer(this.ID)&&this.map.removeLayer(this.ID),e&&this.map.addLayer({id:this.ID,paint:{"fill-extrusion-base":["get","base_height"],"fill-extrusion-color":["get","color"],"fill-extrusion-height":["get","height"],"fill-extrusion-opacity":1},source:{data:e,type:"geojson"},type:"fill-extrusion"})))},d.prototype.refreshMapGeojsonLine=function(){var e=this.viewModel.get("Overlays.GeoJSONLines");e&&(e=JSON.parse(e),this.mapLoaded&&(this.map.getLayer(this.lineID)&&this.map.removeLayer(this.lineID),e&&this.map.addLayer({id:"route",layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":["get","color"],"line-width":["get","stroke-width"]},source:{data:e,type:"geojson"},type:"line"})))},d.prototype.refreshMapGeojsonFull=function(){var e=this.viewModel.get("Overlays.GeoJSONFull");e&&(e=JSON.parse(e),this.mapLoaded&&(this.map.getLayer(this.pointID)&&this.map.removeLayer(this.pointID),e&&this.map.addLayer(e)))},d.prototype.remove=function(){return this.destroyMap(),this.unsubscribeTemplate(),o.View.prototype.remove.apply(this)},d.prototype.addMarker=function(e,t,o){var i="",s=document.createElement("i"),r=document.createElement("div"),a=this.api;switch(o.type){case"circle":s.className="mapxBoxIcon",r.className="mapxBoxMarker",r.className="circle";break;case"square":s.className="mapxBoxIcon",r.className="mapxBoxMarker",r.className="square";break;case"Plant_Marker":s.className="fa fa-building mapxBoxIcon",r.className="material-icons mapxBoxMarker";break;default:s.className="material-icons mapxBoxIcon",r.className="material-icons mapxBoxMarker"}r.appendChild(s),i+="background : "+o.color,s.innerHTML=o.icon,r.style.cssText=i,s.style.cssText="";var n=window.document.createElement("div");n.innerHTML=p.markerTooltip({process:o.process,title:o.title});i=o.tooltip;$(n).find(".alertHtml").html(i);n=new l.Marker(r).setLngLat(e).setPopup(new l.Popup({offset:10}).setDOMContent(n)).addTo(this.map);r.addEventListener("click",function(e){a.setProperty("MapDetails.Selected",o.selected)}),this.markers.push(n)},d.prototype.addMarkerData=function(){var o,i=this,e=this.viewModel.get("Points"),s=e.Latitude,r=e.Longitude,a=e.Message,n=e.Type,l=e.Title,p=e.SubTitle,u=e.Color,c=e.Icon,d=(e.DataSource,e.Tooltip),m=this.viewModel.get("MapDetails.SelectedCol"),h="";_.each(this.pointsData,function(e){try{var t=y.compile(d);h='<div style="color:#000000">'+t(_.extend(e,i.templateVs))+"</div>"}catch(e){h=""}t={color:e[u],icon:e[c],process:e[p],selected:e[m],title:e[l],tooltip:h,type:e[n]};o=e[r]&&e[s]?[e[r],e[s]]:[0,0],i.addMarker(o,e[a],t)})},d.prototype.onMapLoad=function(){this.mapLoaded=!0,this.refreshMapGeojson(),this.refreshMapGeojsonLine(),this.refreshMapGeojsonFull(),this.addMarkerData()},d.prototype.unsubscribeTemplate=function(){this.templateSubscrKey&&this.api.unsubscribeTemplateViewStates(this.templateSubscrKey)},d.prototype.updateError=function(e,t){t?this.errors[e]=t:delete this.errors[e],_.keys(this.errors).length?(e=_.map(this.errors,function(e,t){return"["+t+"]: "+e.error}),this.api.showQueryStatus({error:e.join("\n"),type:"Error"})):this.api.hideQueryStatus()},d.getComponentDefinition=r.getComponentDefinition,d});