define(["backbone","Forms","Accordion","BasicComponents","Datagrid","DataFilter","QuickBase","Handlebars","vis","moment","jqueryui","jstree","css!./css/app.css"],function(l,r,i,e,n,s,c,a,o,d,u,p){"use strict";var h,f=this&&this.__extends||(h=function(e,t){return(h=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)},function(e,t){function i(){this.constructor=e}h(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}),g=(m.getComponentDefinition=function(e){var t,i,n={id:19,componentName:"Graph",componentDescription:"Graph",appKey:"Graph",css:"graphs",ghostViewThumb:null,buildViewThumb:null,appArgs:{websiteUrl:(e=e||{websiteUrl:"",settingsModel:new l.Model}).websiteUrl,json:{version:"4.4.1",Basics:{Data:"",Connection:"html5evalcongroup",Direction:"Left-Right",DialogPlacement:"Pop-up",AutoSave:!1,ReadOnly:!1,ForceSelection:!1,Selected:"",JSON:"",qIPC:"",UseViewStates:!1,Theme:"Dark"},Bindings:[],Style:{advanced:"",LevelSeparation:220,NodeSpacing:150}},schema:{type:"object",title:"Properties",properties:{Basics:{type:"object",title:"Basics",options:{collapsed:!1},propertyOrder:202,properties:{Data:{title:"Data Source",type:"data",default:""},Connection:{type:"dataConnection",title:"Connection",default:"html5evalcongroup"},Direction:{type:"string",title:"Direction",default:"Left-Right",enum:["Left-Right","Right-Left","Up-Down","Down-Up"]},DialogPlacement:{type:"string",title:"Dialog Placement",default:"Pop-up",enum:["Left","Right","Pop-up"]},AutoSave:{type:"boolean",title:"Auto Save Dialogs",default:!1,format:"checkbox"},ReadOnly:{type:"boolean",title:"Read only",default:!1,format:"checkbox"},ForceSelection:{type:"boolean",title:"Force Selection",default:!1,format:"checkbox"},Selected:{type:"viewstate",title:"Selected Node",default:""},JSON:{type:"string",title:"Source",default:""},qIPC:{type:"string",title:"KDB",default:""},UseViewStates:{type:"boolean",default:!1,options:{hidden:!0}},Theme:{type:"string",title:"Theme",options:{hidden:!0},enum:["Dark","Light"]},DashboardTheme:{options:{hidden:!0}}}},Bindings:{type:"array",format:"table",title:"Bindings",uniqueItems:!0,options:{collapsed:!1},items:{type:"object",properties:{Key:{type:"string"},ViewState:{type:"viewstate"}}}},Style:{type:"object",title:"Style",options:{collapsed:!0},properties:{LevelSeparation:{type:"number",format:"number",title:"Level Separation",default:220},NodeSpacing:{type:"number",format:"number",title:"Node Spacing",default:150}}}}}}};if(0<_.keys(e.settingsModel.attributes).length)for(i=m.upgrades.indexOf(_.find(m.upgrades,{version:e.settingsModel.get("version")}))+1;i<m.upgrades.length;i+=1)(t=m.upgrades[i]).fn(e.settingsModel,e),e.settingsModel.set("version",t.version);return n},m.getSettingsModel=function(e){var t=m.getComponentDefinition(null).appArgs.json;return $.extend(!0,t,e),new l.DeepModel(t)},m);function m(){}g.upgrades=[{version:0,fn:_.noop.bind(this)},{version:"4.3.1",fn:function(e){e.get("Basics.ReadOnly")||e.set("Basics.ReadOnly",!1),e.get("Basics.Data")||e.set("Basics.Data","")}},{version:"4.5.0",fn:function(e){e.get("Basics.Direction")||e.set("Basics.Direction","Left-Right"),e.get("Style.LevelSeparation")||e.set("Style.LevelSeparation",220),e.get("Style.NodeSpacing")||e.set("Style.NodeSpacing",150),e.get("Basics.DialogPlacement")||e.set("Basics.DialogPlacement","Pop-up"),e.get("Basics.AutoSave")||e.set("Basics.AutoSave",!1),e.get("Basics.UseViewStates")||e.set("Basics.UseViewStates",!1)}},{version:"4.6.0",fn:function(e){e.get("Basics.ForceSelection")||e.set("Basics.ForceSelection",!1)}}];var v,y=c.QueryBuilder,w=(v=y.GraphNode,f(b,v),b.teaser2=function(e){return e.split("\n").map(function(e){return 26<e.length?e.substring(0,24)+"...":e}).join("\n")},b.valueDescription=function(e,t){function i(e){return _.isString(e)&&b.VSRx.exec(e)?"  "+e.substring(2,e.length-2):e||"null"}return(_.isNil(t)?"":" between ")+i(e)+(_.isNil(t)?"":" and "+i(t))},b.prototype.color=function(){switch(this.group){case"data":case"function":return"#97C2FB";case"stream":return"#fe79b8";case"filter":return"#FFED7C";case"groupBy":return"#F99F69";case"join":return"#98D26A";case"result":return"#A96FE8";case"update":return"#FF5B66"}},b.prototype.icon=function(){switch(this.group){case"data":case"stream":return"";case"filter":return"";case"groupBy":return"∑";case"join":return"";case"function":return"ƒ:";case"result":return"";case"update":return""}},b.prototype.teaser=function(){var e=this.description()||_.capitalize(this.group)+" "+this.id;return 26<e.length?e.substring(0,24)+"...":e},b);function b(){return null!==v&&v.apply(this,arguments)||this}var S,P=(f(D,S=w),D.prototype.description=function(){var e=this.data;if(e&&e.name&&e.params)return e.name+"("+e.params.map(function(e){return w.valueDescription(e.value)}).join(",")+")";if(e&&e.name&&e.partition){var t=e.partition;return e.name+" partitioned by "+("long"===t.type?"year":t.type)+" "+t.operator+" "+t.parameters.map(function(e){return w.valueDescription(e.value)}).join(", ")}return _.isEmpty(e)?_.capitalize(this.group)+" node":e},D);function D(){var e=null!==S&&S.apply(this,arguments)||this;return e.getActiveBindingKeys=y.DataNode.getActiveBindingKeys,e}var k,x=(f(C,k=w),C.description=function(e){var i=function(e){return _.map(e.children,function(e){var t=e;return e.children?"("+i(e)+")":(t.propertyName||"")+("histogram"!==t.type&&t.operator?y.FilterNode.operatorMap[t.operator]:"")+w.valueDescription(t.value,t.value2)}).join(y.FilterNode.operatorMap[e.operator])};return i(e)},C.prototype.description=function(){var e=this.data,t=_.isEmpty(e.select)?"":_.map(e.select,function(e,t){return t===e?t:e+"→"+w.valueDescription(t)}).join(",");return e.where&&e.where.children&&e.where.children.length&&(t+=(t?"\n":"")+" where "+C.description(e.where)),(t=e.distinct?"distinct "+t:t)||"select all"},C.prototype.teaser=function(){return w.teaser2(this.description())},C);function C(){var e=null!==k&&k.apply(this,arguments)||this;return e.getActiveBindingKeys=y.FilterNode.getActiveBindingKeys,e}var N,E=(f(R,N=w),R.prototype.description=function(){var e=this.data,t="group by "+_.map(e.groupBy,function(e,t){return t===(e=_.isString(e)?e:"round("+e.col+","+e.num+e.cast+")")?t:e+"→"+w.valueDescription(t)}).join(",");return _.isEmpty(e.agg)||(t+="\n select "+_.map(e.agg,function(e,t){return e[0]+"("+e.slice(1).join(",")+")"+(t!==e[1]&&2<=e.length?"→"+w.valueDescription(t):"")}).join(",")),t},R.prototype.teaser=function(){return w.teaser2(this.description())},R);function R(){var e=null!==N&&N.apply(this,arguments)||this;return e.getActiveBindingKeys=y.GroupByNode.getActiveBindingKeys,e}var V,T=(f(O,V=w),O.prototype.description=function(){var e="",t=this.data;if(!t)return _.capitalize(this.group);var i=t.left,n=t.right,a=t.swap;switch(t.fn){case"aj":e=(a?n:i).join(",");break;case"uj":case"upsert":e=(a?n:i).join(",")+(0<i.length&&0<n.length?" and ":"")+(a?i:n).join(",");break;default:e=(a?i:n).join(",")}return{ij:"Inner",lj:"Left",uj:"Union",aj:"Asof (aj)",upsert:"Upsert",pj:"Plus"}[t.fn]+" join"+(_.isEmpty(e)?"":" on "+e)},O);function O(e){e=V.call(this,e)||this;return _.isEmpty(e.data)&&(e.data={fn:"lj",swap:!1,left:[],right:[]}),e}var B,I=(f(M,B=w),M.prototype.description=function(){return _.capitalize(this.group)},M);function M(){return null!==B&&B.apply(this,arguments)||this}var A,L=(f(j,A=w),j.prototype.description=function(){var e=this.data,t=_.map(e.update,function(e){return"set "+e.column+"="+(_.isArray(e.val)?e.val.map(function(e){return w.valueDescription(e)}):w.valueDescription(e.val))}).join(", ");return e.filter&&e.filter.children&&e.filter.children.length&&(t+="\n where "+x.description(e.filter)),t},j.prototype.teaser=function(){return w.teaser2(this.description())},j);function j(){var e=null!==A&&A.apply(this,arguments)||this;return e.getActiveBindingKeys=y.UpdateNode.getActiveBindingKeys,e}var F=(J.aggregateRow=a.template({compiler:[7,">= 4.0.0"],main:function(e,t,i,n,a){return'<div class="row">\n    <select class="fn"></select>\n    <select class="col1"></select>\n    <select class="col2"></select>\n    <div class="user-input"></div>\n    <div class="del" title="Delete Row"></div>\n</div>'},useData:!0}),J.aggregateView=a.template({compiler:[7,">= 4.0.0"],main:function(e,t,i,n,a){return'<div class="rows"></div>\n<div class="add-row">Add Aggregate</div>'},useData:!0}),J.app=a.template({compiler:[7,">= 4.0.0"],main:function(e,t,i,n,a){return'<div class="graph-container">\n    <div class="graph-content">\n        <div class="accordion">\n            <div class="side-dialog" style="display:none;">\n                <div class="side-dialog-menu">\n                    <span class="menu-item menu-icon"></span>\n                    <span class="menu-item description"></span>\n                    <span class="menu-item close-button"><i class="fa fa-times"></i></span>\n                </div>\n                <div class="side-dialog-content"></div>\n                <div class="side-dialog-buttons">\n                    <span class="save-button">Save</span>\n                </div>\n            </div>\n            <div class="builder">\n                <div class="helpful-tip" style="display:none;">\n                    <p><i class="fa fa-info-circle"></i><span></span></p>\n                </div>\n                <div class="graph"></div>\n            </div>\n        </div>\n    </div>\n    <ul class=\'custom-menu\'></ul>\n\n    <div class="nodeErrorMessage" style="display:none">\n        <div class="errors-title"><i class="fa fa-exclamation-triangle"></i><span>'+e.escapeExpression((i.t||t&&t.t||i.helperMissing).call(null!=t?t:e.nullContext||{},"Error:",{name:"t",hash:{},data:a}))+'</span></div>\n        <span class="errors-text"></span>\n    </div>\n</div>'},useData:!0}),J.bindingSelect=a.template({compiler:[7,">= 4.0.0"],main:function(e,t,i,n,a){var s;return'<div class="binding-wrap">\n    <i class="fa fa-fw watermark fa-eye binding-apply"></i>\n\n    <div class="binding-container" style="display:none">\n        <i class="fa fa-fw watermark fa-eye viewstate-icon"></i>\n        <input class="viewstate-display" type="text" tabindex="-1" value="'+e.escapeExpression("function"==typeof(s=null!=(s=i.viewstateDisplay||(null!=t?t.viewstateDisplay:t))?s:i.helperMissing)?s.call(null!=t?t:e.nullContext||{},{name:"viewstateDisplay",hash:{},data:a}):s)+'" readonly />\n        <i class="fa fa-fw watermark fa-eraser binding-clear-dialog"></i>\n        <div class="binding-dropdown">\n            <select class="binding-select"></select>\n        </div>\n    </div>\n</div>'},useData:!0}),J.dataDialog=a.template({compiler:[7,">= 4.0.0"],main:function(e,t,i,n,a){return'<div class=\'treeView\'>\n    <div class=\'search\'>\n        <i class=\'fa fa-search\'></i>\n        <input type=\'text\' class=\'searchBox\' />\n        <span class="clearSearch fa fa-times" style="display: none"></span>\n    </div>\n    <div class=\'tree\'></div>\n</div>\n<div class="paramsView">\n    <fieldset>\n        <legend class="paramTitle"></legend>\n        <div class="paramList"></div>\n    </fieldset>\n</div>\n<div class="data-error" style="display:none">\n    <i class="fa fa-exclamation-circle" aria-hidden="true"></i><span></span>\n</div>'},useData:!0}),J.dataParameter=a.template({1:function(e,t,i,n,a){var s;return'    <input class="name-input col1" value="'+e.escapeExpression("function"==typeof(s=null!=(s=i.name||(null!=t?t.name:t))?s:i.helperMissing)?s.call(null!=t?t:e.nullContext||{},{name:"name",hash:{},data:a}):s)+'" />\n'},3:function(e,t,i,n,a){var s;return'    <label class="col1">'+e.escapeExpression("function"==typeof(s=null!=(s=i.name||(null!=t?t.name:t))?s:i.helperMissing)?s.call(null!=t?t:e.nullContext||{},{name:"name",hash:{},data:a}):s)+"</label>\n"},5:function(e,t,i,n,a){var s;return'    <div class="remove-item-btn col4" data-id="'+e.escapeExpression("function"==typeof(s=null!=(s=i.id||(null!=t?t.id:t))?s:i.helperMissing)?s.call(null!=t?t:e.nullContext||{},{name:"id",hash:{},data:a}):s)+'">\n        Remove Item\n    </div>\n'},compiler:[7,">= 4.0.0"],main:function(e,t,i,n,a){var s,o=null!=t?t:e.nullContext||{},r=i.helperMissing,l=e.escapeExpression;return'<div class="form-control viewstate-control">\n'+(null!=(s=i.if.call(o,null!=t?t.editable:t,{name:"if",hash:{},fn:e.program(1,a,0),inverse:e.program(3,a,0),data:a}))?s:"")+'\n    <div class="type-dropdown col2">\n        <select class="type-select">\n            <option>boolean</option>\n            <option>byte</option>\n            <option>char</option>\n            <option>date</option>\n            <option>datetime</option>\n            <option>dict</option>\n            <option>double</option>\n            <option>float</option>\n            <option>guid</option>\n            <option>int</option>\n            <option>list</option>\n            <option>long</option>\n            <option>minute</option>\n            <option>month</option>\n            <option>second</option>\n            <option>short</option>\n            <option>string</option>\n            <option>symbol</option>\n            <option>time</option>\n            <option>timespan</option>\n            <option>timestamp</option>\n        </select>\n    </div>\n\n    <div class="input-div col3">\n        \x3c!-- <input class="value-input" type="text" data-schemaformat="number" /> --\x3e\n        <span class="value-input bbf-editor"></span>\n\n        <i\n            class="fa fa-fw watermark fa-eye binding-apply binding-apply-dialog"\n        ></i>\n        <i class="fa fa-fw watermark fa-eye viewstate-apply"></i>\n\n        <div class="generate-value" title="'+l((i.t||t&&t.t||r).call(o,"Generate View State",{name:"t",hash:{},data:a}))+'">\n            <i class="fa fa-fw watermark fa-eye generate-viewstate-icon"></i>\n            <i class="fa fa-fw watermark fa-cog generate-viewstate-icon"></i>\n        </div>\n\n        <div class="binding-container">\n            <i class="fa fa-fw watermark fa-eraser binding-clear-dialog"></i>\n            <i\n                class="fa fa-fw watermark fa-eraser binding-clear"\n                title="'+l((i.t||t&&t.t||r).call(o,"Clear View State",{name:"t",hash:{},data:a}))+'"\n            ></i>\n            <div class="binding-dropdown">\n                <select class="binding-select">\n                    \x3c!--<option>binding1</option>\n\t\t\t\t\t<option>binding2</option>\n\t\t\t\t\t<option>binding3</option>--\x3e\n                </select>\n            </div>\n            <i\n                class="fa fa-fw watermark fa-eye binding-icon viewstate-icon"\n                title="'+l((i.t||t&&t.t||r).call(o,"Select View State",{name:"t",hash:{},data:a}))+'"\n            ></i>\n            <input\n                class="value-display data-parameter-editor"\n                type="text"\n                tabindex="-1"\n                readonly\n            />\n        </div>\n\n        <div class="node-container"></div>\n    </div>\n\n'+(null!=(s=i.if.call(o,null!=t?t.editable:t,{name:"if",hash:{},fn:e.program(5,a,0),inverse:e.noop,data:a}))?s:"")+'</div>\n\n<div class="form-control viewstate-control button-row">\n    <div class="add-item-btn">\n        Add Item\n    </div>\n</div>\n\n<div class="list-items" style="margin-bottom: 22px; padding-left: 1em;"></div>\n'},useData:!0}),J.filterDialog=a.template({compiler:[7,">= 4.0.0"],main:function(e,t,i,n,a){return'<div class="select-table"></div>\n<div class="where-table"></div>'},useData:!0}),J.groupByDialog=a.template({compiler:[7,">= 4.0.0"],main:function(e,t,i,n,a){return'<div class="select-table"></div>\n<div class="agg-table"></div>'},useData:!0}),J.joinDialog=a.template({compiler:[7,">= 4.0.0"],main:function(e,t,i,n,a){var s=null!=t?t:e.nullContext||{},o=i.helperMissing,r="function",l=e.escapeExpression;return'<div class="join-dialog">\n    <div class="transformJoinType">\n        <span class="transformJoinTypeText">Join Type : </span>\n        <div class="joinDDL">\n            <select class="join-type-select"></select>\n        </div>\n    </div>\n    <div class="transformJoinTextDesc"></div>\n\n    <fieldset class="filterFieldset">\n        <legend>\n            <div class="transformSelection"></div>\n        </legend>\n\n        <div class="fieldSetDetails">\n            <div class="transformJoin">\n                <div class="transformJoinText">\n                    <span class="dbNameLeft col1">'+l(typeof(e=null!=(e=i.a||(null!=t?t.a:t))?e:o)==r?e.call(s,{name:"a",hash:{},data:a}):e)+'</span>\n                    <a class="swap" title="Swap Left and Right"><i class="fa fa-exchange"></i></a>\n                    <span class="dbNameRight col2">'+l(typeof(e=null!=(e=i.b||(null!=t?t.b:t))?e:o)==r?e.call(s,{name:"b",hash:{},data:a}):e)+"</span>\n                </div>\n                <div class=\"transformLeftDDL\"></div>\n                <div class=\"transformRightDDL\"></div>\n                <div class=\"transformJoinTables\">\n                    <div class=\"transformTable transformLeftTable col1\">\n                        <div class='searchRow'><input class='search' type='text' placeholder=\"search here...\" /><span\n                                class='closeIcon fa fa-times'></span></div>\n                        <div class='rows'></div>\n                    </div>\n                    <div class=\"transformTable transformRightTable col2\">\n                        <div class='searchRow'><input class='search' type='text' placeholder=\"search here...\" /><span\n                                class='closeIcon fa fa-times'></span></div>\n                        <div class='rows'></div>\n                    </div>\n                </div>\n            </div>\n        </div>\n    </fieldset>\n</div>"},useData:!0}),J.joinRow=a.template({compiler:[7,">= 4.0.0"],main:function(e,t,i,n,a){return"<div class='row'>\n    <input type='checkbox' checked />\n    <label></label>\n</div>"},useData:!0}),J.menu=a.template({1:function(e,t,i,n,a){var s=null!=t?t:e.nullContext||{},o=i.helperMissing,r="function",l=e.escapeExpression;return'<li class="selectable" data-index = "'+l(typeof(e=null!=(e=i.id||(null!=t?t.id:t))?e:o)==r?e.call(s,{name:"id",hash:{},data:a}):e)+'"><i class="'+l(typeof(e=null!=(e=i.icon||(null!=t?t.icon:t))?e:o)==r?e.call(s,{name:"icon",hash:{},data:a}):e)+'"></i>'+l(typeof(e=null!=(e=i.text||(null!=t?t.text:t))?e:o)==r?e.call(s,{name:"text",hash:{},data:a}):e)+"</li>\n"},compiler:[7,">= 4.0.0"],main:function(e,t,i,n,a){return null!=(a=i.each.call(null!=t?t:e.nullContext||{},t,{name:"each",hash:{},fn:e.program(1,a,0),inverse:e.noop,data:a}))?a:""},useData:!0}),J.partitionView=a.template({compiler:[7,">= 4.0.0"],main:function(e,t,i,n,a){return'<div class="operator-dropdown">\n    <select class="operator-select">\n        <option>equals</option>\n        <option>in</option>\n        <option>within</option>\n    </select>\n</div>\n<div class="data-parameter-container"></div>'},useData:!0}),J.selectRow=a.template({1:function(e,t,i,n,a){return' checked="checked" '},3:function(e,t,i,n,a){return"disabled"},5:function(e,t,i,n,a,s,o){var r,l=null!=t?t:e.nullContext||{};return'    <table class="xbar">\n        <tr>\n            <td><label title="round down to multiple"><input type="checkbox" class="xcheckbox" '+(null!=(r=i.if.call(l,null!=(r=null!=t?t.xbar:t)?r.num:r,{name:"if",hash:{},fn:e.program(6,a,0,s,o),inverse:e.noop,data:a}))?r:"")+' />round</label></td>\n            <td><input class="xnum" type="number" value="'+(null!=(r=i.if.call(l,null!=(r=null!=t?t.xbar:t)?r.num:r,{name:"if",hash:{},fn:e.program(8,a,0,s,o),inverse:e.program(10,a,0,s,o),data:a}))?r:"")+'" min="1" /></td>\n            '+(null!=(r=i.if.call(l,null!=t?t.sub:t,{name:"if",hash:{},fn:e.program(12,a,0,s,o),inverse:e.noop,data:a}))?r:"")+"\n        </tr>\n    </table>\n"},6:function(e,t,i,n,a){return'checked="checked"'},8:function(e,t,i,n,a){return e.escapeExpression(e.lambda(null!=(e=null!=t?t.xbar:t)?e.num:e,t))},10:function(e,t,i,n,a){return"10"},12:function(e,t,i,n,a,s,o){return'<td>\n                <select class="xcast">\n                    <option></option>\n'+(null!=(a=i.each.call(null!=t?t:e.nullContext||{},null!=t?t.sub:t,{name:"each",hash:{},fn:e.program(13,a,0,s,o),inverse:e.noop,data:a}))?a:"")+"                </select>\n            </td>"},13:function(e,t,i,n,a,s,o){return"                    <option "+(null!=(i=(i.eq||t&&t.eq||i.helperMissing).call(null!=t?t:e.nullContext||{},null!=(i=null!=o[1]?o[1].xbar:o[1])?i.cast:i,t,{name:"eq",hash:{},fn:e.program(14,a,0,s,o),inverse:e.noop,data:a}))?i:"")+">"+e.escapeExpression(e.lambda(t,t))+"</option>\n"},14:function(e,t,i,n,a){return"selected"},compiler:[7,">= 4.0.0"],main:function(e,t,i,n,a,s,o){var r,l,d=null!=t?t:e.nullContext||{},c=i.helperMissing,u="function",p=e.escapeExpression;return'<label>\n    <input type="checkbox" '+(null!=(r=i.if.call(d,null!=t?t.checked:t,{name:"if",hash:{},fn:e.program(1,a,0,s,o),inverse:e.noop,data:a}))?r:"")+' class="checkbox"/>\n    <span>'+p(typeof(l=null!=(l=i.nameIn||(null!=t?t.nameIn:t))?l:c)==u?l.call(d,{name:"nameIn",hash:{},data:a}):l)+'</span>\n    <i>→</i>\n</label>\n<div class="user-input">\n    \x3c!-- <input class="nameout" value="'+p(typeof(l=null!=(l=i.nameOut||(null!=t?t.nameOut:t))?l:c)==u?l.call(d,{name:"nameOut",hash:{},data:a}):l)+'" '+(null!=(r=i.unless.call(d,null!=t?t.checked:t,{name:"unless",hash:{},fn:e.program(3,a,0,s,o),inverse:e.noop,data:a}))?r:"")+" /> --\x3e\n"+(null!=(r=i.if.call(d,null!=t?t.canXbar:t,{name:"if",hash:{},fn:e.program(5,a,0,s,o),inverse:e.noop,data:a}))?r:"")+"</div>"},useData:!0,useDepths:!0}),J.selectView=a.template({compiler:[7,">= 4.0.0"],main:function(e,t,i,n,a){return'<div class="searchRow"><input type="checkbox" /><input class="search" type="text" placeholder="search here..."/><span class="closeIcon fa fa-times"></span></div>\n<div class="rows"></div>'},useData:!0}),J.textInput=a.template({compiler:[7,">= 4.0.0"],main:function(e,t,i,n,a){var s;return'<input class="value-input" type="text" value="'+e.escapeExpression("function"==typeof(s=null!=(s=i.value||(null!=t?t.value:t))?s:i.helperMissing)?s.call(null!=t?t:e.nullContext||{},{name:"value",hash:{},data:a}):s)+'" />'},useData:!0}),J.transformTemplate=a.template({1:function(e,t,i,n,a){var s=null!=t?t:e.nullContext||{},o=i.helperMissing,r="function",l=e.escapeExpression;return"    t"+l(typeof(e=null!=(e=i.index||(null!=t?t.index:t))?e:o)==r?e.call(s,{name:"index",hash:{},data:a}):e)+": ej [`k;(select k:"+l(typeof(e=null!=(e=i.leftKey||(null!=t?t.leftKey:t))?e:o)==r?e.call(s,{name:"leftKey",hash:{},data:a}):e)+", "+l(typeof(e=null!=(e=i.selectParams||(null!=t?t.selectParams:t))?e:o)==r?e.call(s,{name:"selectParams",hash:{},data:a}):e)+" from t"+l(typeof(e=null!=(e=i.lefttable||(null!=t?t.lefttable:t))?e:o)==r?e.call(s,{name:"lefttable",hash:{},data:a}):e)+");(select k:"+l(typeof(e=null!=(e=i.rightKey||(null!=t?t.rightKey:t))?e:o)==r?e.call(s,{name:"rightKey",hash:{},data:a}):e)+", "+l(typeof(e=null!=(e=i.rightCols||(null!=t?t.rightCols:t))?e:o)==r?e.call(s,{name:"rightCols",hash:{},data:a}):e)+" from t"+l(typeof(e=null!=(e=i.righttable||(null!=t?t.righttable:t))?e:o)==r?e.call(s,{name:"righttable",hash:{},data:a}):e)+")];\n\n"},3:function(e,t,i,n,a){return null!=(a=(i.eq||t&&t.eq||i.helperMissing).call(null!=t?t:e.nullContext||{},null!=t?t.joinType:t,"union",{name:"eq",hash:{},fn:e.program(4,a,0),inverse:e.program(6,a,0),data:a}))?a:""},4:function(e,t,i,n,a){var s=null!=t?t:e.nullContext||{},o=i.helperMissing,r="function",l=e.escapeExpression;return"            t"+l(typeof(e=null!=(e=i.index||(null!=t?t.index:t))?e:o)==r?e.call(s,{name:"index",hash:{},data:a}):e)+":(select "+l(typeof(e=null!=(e=i.selectParams||(null!=t?t.selectParams:t))?e:o)==r?e.call(s,{name:"selectParams",hash:{},data:a}):e)+" from t"+l(typeof(e=null!=(e=i.lefttable||(null!=t?t.lefttable:t))?e:o)==r?e.call(s,{name:"lefttable",hash:{},data:a}):e)+") ,(select "+l(typeof(e=null!=(e=i.rightCols||(null!=t?t.rightCols:t))?e:o)==r?e.call(s,{name:"rightCols",hash:{},data:a}):e)+" from t"+l(typeof(e=null!=(e=i.righttable||(null!=t?t.righttable:t))?e:o)==r?e.call(s,{name:"righttable",hash:{},data:a}):e)+");\n"},6:function(e,t,i,n,a){return null!=(a=(i.eq||t&&t.eq||i.helperMissing).call(null!=t?t:e.nullContext||{},null!=t?t.joinType:t,"aj",{name:"eq",hash:{},fn:e.program(7,a,0),inverse:e.program(9,a,0),data:a}))?a:""},7:function(e,t,i,n,a){var s=null!=t?t:e.nullContext||{},o=i.helperMissing,r="function",l=e.escapeExpression;return"                t"+l(typeof(e=null!=(e=i.index||(null!=t?t.index:t))?e:o)==r?e.call(s,{name:"index",hash:{},data:a}):e)+": aj [`k;(select k:"+l(typeof(e=null!=(e=i.leftKey||(null!=t?t.leftKey:t))?e:o)==r?e.call(s,{name:"leftKey",hash:{},data:a}):e)+", "+l(typeof(e=null!=(e=i.selectParams||(null!=t?t.selectParams:t))?e:o)==r?e.call(s,{name:"selectParams",hash:{},data:a}):e)+" from t"+l(typeof(e=null!=(e=i.lefttable||(null!=t?t.lefttable:t))?e:o)==r?e.call(s,{name:"lefttable",hash:{},data:a}):e)+");(select k:"+l(typeof(e=null!=(e=i.rightKey||(null!=t?t.rightKey:t))?e:o)==r?e.call(s,{name:"rightKey",hash:{},data:a}):e)+", "+l(typeof(e=null!=(e=i.rightCols||(null!=t?t.rightCols:t))?e:o)==r?e.call(s,{name:"rightCols",hash:{},data:a}):e)+" from t"+l(typeof(e=null!=(e=i.righttable||(null!=t?t.righttable:t))?e:o)==r?e.call(s,{name:"righttable",hash:{},data:a}):e)+")];\n"},9:function(e,t,i,n,a){return null!=(a=(i.eq||t&&t.eq||i.helperMissing).call(null!=t?t:e.nullContext||{},null!=t?t.joinType:t,"upj",{name:"eq",hash:{},fn:e.program(10,a,0),inverse:e.program(12,a,0),data:a}))?a:""},10:function(e,t,i,n,a){var s=null!=t?t:e.nullContext||{},o=i.helperMissing,r="function",l=e.escapeExpression;return"                    t"+l(typeof(e=null!=(e=i.index||(null!=t?t.index:t))?e:o)==r?e.call(s,{name:"index",hash:{},data:a}):e)+": t"+l(typeof(e=null!=(e=i.lefttable||(null!=t?t.lefttable:t))?e:o)==r?e.call(s,{name:"lefttable",hash:{},data:a}):e)+" upsert (select "+l(typeof(e=null!=(e=i.rightCols||(null!=t?t.rightCols:t))?e:o)==r?e.call(s,{name:"rightCols",hash:{},data:a}):e)+" from t"+l(typeof(e=null!=(e=i.righttable||(null!=t?t.righttable:t))?e:o)==r?e.call(s,{name:"righttable",hash:{},data:a}):e)+");\n"},12:function(e,t,i,n,a){return null!=(a=(i.eq||t&&t.eq||i.helperMissing).call(null!=t?t:e.nullContext||{},null!=t?t.joinType:t,"pj",{name:"eq",hash:{},fn:e.program(13,a,0),inverse:e.program(15,a,0),data:a}))?a:""},13:function(e,t,i,n,a){var s,o=null!=t?t:e.nullContext||{},r=i.helperMissing,l="function",d=e.escapeExpression;return"                        t"+d(typeof(s=null!=(s=i.index||(null!=t?t.index:t))?s:r)==l?s.call(o,{name:"index",hash:{},data:a}):s)+":(select "+d(typeof(s=null!=(s=i.selectParams||(null!=t?t.selectParams:t))?s:r)==l?s.call(o,{name:"selectParams",hash:{},data:a}):s)+" from t"+d(typeof(s=null!=(s=i.lefttable||(null!=t?t.lefttable:t))?s:r)==l?s.call(o,{name:"lefttable",hash:{},data:a}):s)+") pj "+(null!=(e=typeof(s=null!=(s=i.plusJoin||(null!=t?t.plusJoin:t))?s:r)==l?s.call(o,{name:"plusJoin",hash:{},data:a}):s)?e:"")+" xkey t"+d(typeof(s=null!=(s=i.righttable||(null!=t?t.righttable:t))?s:r)==l?s.call(o,{name:"righttable",hash:{},data:a}):s)+";\n"},15:function(e,t,i,n,a){var s=null!=t?t:e.nullContext||{},o=i.helperMissing,r="function",l=e.escapeExpression;return"                        t"+l(typeof(e=null!=(e=i.index||(null!=t?t.index:t))?e:o)==r?e.call(s,{name:"index",hash:{},data:a}):e)+":(select k:"+l(typeof(e=null!=(e=i.leftKey||(null!=t?t.leftKey:t))?e:o)==r?e.call(s,{name:"leftKey",hash:{},data:a}):e)+", "+l(typeof(e=null!=(e=i.selectParams||(null!=t?t.selectParams:t))?e:o)==r?e.call(s,{name:"selectParams",hash:{},data:a}):e)+" from t"+l(typeof(e=null!=(e=i.lefttable||(null!=t?t.lefttable:t))?e:o)==r?e.call(s,{name:"lefttable",hash:{},data:a}):e)+" ) "+l(typeof(e=null!=(e=i.joinType||(null!=t?t.joinType:t))?e:o)==r?e.call(s,{name:"joinType",hash:{},data:a}):e)+" (`k xkey select k:"+l(typeof(e=null!=(e=i.rightKey||(null!=t?t.rightKey:t))?e:o)==r?e.call(s,{name:"rightKey",hash:{},data:a}):e)+", "+l(typeof(e=null!=(e=i.rightCols||(null!=t?t.rightCols:t))?e:o)==r?e.call(s,{name:"rightCols",hash:{},data:a}):e)+" from t"+l(typeof(e=null!=(e=i.righttable||(null!=t?t.righttable:t))?e:o)==r?e.call(s,{name:"righttable",hash:{},data:a}):e)+");\n"},compiler:[7,">= 4.0.0"],main:function(e,t,i,n,a){return null!=(a=(i.eq||t&&t.eq||i.helperMissing).call(null!=t?t:e.nullContext||{},null!=t?t.joinType:t,"ej",{name:"eq",hash:{},fn:e.program(1,a,0),inverse:e.program(3,a,0),data:a}))?a:""},useData:!0}),J.updateDialog=a.template({compiler:[7,">= 4.0.0"],main:function(e,t,i,n,a){return'\n\n<div class="update-table">\n    <div class="transformUpdateNewRow"> update field  </div>\n    <div class="transformUpdate">\n        <div class="updaterColumnsList"></div>\n    </div>\n</div>\n<div class="where-table"></div>'},useData:!0}),J.updateRow=a.template({compiler:[7,">= 4.0.0"],main:function(e,t,i,n,a){var s=null!=t?t:e.nullContext||{},o=i.helperMissing,r="function",l=e.escapeExpression;return'<div class="updaterRow" id ="updaterRow-'+l(typeof(e=null!=(e=i.id||(null!=t?t.id:t))?e:o)==r?e.call(s,{name:"id",hash:{},data:a}):e)+'" data-id="'+l(typeof(e=null!=(e=i.id||(null!=t?t.id:t))?e:o)==r?e.call(s,{name:"id",hash:{},data:a}):e)+'">\n    <div class="col1">\n        <input class="updaterCheckbox" type="checkbox" checked/>\n\n        <select class="updaterColumnDDL"> </select>\n    </div>\n    <div class="col2">\n        <span class="updateText" >set:</span>\n\n\n        <div class="updaterColumSelection">&nbsp;</div>\n        <div class="updaterTrash">&nbsp;</div>\n    </div>\n</div>'},useData:!0}),J);function J(){}a.registerHelper("type-cast",function(e){return e.toLowerCase()});var q,U=(q=l.View,f(z,q),z.prototype.addParam=function(e,t,i,n,a,s,o){var r=this,o=new l.Model({id:_.uniqueId("param_"),name:e,type:t,value:i,required:n,description:a,editable:!0,isViewState:o});this.listenTo(o,"change",function(){return r.updateValue()});o=new z(o,this.dataModel,this.docViewModel,this.vsCallback,this.save,this.useViewStates,[]);this.listenTo(o,"paramRemoved",this.onParamRemoved.bind(this)),this.listenTo(o,"ValueChanged",function(){return r.updateValue()}),o.$el.appendTo(this.$listItems),this.parameters.push(o),s||this.updateValue()},z.prototype.initializeEvents=function(){var e=this;this.listenTo(this.model,"change:type",this.onTypeChanged.bind(this)),this.listenTo(this.model,"change:name",function(){e.updateValue()}),this.$viewStateApply.on("click",this.showViewStateDialog.bind(this)),this.$bindingApply.on("click",this.showBindingsDropdown.bind(this)),this.$viewStateDisplay.on("click",this.showViewStateDialog.bind(this)),this.$viewStateClear.on("click",this.onViewStateClear.bind(this)),this.$generateValue.on("click",this.generateViewState.bind(this)),this.$bindingClear.on("click",this.onBindingClear.bind(this)),this.$typeSelect.on("change",this.onTypeChange.bind(this)),this.$nameInput.on("change",this.onNameChange.bind(this))},z.prototype.applyControlState=function(){this.model.get("isViewState")?this.$form.addClass("is-bound"):this.$form.removeClass("is-bound")},z.prototype.disableListEditing=function(){this.$buttonRow.hide(),this.$listItems.hide()},z.prototype.enableListEditing=function(){"dict"===this.model.get("type")&&(this.$buttonRow.show(),this.$listItems.show())},z.prototype.getPath=function(){var e=this.dataModel.path;return e.substring(e.lastIndexOf("/")+1)+"/"+this.model.get("name")},z.prototype.getInputValue=function(){var e=this.valueInput.getValue()||"";return _.isString(e)?e.replace("&lt;","<").replace("&gt;",">"):e},z.prototype.generateViewState=function(){var i,n=this,a=this.docViewModel;this.viewStateName=this.getPath();var s=this.viewStateName.split("/")||[];return s.forEach(function(e,t){t===s.length-1?(a.has(e)||(i=new c.DocumentViewModel({_viewType:!0,_type:n.model.get("type").toLowerCase(),_default:n.model.get("value"),value:n.model.get("value")},null),a.set(e,i)),n.selectGeneratedViewState(n.viewStateName)):(a.has(e)||(t=new c.DocumentViewModel({},null),a.set(e,t)),a=a.getByPath(e))}),i},z.prototype.onAddItemClicked=function(){this.addParam("parameter0","symbol","",!1,"")},z.prototype.onNameChange=function(){var e=this.$nameInput.val();this.model.set({name:e})},z.prototype.onParamRemoved=function(e){this.parameters=_.without(this.parameters,e),this.updateValue()},z.prototype.onSelectViewState=function(e){var t=this.docViewModel.getByPath(e);t?t&&t.has("_type")&&(this.model.set("type",t.get("_type")),this.model.set("isViewState",!0),this.model.set("value","<%"+e+"%>"),this.$viewStateInput.val(e),this.$viewStateDisplay.val(e),this.applyControlState(),this.disableListEditing(),this.trigger("ValueChanged"),this.save()):this.onViewStateClear()},z.prototype.onTypeChange=function(){var e=this.$typeSelect.val();"dict"===e?this.model.set({value:{},type:e}):this.model.set({type:e}),this.save()},z.prototype.onTypeChanged=function(){var t,e,i=this,n=this.model.get("type");_.each(this.parameters,function(e){e.remove()}),this.parameters=[],this.$el.attr("data-type",n),this.$typeSelect.val(n).trigger("change"),"dict"===n?(this.enableListEditing(),this.removeValueInput(),this.$bindingApply.hide(),"string"==typeof(e=this.model.get("value")||this.originalValue)?(n=e.split(""),_.each(n,function(e){6===(t=e.split("")).length&&i.addParam(t[0],t[1],t[2],t[3],t[4],!1)})):"object"==typeof e&&_.each(e,function(t){try{i.addParam(t.name,t.type,t.value,!1,"",void 0,!!_.isString(t.value)&&0===t.value.indexOf("<%"))}catch(e){console.error("Param error ",t)}})):(this.disableListEditing(),this.renderInput()),this.trigger("ValueChanged")},z.prototype.onViewStateClear=function(){this.model.set("isViewState",!1),this.model.set("value",null),this.$viewStateInput.val(""),this.applyControlState(),this.$generateValue.removeClass("disabled"),this.enableListEditing(),this.trigger("ValueChanged"),this.save()},z.prototype.onBindingClear=function(){this.model.set("isViewState",!1),this.model.set("value",""),this.$viewStateInput.val(""),this.applyControlState(),this.$generateValue.removeClass("disabled"),this.$bindingApply.show(),this.$valueInput.show(),this.$typeSelect.prop("disabled",!1),this.enableListEditing(),this.trigger("ValueChanged"),this.save()},z.prototype.onValueInput=function(){this.model.set({value:this.getInputValue(),isViewState:!1}),this.trigger("ValueChanged"),this.save()},z.prototype.remove=function(){return _.each(this.parameters,function(e){e.remove()}),this.parameters=[],this.trigger("paramRemoved",this),l.View.prototype.remove.apply(this)},z.prototype.removeValueInput=function(){this.valueInput&&(this.stopListening(this.valueInput),this.valueInput.remove(),this.valueInput=null)},z.prototype.renderInput=function(){var e,t=this;this.removeValueInput(),this.$valueInput.empty();var i=this.model.get("type");i&&(e=r.RTTI.getByName(i),i=r.editors[e.editor.type],this.valueInput=new i({id:_.uniqueId("valueInput_"),key:"value",model:this.model,schema:{editorClass:"data-parameter-editor",options:e.editor.options,validators:e.editor.validators}}).render(),this.$valueInput.append(this.valueInput.el),this.model.get("isViewState")||this.model.get("value")===this.getInputValue()||this.onValueInput()),this.listenTo(this.valueInput,"change changeList",function(){var e=t.valueInput.validate();e?t.setError(e.message):(t.setError(null),t.onValueInput())})},z.prototype.selectGeneratedViewState=function(e){this.onSelectViewState(e),this.$generateValue.addClass("disabled")},z.prototype.setError=function(e){e&&this.valueInput?(this.valueInput.$el.addClass("error"),this.$errorTooltip&&r.ErrorTooltip.clear(this.$errorTooltip),this.$errorTooltip=r.ErrorTooltip.show(e,this.$valueInput)):(this.valueInput.$el.removeClass("error"),r.ErrorTooltip.clear(this.$errorTooltip))},z.prototype.showViewStateDialog=function(){var t=this;this.vsCallback({beforeClose:function(){},close:function(){},cancelCallback:function(){},path:this.$viewStateInput.val(),selectCallback:function(e){return t.onSelectViewState(e)}})},z.prototype.showBindingsDropdown=function(e,t){this.$valueInput.hide(),this.$bindingApply.hide(),this.model.set("isViewState",!0),this.applyControlState(),this.vsCallback(this,e,t)},z.prototype.updateValue=function(e){var t;"dict"===this.model.get("type")&&(t={},_.each(this.parameters,function(e){t[e.model.get("name")]={type:e.model.get("type"),IsKdbParam:!0,isViewState:e.model.get("isViewState"),name:e.model.get("name"),value:e.model.get("value")}}),this.model.set({value:t},{silent:e})),e||this.trigger("ValueChanged"),console.log("update value:",this.model.get("value"))},z);function z(e,t,i,n,a,s,o){void 0===s&&(s=!1);var r=q.call(this,{className:"data-parameter",model:e})||this;return r.parameters=[],r.viewStateName="",r.originalValue=r.model.get("value"),r.useViewStates=s,r.model.set({type:r.model.get("type").toLowerCase()},{silent:!0}),r.model=e,r.docViewModel=i,r.dataModel=t,r.vsCallback=n,r.save=a,r.$el.html(F.dataParameter(r.model.toJSON())),r.$form=r.$(".form-control"),r.$viewStateApply=r.$(".viewstate-apply"),r.$bindingApply=r.$(".binding-apply-dialog"),r.$bindingSelect=r.$(".binding-select"),r.$bindingDropdown=r.$(".binding-dropdown"),r.$viewStateClear=r.$(".binding-clear"),r.$bindingClear=r.$(".binding-clear-dialog"),r.$viewStateContainer=r.$(".binding-container"),r.$viewStateInput=r.$("input:not(.name-input)").attr("type","text"),r.$viewStateDisplay=r.$(".value-display"),r.$valueInput=r.$(".value-input"),r.$generateValue=r.$(".generate-value"),r.$typeSelect=r.$(".type-select"),r.$typeSelect.val(r.model.get("type")),r.$addItemBtn=r.$(".add-item-btn"),r.$listItems=r.$(".list-items"),r.$buttonRow=r.$(".button-row"),r.$nameInput=r.$(".name-input"),r.$removeItemBtn=r.$(".remove-item-btn"),r.$addItemBtn.button({icons:{primary:"fa fa-plus"},text:!1}).click(r.onAddItemClicked.bind(r)),0<r.$removeItemBtn.length&&r.$removeItemBtn.button({icons:{primary:"fa fa-minus"},text:!1}).click(r.remove.bind(r)),o.length&&r.$typeSelect.find("option").filter(function(e,t){return!_.includes(o,t.text)}).remove(),r.$typeSelect.select2({theme:"dashboards",width:"100%"}),r.$bindingSelect.select2({theme:"dashboards",width:"100%"}),r.useViewStates&&r.model.get("isViewState")&&r.model.get("value")?r.onSelectViewState(r.model.get("value").split("%")[1]):"dict"!==r.model.get("type")&&r.valueInput&&r.valueInput.setValue(r.model.get("value")),r.onTypeChanged(),_.defer(function(){r.initializeEvents()}),r}var H,K=(H=l.View,f(G,H),G.prototype.remove=function(){return this.$el.off(),l.View.prototype.remove.call(this)},G.prototype.addDataParameter=function(e,t){t=_.isEmpty(t)||t.type!==this.model.get("type")?_.reduce(this.model.attributes,function(e,t,i){return _.includes(["parameters","operator"],i)||(e[i]=t),e},{}):t;"long"===t.type&&_.isNil(t.value)&&(t.value=(new Date).getFullYear());t=new U(new l.Model(_.extend({},t)),this.dataModel,this.docViewModel,this.vsCallback,this.save,this.useViewStates,[]);this.parameters.push(t),e?(t.$el.find(".col1").text(e).show(),t.$el.find(".col3").addClass("has-label")):(t.$el.find(".col1").hide(),t.$el.find(".col3").removeClass("has-label")),this.$dataParams.append(t.$el)},G.prototype.clearDataParameters=function(){this.parameters=[],this.$dataParams.empty()},G.prototype.onOperatorChange=function(e){var t=this.parameters;switch(this.operator=e.target.value,this.clearDataParameters(),this.operator){case"in":this.model.set("type","list"),this.addDataParameter("",t&&t[0]);break;case"within":this.model.set("type",this.type),this.addDataParameter("Min:",t&&t[0]),this.addDataParameter("Max:",t&&t[1]);break;default:this.model.set("type",this.type),this.addDataParameter("",t&&t[0])}this.save()},G);function G(e,t,i,n,a,s){void 0===s&&(s=!1);var o=H.call(this,{model:e})||this;return o.parameters=[],o.operator="",o.dataModel=t,o.docViewModel=i,o.vsCallback=n,o.save=a,o.useViewStates=s,o.type=e.get("type"),o.name=e.get("name"),o.operator=e.get("operator"),o.parameters=e.get("parameters"),o.$el.addClass("partition-view"),o.$el.html(F.partitionView({})),o.$dataParams=o.$el.find(".data-parameter-container"),o.$operatorSelect=o.$el.find(".operator-select"),o.$operatorSelect.select2({theme:"dashboards",width:"100%"}),o.$operatorSelect.on("change",o.onOperatorChange.bind(o)),o.$operatorSelect.val(o.operator||"equals").trigger("change"),o}var Q,W=(Q=l.View,f(Y,Q),Y.prototype.createAccordion=function(e){this.$el.addClass("accordion"),this.accordion=new i.AccordionView({el:this.$el[0],sections:_.map(e,function(e){return{$el:e.$el,viewModel:new l.Model(_.extend({align:"left",order:0},_.omit(e,["$el"])))}})})},Y.prototype.createDataFilter=function(e){var n=this,t=_.noop.bind(this),a=this.filterSettings,i=this.dfId;this.dataFilter=new s({viewModel:new c.DocumentViewModel({},{}),settingsModel:a,dashboardAppModel:this.host.dashboardAppModel,el:e,deltaClient:null,api:{getProperty:function(e){return a.get(e)},getPropertyMeta:function(e){return a.get(e)},setProperty:function(e,t){var i={};a.set(e,t),i[e]=t,n.dataFilter&&n.dataFilter.onSettingsChange(i),"Basics.kdbString"===e&&n.$sideDialog&&n.save()},renderViewStateDialog:this.host.renderViewStateDialog.bind(this),hideErrorMessage:t,showErrorMessage:t,showQueryStatus:t,hideQueryStatus:t,subscribe:function(e,t){e.subscribe(i,{key:i,onData:t,source:e})},unsubscribe:function(e){e.unsubscribe(i)},loadSetting:t,saveSetting:t}}),this.dataFilter.onSettingsChange(a.attributes)},Y.prototype.initializeDataFilter=function(){this.dfId=_.uniqueId("popup-df"),this.filterSettings=new l.DeepModel(_.extend({},s.getComponentDefinition({settingsModel:new l.DeepModel}).appArgs.json))},Y.prototype.initialSave=function(){_.isEmpty(this.node.data)&&this.save()},Y.prototype.onResize=function(){this.accordion&&this.accordion.resize(),this.dataFilter&&this.dataFilter.onResize()},Y.prototype.remove=function(){return this.$el.dialog&&this.$el.hasClass("ui-dialog-content")&&this.$el.dialog("destroy"),this.aggView&&this.aggView.remove(),this.selectView&&this.selectView.remove(),this.dataFilter&&(this.dataFilter.remove(),delete this.dataFilter),l.View.prototype.remove.call(this)},Y.prototype.removeVSChars=function(e){return _.isString(e)?e.replace(w.VSRx,function(e){return e.substring(2,e.length-2)}):e},Y.prototype.renderDialog=function(e,t,i,n,a,s,o){this.$sideDialog?this.renderSideDialog(n,i,o):this.renderPopupDialog(s,e,t,i,n,a)},Y.prototype.renderFilter=function(e){var t=new c.DocumentDataModel({_dataType:"copy",_dataSource:"kdb",_maxRows:2e3,_subscriptionType:"static",_pageSize:2e3,_serverPaging:!1},null,"",null);t.apply(),this.filterSettings.set({"Basics.data":t,"Basics.UseViewStates":this.host.api.getProperty("Basics.UseViewStates"),Bindings:this.host.api.getProperty("Bindings")}),this.createDataFilter(e),t.onExecuteSuccess({class:"203",columns:_.keys(this.parent.meta),meta:this.parent.meta,rows:[]},!0)},Y.prototype.renderFromParentMeta=function(e,t){t=t||this.parent;t&&!t.meta?this.host.updateMeta(t,e.bind(this)):t&&e(t.meta)},Y.prototype.renderPopupDialog=function(e,i,n,a,s,o){var r=this;this.$el.dialog({dialogClass:e,height:i,width:n,modal:!0,autoOpen:!0,title:this.node.teaser(),buttons:[{text:t(this.node.id?"Apply":"Create"),click:function(){a(),r.$el.dialog("close")},icons:{primary:"fa fa-save"}},{text:t("Cancel"),click:function(){r.$el.dialog("close")},icons:{primary:"fa fa-times"}}],open:function(){$('<i class="dialog-icon">'+r.node.icon()+"</i>").insertBefore(r.$el.parent().find(".ui-dialog-title")),s()},close:function(){return r.host.onCloseDialog()},resize:o})},Y.prototype.renderSideDialog=function(e,t,i){var n;i&&((n=document.createElement("div")).className=i,n.append(this.$el[0])),this.host.renderSideDialog(i?$(n):this.$el,this.node,t,e)},Y.prototype.save=function(){this.$sideDialog&&this.host.api.getProperty("Basics.AutoSave")&&this.saveClickHandler()},Y.prototype.saveClickHandler=function(){},Y.prototype.setNode=function(e){this.node=e||this.node},Y.PROP_QUERYMODEL="Basics.queryModel",Y);function Y(e,t,i,n,a){var s=Q.call(this)||this;return s.host=e,s.node=t,s.parent=i&&0<i.length?i[0]:void 0,s.parents=i,s.callback=n,s.$sideDialog=a,s}var X,Z=(f(ee,X=W),ee.prototype.onResize=function(){this.accordion.sections[1].viewModel.get("isExpanded")&&this.setAccordionWeights(!0),X.prototype.onResize.call(this)},ee.prototype.saveClickHandler=function(){_.debounce(this.saveClick.bind(this),300)()},ee.prototype.createJsTreeJSON=function(e,t,i){return this.getJsTreeJSON(e,t,{selected:e===this.selectedDatasource},[],i)},ee.prototype.getAccordionWeights=function(e){var t=1,i=1,n=this.$el.find(".form-control").height()||1,a=this.$el.height()||1;return(e&&_.every(this.selectedParams,function(e){return"dict"!==e.type})||!_.isEmpty(this.selectedPartition))&&(e=45/a,a=n/a,t=1-(i=(this.selectedParams.length||(this.selectedPartition instanceof K?this.selectedPartition.model.get("parameters")?this.selectedPartition.model.get("parameters").length:1:this.selectedPartition.parameters?this.selectedPartition.parameters.length:1))*a+e)),[t,i]},ee.prototype.getJsTreeJSON=function(e,t,i,n,a){return{id:e,text:t,state:i,children:n,type:a}},ee.prototype.hideError=function(){this.$el.find(".data-error").hide()},ee.prototype.initParameters=function(e){var t,i=e&&"analytic"===e.type&&0===e.children.length,n=e&&"partition"===e.type,a=e&&"streaming"===e.type;i?(e=this.updateSourceObject(this.analytics,"parameters",this.selectedParams,function(e,t){return _.isEqual(e.parameters.map(function(e){return e.name}),t.map(function(e){return e.name}))}.bind(this)),this.loadSelectedParameters(e)):n?(t=this.updateSourceObject(this.partitions,"partition",this.selectedPartition,function(e,t){return e.name===t.name}.bind(this)),this.loadSelectedPartition(t)):a?(t=this.updateSourceObject(this.streams,"parameters",this.selectedParams,function(e,t){return _.isEqual(e.parameters.map(function(e){return e.name}),t.map(function(e){return e.name}))}.bind(this)),this.loadSelectedParameters(t)):(this.selectedParams=[],this.selectedPartition={}),this.toggleParamsView(n||(i||a)&&0<this.selectedParams.length)},ee.prototype.jstreeSearch=function(e){this.$tree.jstree("show_all"),this.$tree.jstree().search(e)},ee.prototype.loadSelectedParameters=function(i){var n=this;this.setParamHTML("","Parameters"),this.selectedParams=[],this.selectedPartition={},_.each(i.parameters,function(e){var t=new U(new l.Model(_.extend({},e)),n.host.docDataModel,n.host.docViewModel,n.vsCallback.bind(n),n.save.bind(n),n.host.api.getProperty("Basics.UseViewStates"),"streaming"===i.type?["symbol","list"]:[]);n.showBindingsDropdown(e,t),n.$el.find(".paramList").append(t.$el),n.selectedParams.push(t.model.attributes)}),this.save()},ee.prototype.loadSelectedPartition=function(e){e=new K(new l.Model(_.extend({},e.partition)),this.host.docDataModel,this.host.docViewModel,this.vsCallback.bind(this),this.save.bind(this),this.host.api.getProperty("Basics.UseViewStates"));this.setParamHTML(e.el,"Partition ("+("long"===e.model.get("type")?"year":e.model.get("type"))+")"),this.showBindingsDropdown(this.selectedPartition,e),this.selectedPartition=e,this.selectedParams=[]},ee.prototype.renderSources=function(e,t,i){var n=function(e,t){return e[t.name]=t,e},a=_.reduce(i,n,{}),n=_.reduce(t,n,{});this.analytics=_.union(this.analytics,t),this.partitions=_.filter(i,function(e){return"partition"===e.type});n=_.extend(e,a,n);this.renderTree(n)},ee.prototype.renderTree=function(e){var d=this,c=[];_.each(e,function(e,t){var a,i,s,o,r,l,n;e.type?(a=e.type,i=t,s=_.filter(i.split("."),function(e){return""!==e}),o=1===s.length&&i==="."+s[0],r=1<s.length||o?".":"",l=c,_.each(s,function(e,t){var i=r+e,n=_.find(l,function(e){return e.id===i});l=n?n.children:(t={id:i,text:(t!==s.length-1||o?".":"")+e,state:{selected:i===d.selectedDatasource},children:[],type:t===s.length-1?a:"namespace"},l.push(t),t.children),r=i+"."})):(n=c.push(d.createJsTreeJSON(t,t,e instanceof Array?"namespace":e.streaming?"streaming":"analytic")),e instanceof Array&&_.each(e,function(e){c[n-1].children.push(d.createJsTreeJSON(e.name,e.name,e.streaming?"streaming":"analytic"))}))}),this.$tree.jstree({core:{data:this.sortTreeData(c),multiple:!1},conditionalselect:function(e){return 0===e.children.length},types:{table:{icon:"fa fa-table"},partition:{icon:"fa fa-table"},analytic:{icon:"fa fa-line-chart"},namespace:{icon:"fa fa-folder"},streaming:{icon:this.host.isLite?"fa fa-table streaming-icon":"fa fa-line-chart streaming-icon"}},search:{show_only_matches:!0,show_only_matches_children:!0},plugins:["conditionalselect","types","search","wholerow"]}),this.$tree.on("select_node.jstree",function(e,t){d.selectedDatasource=t.node.id,d.showScrollBars(!1),d.initParameters(t.node),d.save()}),this.$tree.on("deselect_node.jstree",function(){d.selectedDatasource="",d.initParameters(),d.save()}),this.$tree.on("search.jstree",function(e,t){0===t.nodes.length&&d.$tree.jstree("hide_all")}),this.$tree.one("ready.jstree",function(){var e;_.isString(d.selectedDatasource)&&(e=d.selectedDatasource.replace(/\./g,"\\."),(e=d.$tree.find("#"+e)[0])&&(d.$tree[0].scrollTop=e.offsetTop-d.$tree[0].offsetTop,d.initParameters(d.$tree.jstree().get_selected(!0)[0])))})},ee.prototype.renderWithQStructures=function(n){var a=this;this.host.runAnalytic(".queryBuilder.getTables",null,1e3,function(e){a.hideError();var t,i=e.rows.map(function(e){return e.partition?(e.type="partition",e.partition={type:"year"===e.partition?"long":e.partition,name:e.name}):e.streaming?(e.type="streaming",e.parameters=[{name:"x",type:"Symbol"}],a.streams.push(e)):e.type="table",e});a.host.isLite?a.host.runAnalytic(t=".queryBuilder.getFunctions",null,1e3,function(e){e=_.map(a.parent?_.filter(e.rows,function(e){return 0<e.parameters.rows.length}):e.rows,function(e){return e.parameters=a.parent?e.parameters.rows.slice(1):e.parameters.rows,e.type="analytic",e});a.renderSources({},e,i)},function(){console.log("Failed to execute "+t),a.renderTree(n)}):a.renderSources(n,[],i)},function(){console.log("Failed to execute .queryBuilder.getTables"),a.showError(a.host.isLite?'Please run "\\l querybuilder.q" to load query builder on this connection':"No data sources loaded; query builder may not be properly configured on this connection"),a.renderTree({})})},ee.prototype.runTreeQuery=function(){var n=this;this.host.isLite?this.renderWithQStructures({}):c.DeltaClientLib.getDeltaAnalytics(function(e){n.analytics=_.map(n.parent?_.filter(e,function(e){return 0<e.parameters.length}):e,function(e){return e.parameters=n.parent?e.parameters.slice(1):e.parameters,e});e=_.reduce(n.analytics,function(t,e){var i={name:e.name,streaming:e.streaming};return e.streaming&&n.streams.push(e),0<e.groups.length?_.each(e.groups,function(e){t[e]||(t[e]=[]),t[e].push(i)}):t[e.name]=i,t},{});n.renderWithQStructures(e)})},ee.prototype.saveClick=function(){var e,t=this;0<this.selectedParams.length?this.node.data={name:this.selectedDatasource,params:this.selectedParams}:_.isEmpty(this.selectedPartition)?this.node.data=this.selectedDatasource:(e={name:this.selectedPartition.name,operator:this.selectedPartition.operator,type:this.selectedPartition.type,parameters:this.selectedPartition.parameters.map(function(e){return e.model.attributes})},this.node.data={name:this.selectedDatasource,partition:e}),_.isEmpty(this.selectedDatasource)||(_.some(this.streams,function(e){return e.name===t.selectedDatasource})?this.node.group="stream":_.some(this.analytics,function(e){return e.name===t.selectedDatasource})?this.node.group="function":this.node.group="data"),this.host.refreshSideDialogHeader(this.node),this.callback&&this.callback(this.node)},ee.prototype.setAccordionWeights=function(e){var i=this,e=this.getAccordionWeights(e);_.each(e,function(e,t){return i.accordion.sections[t].viewModel.set("weight",e)})},ee.prototype.setParamHTML=function(e,t){this.$el.find(".paramList").html(e),this.$el.find(".paramTitle").html(t)},ee.prototype.setParamValue=function(e,t,i){e.$bindingSelect.val(t).trigger("change"),e.model.set({value:_.isEmpty(i)?t:i}),this.save()},ee.prototype.showAllDropdowns=function(a,e){var s=this;_.each(e,function(t,e){var i,n="";"string"==typeof a.value?(i=a.value.split(""),n=(i=_.find(_.map(i,function(e){return e.split("")}),function(e){return e[0]===t.model.get("name")}))&&i[2]?i[2]:""):a.value?n=a.value[t.model.get("name")]:a.parameters&&(n=a.parameters[e].value),s.showBindingsDropdown(n,t)})},ee.prototype.showBindingsDropdown=function(e,t){var i=e.value||e;0===this.host.api.getProperty("Bindings").length?this.host.api.getProperty("Basics.UseViewStates")?(t.$el.find(".binding-dropdown").hide(),t.$el.find(".binding-clear-dialog").hide()):t.$el.find(".binding-container").hide():t instanceof U&&_.isString(i)&&w.VSRx.test(i)?t.showBindingsDropdown(void 0,i):0<t.parameters.length&&this.showAllDropdowns(e,t.parameters)},ee.prototype.showError=function(e){var t=this.$el.find(".data-error");t.find("span").text(e),t.show()},ee.prototype.showScrollBars=function(e){this.$paramsView.find(".paramList").toggleClass("hide-scrollbar",!e)},ee.prototype.sortTreeData=function(e){function t(e,t){return e.children.length&&!t.children.length?-1:t.children.length&&!e.children.length?1:e.type===t.type?e.id.localeCompare(t.id):"analytic"===e.type||"analytic"!==t.type&&"streaming"===e.type?-1:1}var i=function(e){return _.each(e,function(e){e.children.length&&i(e.children)}),e.sort(t)};return i(e)},ee.prototype.toggleParamsView=function(e){this.accordion.sections[1].viewModel.set("isExpanded",e),this.setAccordionWeights(e),this.debouncedShowScrollBars(!0)},ee.prototype.updateSourceObject=function(e,t,i,n){var a=_.find(e,{name:this.selectedDatasource}),e=((e={name:this.selectedDatasource})[t]=i,e);return a?n(a,i)&&(i=i instanceof K?i.model.attributes:i,a=_.extend(a,((n={name:this.selectedDatasource})[t]=i,n))):a=e,a},ee.prototype.vsCallback=function(t,e,i){var n,a=this;this.host.api.getProperty("Basics.UseViewStates")?this.host.renderViewStateDialog(t):(n=t.model.get("type"),t.$bindingSelect.empty().trigger("change"),n=this.host.getAllMatchingBindings(n),_.each(n,function(e){e=new Option(e.Key);t.$bindingSelect.append(e).trigger("change")}),t.$bindingSelect.on("select2:select",_.bind(function(e){t.model.set({value:"<%"+e.params.data.text+"%>"}),a.save()},t)),_.isUndefined(i)?0<n.length&&this.setParamValue(t,n[0].Key,"<%"+n[0].Key+"%>"):this.setParamValue(t,this.removeVSChars(i),i))},ee);function ee(e,t,i,n,a){var s=X.call(this,e,t,i?[i]:void 0,n,a)||this;s.streams=[],s.selectedDatasource="",s.selectedParams=[],s.partitions=[],s.$el.html(F.dataDialog({})),s.$paramsView=s.$el.find(".paramsView"),s.$treeView=s.$el.find(".treeView"),s.$tree=s.$el.find(".tree"),s.$search=s.$el.find(".searchBox"),s.$clearSearch=s.$el.find(".clearSearch"),null!==t.data&&(s.selectedDatasource=s.node.data.name||s.node.data||"",s.selectedParams=s.node.data.params||[],s.selectedPartition=s.node.data.partition||{}),s.debouncedShowScrollBars=_.debounce(s.showScrollBars.bind(s),300);t=s.host.api.getProperty("Basics.UseViewStates")?" qb-use-viewstates":0<s.host.api.getProperty("Bindings").length?" qb-use-bindings":" qb-no-bindings";s.renderDialog(450,700,s.saveClick.bind(s),function(){var e=s.getAccordionWeights(0<s.selectedParams.length);s.createAccordion([{$el:s.$treeView,heading:"Data sources",hideHeader:!0,isExpanded:!0,isResizeable:!0,weight:e[0]},{$el:s.$paramsView,heading:"Parameters",hideHeader:!0,isExpanded:0<s.selectedParams.length,weight:e[1]}]),s.runTreeQuery(),setTimeout(function(){s.$tree.children().length||s.showError("No data sources loaded; check that the connection's process is running")},1e3)}.bind(s),function(){s.accordion&&s.accordion.resize()},"qb-data-dialog"+t,"qb-data-dialog"+t);var o=_.debounce(s.jstreeSearch.bind(s),250);return s.$search.keyup(function(e){e=e.target.value;s.$clearSearch.toggle(""!==e),o(e)}),s.$clearSearch.click(function(){s.$search.val("").trigger("keyup")}),s.initialSave(),s}var te,ie=(te=l.View,f(ne,te),ne.prototype.disable=function(e){this.$input.prop("disabled",e)},ne.prototype.remove=function(){return this.$el.off(),l.View.prototype.remove.call(this)},ne);function ne(e,t){e=te.call(this,{el:e})||this;return e.$el.addClass("text-input"),e.$el.html(F.textInput({value:t})),e.$input=e.$el.find(".value-input"),e}var ae=function(e,t,i){this.cast=e,this.checkbox=t,this.num=i},se=(oe.prototype.check=function(e){var t;this.checkbox.checked=e,this.nameOut.disable(!e),this.xbar&&(t=this.xbar.checkbox.checked,this.xbar.cast&&(this.xbar.cast.disabled=!e||!t),this.xbar.checkbox.disabled=!e,this.xbar.num.disabled=!e||!t),this.userInput.style.display=e?"block":"none"},oe.prototype.isChecked=function(){return!!this.checkbox.checked},oe.prototype.nameOutVal=function(){var e=this.nameOut.el;return $(e).hasClass("useBinding")?"<%"+$(e).find(".binding-select").val()+"%>":$(e).hasClass("useViewState")?"<%"+$(e).find(".viewstate-display").val()+"%>":$(e).find("input[type=text]").val()},oe.prototype.value=function(){var e;return this.xbar&&this.xbar.checkbox.checked?{col:this.col,cast:(null===(e=this.xbar.cast)||void 0===e?void 0:e.value)||"",num:this.xbar.num.value}:this.col},oe.prototype.onChecked=function(){this.check(this.isChecked()),this.changeCallback()},oe.prototype.onXBarChecked=function(){var e;this.xbar&&(e=this.xbar.checkbox.checked,this.xbar.num.disabled=!e,this.xbar.cast&&(this.xbar.cast.disabled=!e)),this.changeCallback()},oe.SUBTYPES=((a={})[c.ipc.TypeNum.Timestamp]=oe.DATETIME_SUBTYPES=["year","month","date","minute","second","mm","dd","hh","uu","ss"],a[c.ipc.TypeNum.Date]=["year","month","mm","dd"],a[c.ipc.TypeNum.DateTime]=oe.DATETIME_SUBTYPES,a[c.ipc.TypeNum.Timespan]=oe.DATETIME_SUBTYPES,a[c.ipc.TypeNum.Time]=["minute","second","hh","uu","ss"],a),oe);function oe(e,t,i,n,a,s,o){this.el=document.createElement("div"),this.el.className="row",this.el.setAttribute("data-id",e),this.col=e,this.changeCallback=n,this.el.innerHTML=F.selectRow({checked:i,nameIn:e,nameOut:t,canXbar:a,xbar:o||{},sub:oe.SUBTYPES[s]}),this.userInput=this.el.querySelector(".user-input"),this.nameOut=new ie(document.createElement("div"),t),this.userInput.prepend(this.nameOut.el),this.checkbox=this.el.querySelector(".checkbox"),a&&(this.xbar=new ae(this.el.querySelector(".xcast"),this.el.querySelector(".xcheckbox"),this.el.querySelector(".xnum")),this.xbar.checkbox.addEventListener("change",this.onXBarChecked.bind(this))),this.check(this.isChecked()),this.checkbox.addEventListener("change",this.onChecked.bind(this)),this.nameOut.el.addEventListener("change",this.changeCallback)}var re,le=(re=l.View,f(de,re),de.isScalar=function(e){var t=c.ipc.TypeNum;return t.Byte<=e&&e<=t.Char||t.Timestamp<=e&&e<=t.Time},de.prototype.getValue=function(){var n=this,a={};return this.$el.find(".row").each(function(e,t){var i=n.rows.find(function(e){return e.el===t});i&&i.isChecked()&&(a[i.nameOutVal()]=i.value())}),_.every(_.keys(this.meta),function(e){return a[e]===e})?{}:a},de.prototype.remove=function(){return this.$el.off(),this.$search.off(),this.$checkAll.off(),this.$closeIcon.off(),l.View.prototype.remove.call(this)},de.prototype.updateCheckAll=function(){this.$checkAll.prop("checked",_.every(this.rows,function(e){return e.isChecked()}))},de);function de(e,n,t,i,a){var s=re.call(this,{el:e})||this;s.rows=[],s.$el.addClass("select-view"),s.$el.html(F.selectView({}));e=_.values(t).map(function(e){return _.isString(e)?e:e.col});s.columns=_.union(e,_.keys(n)),s.meta=n,s.save=i;var o=_.clone(t);o&&!_.isEmpty(o)||(t=a?_.take(s.columns,1):s.columns,o=_.zipObject(t,t));var r=Object.keys(o).map(function(e){return{key:e,value:o[e]}});return s.columns.forEach(function(t){var e=_.find(r,function(e){return t===(_.isString(e.value)?e.value:e.value.col)}),i=e&&!_.isString(e.value)?e.value:void 0;s.rows.push(new se(t,(null==e?void 0:e.key)||t,!!e,function(){s.updateCheckAll(),s.save()},!!a&&de.isScalar(n[t]),n[t],i))}),s.$search=s.$el.find(".search"),s.$checkAll=s.$el.find(".searchRow > input[type='checkbox']"),s.$closeIcon=s.$el.find(".closeIcon"),s.$closeIcon.css("display","none"),s.$search.on("keyup",function(){var t=s.$search[0].value.toLowerCase();_.each(s.$el.find(".rows").children(),function(e){$(e).toggle(($(e).attr("data-id")||"").toLowerCase().includes(t))}),s.$closeIcon.css("display",t?"":"none")}),s.$checkAll.on("change",function(){var t=s.$checkAll[0].checked;s.rows.forEach(function(e){return e.check(t)}),s.save()}),s.$closeIcon.on("click",function(){s.$search.val(""),s.$closeIcon.css("display","none"),s.$search.trigger("keyup")}),s.$el.find(".rows").append(s.rows.map(function(e){return e.el})).sortable({stop:function(){return s.save()}}).disableSelection(),s.updateCheckAll(),s}var ce,ue=(f(pe,ce=W),pe.prototype.saveClickHandler=function(){this.node.data={select:this.selectView?this.selectView.getValue():{},where:JSON.parse(this.filterSettings.get(pe.PROP_QUERYMODEL)||"{}"),distinct:this.$el.find(".selectDistinct input").is(":checked")},this.host.refreshSideDialogHeader(this.node),this.callback&&this.callback(this.node)},pe);function pe(e,t,i,n,a){var s=ce.call(this,e,t,[i],n,a)||this;s.$el.html(F.filterDialog({}));var o=s.$el.find(".select-table"),r=s.$el.find(".where-table");s.initializeDataFilter(),t.data&&t.data.where&&s.filterSettings.set(pe.PROP_QUERYMODEL,JSON.stringify(t.data.where,null,2));return s.renderDialog(550,550,s.saveClickHandler.bind(s),function(){s.createAccordion([{$el:o,heading:"Select - Columns",hideHeader:!1,isExpanded:!1,isResizeable:!0,weight:1},{$el:r,heading:"Where - Rows",hideHeader:!1,isExpanded:!0,weight:1}]);s.$el.find(".section:nth-child(1) > .heading").append('<div class="selectDistinct"><label><input type="checkbox"/><span>distinct</span></label></div>'),s.$el.find(".selectDistinct input").prop("checked",s.node.data.distinct),s.$el.find(".selectDistinct").on("click",function(e){e.stopPropagation(),s.save()}),s.renderFromParentMeta(function(t){var e=s.node.data||{};_.isEmpty(e.select)||(e.select=_.pickBy(e.select,function(e){return _.includes(_.keys(t),e)})),s.selectView=new le(o[0],t,e.select,function(){return s.save()}),s.renderFilter(r)})}.bind(s),s.onResize.bind(s),"filter-dialog","filter-dialog"),s.initialSave(),s}var he,fe=(he=l.View,f(ge,he),ge.prototype.getValue=function(){var i=_.map(this.$el.find(".row > .user-input"),function(e){return $(e).hasClass("useBinding")?"<%"+$(e).find(".binding-select").val()+"%>":$(e).hasClass("useViewState")?"<%"+$(e).find(".viewstate-display").val()+"%>":$(e).find("input[type=text]").val()}),n=_.map(this.$el.find(".row > .fn"),function(e){return $(e).val()}),a=_.map(this.$el.find(".row > .col1"),function(e){return $(e).val()}),s=_.map(this.$el.find(".row > .col2"),function(e){return $(e).val()}),o={};return _.each(i,function(e,t){e&&(e=-1!==ge.FN2.indexOf(n[t]),o[i[t]]=e?[n[t],a[t],s[t]]:[n[t],a[t]])}),o},ge.prototype.remove=function(){return this.$el.off(),l.View.prototype.remove.call(this)},ge.FNS=["avg","cor","count","cov","dev","first","last","max","med","min","prd","scov","sdev","sum","svar","var","wavg","wsum"],ge.FN2=["cor","cov","scor","scov","wavg","wsum"],ge);function ge(e,t,i,n){var d=he.call(this,{el:e})||this;d.$el.addClass("agg-view"),d.$el.html(F.aggregateView({})),d.$el.find(".add-row").button({icons:{primary:"fa fa-plus"}}),d.save=n;function a(e,t){var i={fn:e&&e[0]||"sum",src:e&&e[1]||t,aux:e&&e[2]||null},n=$(F.aggregateRow(i)),a=n.find(".fn"),s=n.find(".col1"),o=n.find(".col2"),e=n.find(".user-input"),t=new ie(e[0],t);n.append(t.$el);var r=n.find("input[type=text]");function l(){var e=""+a.val(),e=-1!==ge.FN2.indexOf(e);o.next(".select2-container").css("display",e?"inline-block":"none"),e?(a.select2({width:"10%",theme:"dashboards"}),s.select2({width:"20%",theme:"dashboards"})):(a.select2({width:"20%",theme:"dashboards"}),s.select2({width:"30%",theme:"dashboards"}))}return a.select2({data:u,multiple:!1,theme:"dashboards",width:"20%"}),s.select2({data:c,multiple:!1,theme:"dashboards",width:"30%"}),o.select2({data:c,multiple:!1,theme:"dashboards",width:"20%"}),a.val(i.fn).trigger("change"),s.val(i.src).trigger("change"),i.aux?o.val(i.aux).trigger("change"):o.next(".select2-container").hide(),l(),a.on("select2:select",function(){l(),d.save()}),s.on("select2:select",function(e){r.val(e.target.value),d.save()}),r.change(function(){d.save()}),n.find(".del").button({icons:{primary:"ui-icon-trash"}}).click(function(){n.remove(),d.save()}),n}var c=_.map(t,function(e,t){return{text:t,id:t}}),u=_.map(ge.FNS,function(e){return{text:e,id:e}});return d.$el.find(".rows").append(_.map(i,a)).sortable().disableSelection(),d.$el.find(".add-row").on("click",function(){var e=_.first(_.keys(t))||"";d.$el.find(".rows").append(a(["sum",e],e)),d.save()}),d}var me,ve=(f(ye,me=W),ye.prototype.saveClickHandler=function(){this.node.data={groupBy:this.selectView?this.selectView.getValue():{},agg:this.aggView?this.aggView.getValue():{}},this.host.refreshSideDialogHeader(this.node),this.callback&&this.callback(this.node)},ye);function ye(e,t,i,n,a){var s=me.call(this,e,t,[i],n,a)||this;s.$el.html(F.groupByDialog({}));var o=s.$el.find(".select-table"),r=s.$el.find(".agg-table");return s.renderDialog(480,400,s.saveClickHandler.bind(s),function(){s.createAccordion([{$el:o,heading:"Group By",hideHeader:!1,isExpanded:!0,isResizeable:!0,weight:1},{$el:r,heading:"Aggregate",hideHeader:!1,isExpanded:!0,weight:1}]),s.renderFromParentMeta(function(t){var e=s.node.data||{};_.isEmpty(e.groupBy)||(e.groupBy=_.pickBy(e.groupBy,function(e){return _.isString(e)?_.includes(_.keys(t),e):_.includes(_.keys(t),e.col)})),_.isEmpty(e.agg)||(e.agg=_.pickBy(e.agg,function(e){return _.every(e.slice(1),function(e){return _.includes(_.keys(t),e)})})),s.selectView=new le(o[0],t,e.groupBy,s.save.bind(s),!0),s.aggView=new fe(r[0],t,e.agg,s.save.bind(s)),s.save()})}.bind(s),s.onResize.bind(s),"graph-container groupBy-dialog","groupBy-dialog"),s.initialSave(),s}var we,be=(f(Se,we=W),Se.prototype.saveClickHandler=function(){var e=_.map(this.$leftTable.find(".rows label"),function(e){return e.textContent}),t=_.map(this.$rightTable.find(".rows label"),function(e){return e.textContent}),i=_.map(this.$leftTable.find(".rows input"),function(e){return e.checked}),n=_.map(this.$rightTable.find(".rows input"),function(e){return e.checked});this.node.data={fn:this.fn,swap:this.swap,left:e.filter(function(e,t){return i[t]}),right:t.filter(function(e,t){return n[t]})},this.host.refreshSideDialogHeader(this.node),this.callback&&this.callback(this.node)},Se.prototype.renderDatagrid=function(o){var r=this,l=this.node.data?"left"===o?this.node.data.left:this.node.data.right:[],d=new c.DocumentDataModel({_subscriptionKey:"_rowIndex",_dataType:"copy",_maxRows:this.MAXROWS},null,"",null);d.apply(),this.renderFromParentMeta(function(e){var a,s,t={class:"203",columns:["Columns"],meta:{Columns:11},rows:_.map(_.keys(e),function(e){return{Columns:e}})};d.onExecuteSuccess(t,!0),"left"===o?(a=r.$leftTable,s=".transformLeftTable",r.leftRows=t.rows.map(function(e){return e.Columns})):(a=r.$rightTable,s=".transformRightTable",r.rightRows=t.rows.map(function(e){return e.Columns}));var e=function(e){var t=$(F.joinRow({})),i=t.find("input"),n=t.find("label");t.attr("data-id",e.Columns),n.append(e.Columns),-1<l.indexOf(e.Columns)?(i.prop("checked",!0),t.attr("checked","true")):(i.prop("checked",!1),t.attr("checked",null)),t.click(function(){i.prop("disabled")||(i.prop("checked")?(i.prop("checked",!1),t.attr("checked",null)):(i.prop("checked",!0),t.attr("checked","true")),r.save())}),i.change(function(){r.checked?t.attr("checked","true"):t.attr("checked",null),r.save()}),i.click(function(e){return e.stopPropagation(),!0}),$(function(){$(s).find(".rows").sortable().disableSelection()}),a.find(".rows").append(t)},i=a.find(".search"),n=a.find(".closeIcon");n.css("display","none"),i.keyup(function(){var t=this.value.toLowerCase();_.each($(this).parent().parent().find(".row"),function(e){$(e).toggle(($(e).attr("data-id")||"").toLowerCase().includes(t))}),n.css("display",t?"":"none")}),n.click(function(){i.val(""),n.css("display","none"),i.trigger("keyup")}),_.each(_.filter(t.rows,function(e){return-1<l.indexOf(e.Columns)}).sort(function(e,t){return l.indexOf(e.Columns)-l.indexOf(t.Columns)}),e),_.each(_.filter(t.rows,function(e){return-1===l.indexOf(e.Columns)}),e),r.updateChecks()},this.parents["left"===o?0:1])},Se.prototype.updateChecks=function(){var e=_.find(this.joinTypes,{JoinType:this.fn});this.$el.find(".transformJoinTextDesc").html(e.Message);var t=["aj","uj","upsert"],i=["lj","ij","uj","upsert","pj"],e=-1===(this.swap?i:t).indexOf(this.fn);this.$leftTable.toggleClass("disableRows",e),this.updateTableRows(this.$leftTable,this.$rightTable,e);i=-1===(this.swap?t:i).indexOf(this.fn);this.$rightTable.toggleClass("disableRows",i),this.updateTableRows(this.$rightTable,this.$leftTable,i)},Se.prototype.updateTableRows=function(e,t,i){var n;i?_.each(e.find(".row"),function(e){$(e).find("input[type=checkbox]").prop("checked",null),$(e).find("input, label").prop("disabled",!0)}):(n=_.fromPairs(_.map(t.find(".row"),function(e){return[$(e).attr("data-id"),!0]})),_.each(e.find(".row"),function(e){var t=$(e).attr("data-id")||"";$(e).find("input, label").prop("disabled",!n[t])}))},Se);function Se(e,t,i,n,a){var s=we.call(this,e,t,i,n,a)||this;s.fn="lj",s.swap=!1,s.leftRows=[],s.rightRows=[],s.MAXROWS=100,s.joinTypes=[{Join:"Left",JoinType:"lj",Message:"Result is left table with any matching keys from the right table joined to it"},{Join:"Inner",JoinType:"ij",Message:"Result has one combined record for each row in the left table that matches a row in the right table"},{Join:"Union",JoinType:"uj",Message:"Matching records from right table will update left table . Unmatched records from both tables are inserted into result"},{Join:"Asof (aj)",JoinType:"aj",Message:"Result is a table with records from the left-join of the tables. In the join, the first n - 1 checked columns of the left table are matched for equality. The last checked column is matched with less than or equals (most recent time)"},{Join:"Upsert",JoinType:"upsert",Message:"Matching records from right table will update left table. Unmatched records from both tables are inserted into result. Note: columns of left and right table must be aligned to perform upsert."},{Join:"Plus ",JoinType:"pj",Message:"Result is the arithmeic sum of matching records, commn columns are left inchanged and new columns are zero. Note: common columns must be an arithmetic type to be joined"}],s.$el.html(F.joinDialog({a:i[0].teaser(),b:i[1].teaser()})),s.$joinTypeSelect=s.$el.find(".join-type-select"),s.$joinDiv=s.$el.find(".transformJoin"),s.$joinDDL=s.$el.find(".joinDDL"),s.$leftTable=s.$el.find(".transformLeftTable"),s.$rightTable=s.$el.find(".transformRightTable"),s.$leftName=s.$el.find(".dbNameLeft"),s.$rightName=s.$el.find(".dbNameRight"),null!==s.node.data&&(s.fn=s.node.data.fn,_.isUndefined(s.node.data.swap)||(s.swap=s.node.data.swap)),s.$joinDiv.toggleClass("swpd",s.swap);return s.renderDialog(567,550,s.saveClickHandler.bind(s),function(){s.$joinTypeSelect.select2({data:_.map(s.joinTypes,function(e){return{text:e.Join,id:e.JoinType}}),theme:"dashboards",width:"100%"}),s.$joinTypeSelect.on("select2:select",function(e){s.fn=e.params.data.id,s.updateChecks(),s.save()});var e=_.find(s.joinTypes,{JoinType:s.fn});s.$joinTypeSelect.val(e.JoinType).trigger("change"),s.$el.find(".swap").button().click(function(){s.swap=!s.swap,s.$joinDiv.toggleClass("swpd",s.swap),s.updateChecks(),s.save()}),s.renderDatagrid("left"),s.renderDatagrid("right"),s.updateChecks()}.bind(s),_.noop.bind(s),"dlgFilterPopup"),s}var $e,_e,Pe=(f(De,$e=W),De.prototype.getUpdateJSON=function(){var n=this,a=[];return _.each(this.$el.find(".updaterRow"),function(e){var t,i=$(e);i.find(".updaterCheckbox").is(":checked")&&(t=$(e).find(".updaterColumnDDL").val()||"undefined",e=$(e).find(".updaterValue"),void 0!==t&&void 0!==e&&(e=n.parent.meta[t.toString()],void 0!==(i=i.attr("data-id"))&&(i=n.forms[i.toString()],a.push({column:t.toString(),propertyType:-e||10,val:i.model.get("value")}))))}),a},De.prototype.renderUpdate=function(){var t=this;this.$el.find(".transformUpdateNewRow").button({icons:{primary:"ui-icon-plus"}}).click(function(){t.addRow(null)}),this.$el.find(".updaterColumnsList").html(""),this.node.data&&this.node.data.update&&_.each(this.node.data.update,function(e){t.addRow(e)})},De.prototype.saveClickHandler=function(){this.node.data={filter:JSON.parse(this.filterSettings.get(De.PROP_QUERYMODEL)||"[]"),update:this.getUpdateJSON()},this.host.refreshSideDialogHeader(this.node),this.callback&&this.callback(this.node)},De.prototype.getBindings=function(e){e=e.model.get("type")||11;return this.host.getAllMatchingBindings(e).map(function(e){return e.Key})},De.prototype.addRow=function(e){var i=this;this.$el.find(".updaterColumnsList").append(F.updateRow({id:this.rowCount}));var t=this.$el.find("#updaterRow-"+this.rowCount),n=t.find(".updaterColumnDDL"),a=_.map(this.parent.meta,function(e,t){return{text:t,id:t}}),s=t.find(".updaterCheckbox");n.select2({data:a,multiple:!1,theme:"dashboards",width:"100%"}),n.attr("data-id",this.rowCount),t.find(".updaterValue").bind("keypress",function(e){var t=e.keyCode||0,t=e.which||t;if(!(48<=t&&t<=57))return console.log("error format"),!1}),s.on("change",function(e){i.save()}),n.on("select2:select",function(e){var t=n.attr("data-id"),e=e.params.data.text;void 0!==t&&(t=i.$el.find("#updaterRow-"+t),i.updateValueEditor(t,{column:e,val:null,propertyType:i.parent.meta[e]})),i.save()}),t.find(".updaterTrash").button({icons:{primary:"ui-icon-trash"}}).click(function(e){_.get(e,"target.parentElement.parentElement.parentElement")&&(_.get(e,"target.parentElement.parentElement.parentElement").remove(),i.save())}),t.find(".updaterTrash").attr("data-id",this.rowCount),e&&(n.val(e.column).trigger("change"),t.find(".updaterValue").val(e.val)),this.updateValueEditor(t,e),this.rowCount+=1,e||this.save()},De.prototype.updateValueEditor=function(e,t){var i=Math.abs(_.get(t,"propertyType"));_.get(t,"column");isNaN(i)&&(i=_.first(_.values(this.parent.meta)),_.first(_.keys(this.parent.meta)));var i=10!==i&&i||11,n=r.RTTI.getByQTypeNum(i),a=n.editor,s=n.name,o=e.attr("data-id"),i=this.onFormValueChanged.bind(this);o&&(n=new r.editors[a.type]({model:new l.DeepModel,schema:a,key:"value",id:"rowInput_"+o}).render(),_.get(t,"column")&&n.$el.attr("data-name",t.column),"Text"===a.type||"Number"===a.type?(n.$el.attr("type","search"),n.$el.on("input",_.debounce($.proxy(i,this,n,null),500))):n.on("change changeList",$.proxy(i,this,n,null)),_.get(t,"val")?n.model.set("value",t.val):n.model.set("value",n.getValue()),this.forms[o.toString()]=n,o=null,(0<this.host.api.getProperty("Bindings").length||this.host.api.getProperty("Basics.UseViewStates"))&&((o=$(F.bindingSelect({}))).find(".binding-apply").click(this.showBindingsDropdown.bind(this,null,n,o,null)),o.find(".binding-clear-dialog").click(this.onBindingsClear.bind(this,n,o)),n.model.set("type",s),t&&_.isString(t.val)&&t.val.match(P.VSRx)&&this.showBindingsDropdown(null,n,o,this.removeVSChars(t.val)),this.host.api.getProperty("Basics.UseViewStates")?(o.find(".binding-dropdown").hide(),o.find(".viewstate-display").click(this.showBindingsDropdown.bind(this,null,n,o,null))):(o.find(".viewstate-icon").hide(),o.find(".viewstate-display").hide(),o.find(".binding-select").on("select2:select",$.proxy(i,this,n,o)))),n=o?(n.$el.is("div, select")?this.wrapInDiv(n.$el,"value-wrap"):n.$el).add(o):n.$el,e.find(".updaterColumSelection").html(n))},De.prototype.onBindingsClear=function(e,t){e.model.set("value",this.previousValue),this.toggleBindings(!0,e,t),this.save()},De.prototype.onFormValueChanged=function(e,t,i){e.model.set({value:!t||"true"!==t.attr("use-bindings")&&"true"!==t.attr("use-viewstates")?i?_.isNil(i.value)?i.target.value:i.getValue():"":"<%"+(t.find(".binding-select").val()||t.find(".viewstate-display").val())+"%>"}),this.save()},De.prototype.onSelectViewState=function(e,t,i){t.find(".viewstate-display").val(i),this.toggleBindings(!1,e,t),this.setPreviousValue(e),this.onFormValueChanged(e,t,null),this.save()},De.prototype.setPreviousValue=function(e){var t=e.model.get("value"),e=e.model.get("type");this.previousValue=_.isString(t)&&w.VSRx.exec(t)?"boolean"!==e&&"":t},De.prototype.showBindingsDropdown=function(e,t,i,n){this.host.api.getProperty("Basics.UseViewStates")?_.isNil(n)?this.host.renderViewStateDialog({path:this.removeVSChars((t.model||t.value.model).get("value")),selectCallback:this.onSelectViewState.bind(this,t,i)}):this.onSelectViewState(t,i,n):(this.toggleBindings(!1,t,i),this.setPreviousValue(t),t=this.getBindings(t),(i=i.find(".binding-select")).select2({data:t,multiple:!1,theme:"dashboards",width:"100%",language:{noResults:function(){return"No matching bindings"}}}),i.val(n||t[0]||""),i.trigger("change"),i.trigger("select2:select"))},De.prototype.toggleBindings=function(e,t,i){(t.$el.parent().hasClass("value-wrap")?t.$el.parent():t.$el).toggle(e),t.$el.toggle(e),i.find(".binding-apply").toggle(e),i.find(".binding-container").toggle(!e),this.host.api.getProperty("Basics.UseViewStates")?(i.find(".viewstate-icon").toggle(!e),i.find(".viewstate-display").toggle(!e),i.attr("use-viewstates",String(!e))):i.attr("use-bindings",String(!e))},De.prototype.wrapInDiv=function(e,t){var i=$(document.createElement("div"));return t&&i.addClass(t),i.append(e),i},De);function De(e,t,i,n,a){var s=$e.call(this,e,t,[i],n,a)||this;s.forms={},s.rowCount=0,s.$el.html(F.updateDialog({}));var o=s.$el.find(".update-table"),r=s.$el.find(".where-table");s.initializeDataFilter(),t.data&&t.data.filter&&s.filterSettings.set(De.PROP_QUERYMODEL,JSON.stringify(t.data.filter,null,2));return s.renderDialog(550,550,s.saveClickHandler.bind(s),function(){s.createAccordion([{$el:o,heading:"Update",hideHeader:!1,isExpanded:!0,isResizeable:!0,weight:1},{$el:r,heading:"Where",hideHeader:!1,isExpanded:!0,weight:1}]),s.renderFromParentMeta(function(t){var e=s.node.data||{};_.isEmpty(e.update)||(e.update=_.filter(e.update,function(e){return _.includes(_.keys(t),e.column)})||[]),s.renderUpdate(),s.renderFilter(r)})}.bind(s),s.onResize.bind(s),"update-dialog","update-dialog"),s.initialSave(),s}function ke(e){var t=_e.call(this,e)||this;return t.renderViewStateDialog=_.noop.bind(t),t.docViewModel=null,t.selectedNode=null,t.sideDialog=!1,t.connection="",t.isSaving=!1,t.nodes={},t.edges={},t.edgesR={},t.errorNodeId="",t.activeBindingKeys=[],t.network=void 0,t.dialogNode=null,t.dialog=null,t.dialogPlacement="",t.api=e.api,t.dashboardAppModel=e.dashboardAppModel,t.server=e.DeltaClientLib,t.dialogPlacement=t.api.getProperty(ke.PROP_DIALOGPLACEMENT),t.isLite=e.dashboardAppModel.get("isLite"),t.$el.html(F.app({})),t.$el.addClass("graph-app"),t.$error=t.$el.find(".nodeErrorMessage"),t.$builder=t.$el.find(".builder"),t.$graph=t.$el.find(".graph"),t.$sideDialog=t.$el.find(".side-dialog"),t.accordion=new i.AccordionView({el:t.$el.find(".accordion")[0],sections:t.generateAccordionSections(t.dialogPlacement)}),t.accordion.setDirection("Horizontal"),t.$el.bind("contextmenu",function(e){e.preventDefault()}),t.listenTo(t.accordion,"sectionResized",t.resizeSideDialog.bind(t)),t}return _e=c.QueryBuilder.App,f(ke,_e),ke.createNode=function(e){switch(e.group){case"data":case"function":case"stream":return new P(e);case"filter":return new x(e);case"groupBy":return new E(e);case"join":return new T(e);case"update":return new L(e);case"result":return new I(e);default:throw"Invalid node "+e}},ke.prototype.closeSideDialog=function(){this.onCloseDialog(),this.toggleSideDialog(!1),this.redrawGraph(),this.api.getProperty(ke.PROP_AUTOSAVE)||this.$sideDialog.find(".save-button").off("click"),this.$sideDialog.find(".close-button").off("click"),this.toggleHelpfulTip()},ke.prototype.getAllMatchingBindings=function(t){var e=this.api.getProperty(ke.PROP_BINDINGS);return _.filter(e,function(e){return e.ViewState&&e.ViewState.get("_type")===t})},ke.prototype.getNodeData=function(e,t,i,n){this.runAnalytic(".queryBuilder.processGraph",[{type:"symbol",value:e},{type:"string",value:this.api.getProperty(ke.PROP_qIPC)}],t,i,n)},ke.prototype.onCloseDialog=function(){this.dialog&&(this.dialog.remove(),delete this.dialog),this.dialogNode=null},ke.prototype.onResize=function(){this.accordion.resize(),this.accordion.updateLayout(!1),this.resizeSideDialog(),this.renderGraph()},ke.prototype.onSettingsChange=function(e){var i,t,n,a=this,s=!1,o=!1;if(0<Object.keys(e).filter(function(e){return-1!==[ke.PROP_CONN,ke.PROP_JSON].indexOf(e)}).length&&(void 0!==e[ke.PROP_CONN]&&(this.connection=e[ke.PROP_CONN]),void 0!==e[ke.PROP_JSON])){var r=e[ke.PROP_JSON];try{var l=JSON.parse(r);this.edges=l.edges,this.edgesR=ke.calculateReverseEdges(this.edges),this.nodes={},_.each(this.topoSortedNodes(l.nodes,this.edgesR),function(e){a.nodes[e.id]=ke.createNode(e)}),this.activeBindingKeys=_.reduce(this.nodes,function(e,t){return e.concat(c.QueryBuilder.App.groupToClass[t.group].getActiveBindingKeys(t.data))},[]),this.toggleHelpfulTip()}catch(e){c.Log.Warn("Invalid JSON - Default Graph"),this.edges={},this.edgesR={},this.activeBindingKeys=[];var r=new I({id:"result",group:"result"}),l=new P({id:"data0",group:"data"});this.nodes={result:r,data0:l},this.addEdge(l.id,r.id),this.addNodeBefore(r,l)}s=!0}_.find(_.keys(e),function(e){return 0===e.indexOf(ke.PROP_DIRECTION)||0===e.indexOf(ke.PROP_LEVELSEPARATION)||0===e.indexOf(ke.PROP_NODESPACING)})&&(s=!0),_.find(_.keys(e),function(e){return e===ke.PROP_BINDINGS})?(l=this.api.getProperty(ke.PROP_BINDINGS),y.GraphNode.bindings={},_.each(l,function(e,t){y.GraphNode.bindings[e.Key]=a.api.getProperty(ke.PROP_BINDINGS+"."+t+".ViewState"),s=s||-1!==a.activeBindingKeys.indexOf(e.Key)})):0<(n=_.keys(e).filter(function(e){return/Bindings\.[0-9]+\.ViewState/.test(e)})).length&&(i=this.api.getProperty(ke.PROP_BINDINGS),_.each(n,function(e){var t=i[e.split(".")[1]].Key;y.GraphNode.bindings[t]=a.api.getProperty(e),o=!0})),_.find(_.keys(e),function(e){return e===ke.PROP_DIALOGPLACEMENT||e===ke.PROP_AUTOSAVE})&&((t=this.api.getProperty(ke.PROP_DIALOGPLACEMENT))!==this.dialogPlacement&&"Pop-up"!==(this.dialogPlacement=t)&&"dialog"!==("Left"===t?a.accordion.sections[0]:a.accordion.sections[1]).viewModel.get("heading")&&(_.each(this.accordion.sections,function(e){return a.accordion.removeSection(e.viewModel.get("sectionId"))}),n=this.generateAccordionSections(t),_.each(n,function(e){return a.accordion.addSection(e,!0)})),this.sideDialog&&this.closeSideDialog(),this.toggleHelpfulTip()),!_.find(_.keys(e),function(e){return e===ke.PROP_FORCESELECT})||!this.api.getProperty(ke.PROP_FORCESELECT)||this.selectedNode&&"result"!==this.selectedNode.id||this.selectNode(_.first(this.edgesR.result)),s?(this.update(!0),this.renderGraph()):o&&(this.update(!0),this.renderLabels()),_.find(_.keys(e),function(e){return e===ke.PROP_DATA})&&this.api.subscribe(e[ke.PROP_DATA],function(e,t,i){i&&a.network?(i=/(Database exception: )?nd([^:]+):(.*)$/.exec(i.error),a.$error.find(".errors-text").html(i?i[3]:""),a.errorNodeId=i?i[2]:"",a.positionErrorNode()):(a.$error.hide(),a.errorNodeId="")})},ke.prototype.refreshSideDialogHeader=function(e){var t,i;this.$sideDialog&&(t=this.$sideDialog.find(".side-dialog-menu > .description"),i=this.$sideDialog.find(".side-dialog-menu > .menu-icon"),t.html(e.teaser()),i.html(e.icon()))},ke.prototype.remove=function(){return this.network&&(this.network.destroy(),delete this.network),w.viewModel&&delete w.viewModel,this},ke.prototype.renderSideDialog=function(e,t,i,n){var a=this,s=this.sideDialog;this.dialogNode=t,this.dialogNode.data||i(),this.toggleSideDialog(!0),this.refreshSideDialogHeader(t);var o=this.$sideDialog.find(".side-dialog-content");o.find(".select2-hidden-accessible").select2("close"),o.empty(),o.append(e);t=this.$sideDialog.find(".save-button"),e=this.api.getProperty(ke.PROP_AUTOSAVE);this.toggleSaveButton(o,t,e),e||t.off("click").button().click(function(){i()}),this.$sideDialog.find(".close-button").off("click").button().click(function(){a.closeSideDialog()}),n(),s||this.redrawGraph()},ke.prototype.runAnalytic=function(e,t,i,n,a){this.server.runAnalytic(e,this.connection,t,n,function(e){a(e)},i)},ke.prototype.setViewModel=function(e,t,i){this.docViewModel=e,this.docDataModel=t,this.renderViewStateDialog=i,c.QueryBuilder.GraphNode.viewModel=w.viewModel=e},ke.prototype.updateMeta=function(i,n){var a=this;this.getNodeData(i.id,10,function(e){if(a.nodes[i.id].meta=e.meta,"update"!==i.group)for(var t=a.edges[i.id][0];"result"!==t;)delete(i=a.nodes[t]).meta,t=a.edges[i.id][0];a.update(),n&&n(e.meta)},function(e){return c.Log.Error(e)})},ke.prototype.addEdge=function(e,t){var i=this.edges[e];void 0!==i?i.push(t):this.edges[e]=[t],void 0!==(i=this.edgesR[t])?i.push(e):this.edgesR[t]=[e]},ke.prototype.addNodeBefore=function(e,t){this.nodes[t.id]||(t.id=this.getNewNodeId(t.group),this.addEdge(t.id,e.id)),this.nodes[t.id]=t,this.update(),this.selectNode(t.id),this.updateMeta(t)},ke.prototype.count=function(e){e=this.edges[e];return void 0===e?0:e.length},ke.prototype.countR=function(e){e=this.edgesR[e];return void 0===e?0:e.length},ke.prototype.deleteNode=function(t){var i=this,e=_.first(this.edgesR[t]),n=_.first(this.edges[t]);this.selectedNode=this.nodes[e||n||"result"],this.api.setProperty(ke.PROP_SELECTED,this.selectedNode.id),this.sideDialog&&this.doCommand(this.selectedNode.group),_.each(this.edges[t],function(e){return i.removeEdge(t,e)}),_.each(this.edgesR[t],function(e){return i.removeEdge(e,t)}),delete this.nodes[t],void 0!==e&&void 0!==n&&this.addEdge(e,n),this.update(),this.updateMeta(this.selectedNode)},ke.prototype.doCommand=function(e){var t,i,n,a=this,s=this.selectedNode;switch(s&&"result"!==s.id||(t=_.first(this.edgesR.result),s=t?this.nodes[t]:this.nodes.result),"Pop-up"!==this.api.getProperty(ke.PROP_DIALOGPLACEMENT)&&(i=this.$sideDialog),e){case"+data":this.dialog=new Z(this,new P({group:"data"}),void 0,function(e){return a.addNodeBefore(s,e)},i);break;case"data":case"stream":this.dialog=new Z(this,s,void 0,function(e){return a.updateNode(e)},i);break;case"+filter":this.dialog=new ue(this,new x({group:"filter"}),s,function(e){return a.insertNodeAfter(s,e)},i);break;case"filter":this.dialog=new ue(this,s,this.nodes[this.getParentNodeId(s)],function(e){return a.updateNode(e)},i);break;case"function":this.dialog=new Z(this,s,this.nodes[this.getParentNodeId(s)],function(e){return a.updateNode(e)},i);break;case"+function":this.dialog=new Z(this,new P({group:"function"}),s,function(e){return a.insertNodeAfter(s,e)},i);break;case"function+":this.dialog=new Z(this,new P({group:"function"}),void 0,function(e){return a.addNodeBefore(s,e)},i);break;case"groupBy":this.dialog=new ve(this,s,this.nodes[this.getParentNodeId(s)],function(e){return a.updateNode(e)},i);break;case"+groupBy":this.dialog=new ve(this,new E({group:"groupBy"}),s,function(e){return a.insertNodeAfter(s,e)},i);break;case"join":2===this.countR(s.id)&&(n=_.keys(this.topoSortedNodes(this.nodes,this.edgesR)),this.dialog=new be(this,s,this.edgesR[s.id].sort(function(e,t){return n.indexOf(e)-n.indexOf(t)}).map(function(e){return a.nodes[e]}),function(e){return a.updateNode(e)},i));break;case"+join":this.insertNodeAfter(s,new T({group:"join"}));break;case"+update":this.dialog=new Pe(this,new L({group:"update"}),s,function(e){return a.insertNodeAfter(s,e)},i);break;case"update":this.dialog=new Pe(this,s,this.nodes[this.getParentNodeId(s)],function(){return a.update()},i);break;case"delete":this.deleteNode(s.id);break;case"result":break;default:throw"Command Error"}},ke.prototype.decodeHTML=function(e){return e.replace(/&lt;%/g,"<%").replace(/%&gt;/g,"%>")},ke.prototype.expandSideDialog=function(e){var t=_.find(this.accordion.sections,function(e){return"dialog"===e.viewModel.get("heading")});t&&t.viewModel.set("isExpanded",e)},ke.prototype.generateAccordionSections=function(e){var t=[{$el:this.$sideDialog,viewModel:new l.Model({align:"left",heading:"dialog",hideHeader:!0,order:0,isExpanded:!1,isResizeable:!0,weight:.4,sectionId:_.uniqueId("section_")})},{$el:this.$builder,viewModel:new l.Model({align:"left",heading:"graph",hideHeader:!0,order:0,isExpanded:!0,weight:.6,isResizeable:!0,sectionId:_.uniqueId("section_")})}];return"Left"===e?t:_.reverse(t)},ke.prototype.getDirection=function(){var e="LR";switch(this.api.getProperty(ke.PROP_DIRECTION)){case"Up-Down":e="UD";break;case"Down-Up":e="DU";break;case"Right-Left":e="RL"}return e},ke.prototype.getNewNodeId=function(e){for(var t=0;void 0!==this.nodes[e+t];)t++;return e+t},ke.prototype.getParentNodeId=function(e){return _.first(this.edgesR[e.id])},ke.prototype.insertNodeAfter=function(e,t){var i;this.nodes[t.id]||(t.id=this.getNewNodeId(t.group),i=this.edges[e.id][0],this.removeEdge(e.id,i),this.addEdge(e.id,t.id),this.addEdge(t.id,i)),this.nodes[t.id]=t,this.update(),this.selectNode(t.id),this.updateMeta(t)},ke.prototype.listenToNetwork=function(){var t=this;this.network&&(this.network.on("selectNode",function(e){return t.setSelectedNode(_.first(e.nodes)),!0}),this.network.on("deselectNode",function(e){return t.selectNode(t.api.getProperty(ke.PROP_FORCESELECT)&&!e.nodes.length?_.first(e.previousSelection.nodes):""),!0}),this.network.off("oncontext"),this.network.on("oncontext",function(e){t.api.getProperty(ke.PROP_READONLY)||t.showContextMenu(e)}),this.network.on("click",this.onClick.bind(this)),this.network.on("doubleClick",function(e){t.api.getProperty(ke.PROP_READONLY)||t.onDoubleClick(e)}),this.network.on("hoverNode",function(){t.$graph.css("cursor","pointer")}),this.network.on("blurNode",function(){t.$graph.css("cursor","default")}))},ke.prototype.mapDataAttributes=function(){return{edges:new o.DataSet(_.reduce(_.pickBy(this.edges,function(e){return!_.includes(e,"result")}),function(e,t,i){return e.concat(t.map(function(e){return _.extend({},{arrows:{to:!0},id:i+"->"+e,labelHighlightBold:!1,shadow:!1,width:1},{from:i,to:e})}))},[])),nodes:new o.DataSet(_.map(_.filter(this.nodes,function(e,t){return"result"!==t}),function(e){return{id:(e=e).id,chosen:{node:function(e,t,i){i&&(e.borderColor="#00AEFF",e.borderWidth=2)}},font:{multi:"html",align:"left",face:"FontAwesome,Arial",size:13,bold:"Arial",ital:"Segoe UI"},title:e.description()||void 0,label:e.icon()+" "+e.teaser(),color:e.color(),labelHighlightBold:!1,shape:"box",shapeProperties:{borderRadius:3}}}))}},ke.prototype.onClick=function(e){$(".custom-menu").hide(),this.sideDialog&&this.onDoubleClick(e)},ke.prototype.onDoubleClick=function(e){var t;!this.network||void 0!==(t=this.network.getNodeAt(e.pointer.DOM))&&0!==t&&(e=this.nodes[t],this.selectedNode!==e&&this.selectNode(t),this.doCommand(e.group))},ke.prototype.positionErrorNode=function(){var e,t,i;this.network&&this.errorNodeId&&(i=this.network.getPositions([this.errorNodeId]),_.isEmpty(i)||(this.$error.show(),e=this.network.getScale(),0<(i=(t=this.network.canvasToDOM({x:i[this.errorNodeId].x,y:i[this.errorNodeId].y})).x-this.$error[0].clientWidth/2)?this.$error.css({left:i+this.$sideDialog[0].clientWidth+"px",top:t.y+this.$error[0].clientHeight/4+"px",width:200*e+"px",height:40*e+"px",fontSize:14*e+"px"}):this.$error.hide()))},ke.prototype.redrawGraph=function(){this.network&&(this.network.setSize(this.$graph.width()+"px",this.$graph.height()+"px"),this.network.redraw()),this.onResize()},ke.prototype.removeEdge=function(e,t){var i=this.edges[e];void 0!==i&&i.splice(i.indexOf(t),1),void 0!==(i=this.edgesR[t])&&i.splice(i.indexOf(e),1)},ke.prototype.renderGraph=function(){var e=this;this.network&&(this.network.destroy(),delete this.network);var t={interaction:{dragNodes:!0,dragView:!0,hover:!0,multiselect:!0,selectConnectedEdges:!0},layout:{hierarchical:{blockShifting:!0,direction:this.getDirection(),edgeMinimization:!0,enabled:!0,levelSeparation:this.api.getProperty(ke.PROP_LEVELSEPARATION),nodeSpacing:this.api.getProperty(ke.PROP_NODESPACING),parentCentralization:!0,sortMethod:"directed",treeSpacing:20},improvedLayout:!0},physics:!1};t.layout.hierarchical.treeSpacing=50;try{this.network=new o.Network(this.$graph[0],this.mapDataAttributes(),t),this.network.on("afterDrawing",function(){e.positionErrorNode()}),this.api.getProperty("Basics.Selected")&&this.nodes[this.api.getProperty("Basics.Selected")]?this.selectNode(this.api.getProperty("Basics.Selected")):this.selectNode(""),this.dialog&&this.dialogNode&&this.dialog.setNode(this.nodes[this.dialogNode.id]),this.listenToNetwork()}catch(e){c.Log.Error("Render Graph Error",e)}},ke.prototype.renderLabels=function(){var t=this;this.network&&_.each(this.nodes,function(e){t.network.body.data.nodes.update({id:e.id,title:e.description()||void 0,label:e.icon()+" "+e.teaser()})})},ke.prototype.resizeSideDialog=function(){this.dialog&&this.dialog.onResize&&this.dialog.onResize()},ke.prototype.selectNode=function(e){(e=void 0===e?"":e)&&"result"!==e&&this.network&&this.network.selectNodes([e]),this.setSelectedNode(e)},ke.prototype.setSelectedNode=function(e){this.selectedNode=this.nodes[e=void 0===e?"":e]||null,this.api.setProperty(ke.PROP_SELECTED,e),this.updateQIPC()},ke.prototype.showContextMenu=function(e){var t,i,n,a,s,o=this;this.network&&(a=this.network.getNodeAt(e.pointer.DOM)||"result",t=this.$el.find(".custom-menu"),s=[],"result"!==(n=(i=this.nodes[a]).group)&&("join"!==n||1<this.edgesR[a].length)&&s.push({id:n,text:"Edit "+_.capitalize(i.group),icon:"fa fa-edit contextIcon"}),("result"===n&&0===this.countR(a)||"join"===n&&this.countR(a)<2)&&(s.push({id:"+data",text:"Add Data Source",icon:"fa fa-plus contextIcon"}),s.push({id:"function+",text:"Add Function Source",icon:"fa fa-plus contextIcon"})),"result"===n&&0===this.countR(a)||(s.push({id:"+filter",text:"Add Filter",icon:"fa fa-plus contextIcon"}),s.push({id:"+update",text:"Add Update",icon:"fa fa-plus contextIcon"}),s.push({id:"+groupBy",text:"Add Group By",icon:"fa fa-plus contextIcon"}),s.push({id:"+join",text:"Add Join",icon:"fa fa-plus contextIcon"}),s.push({id:"+function",text:"Add Function",icon:"fa fa-plus contextIcon"})),("join"===n?1===this.countR(a)&&1===this.count(a):"data"!==n&&"function"!==n&&"stream"!==n||0!==this.countR(a)?"result"!==n:"join"===(n=this.nodes[this.edges[a][0]]).group&&2<=this.countR(n.id))&&s.push({id:"delete",text:"Delete",icon:"fa fa-times contextIcon"}),this.selectNode(a),t.html(F.menu(s)),a=e.pointer.DOM.x,(s=e.pointer.DOM.y)+t.height()>this.$graph.height()&&(s-=t.height()),a+t.width()>this.$graph.width()&&(a-=t.width()),e=this.$graph.closest(".section").position(),t.finish().toggle(10).css({left:e.left+Math.max(a,0)+"px",top:e.top+Math.max(s,0)+"px"}),t.find("li").click(function(e){e=$(e.currentTarget).attr("data-index");o.doCommand(e),$(".custom-menu").hide(100)}))},ke.prototype.toggleHelpfulTip=function(){var e,t=_.first(_.keys(this.nodes).filter(function(e){return _.includes(e,"data")}).sort())||"data0",i=2===_.keys(this.nodes).length,n=_.isEmpty(this.nodes[t].data);!i||!n||this.sideDialog||"Pop-up"===this.api.getProperty(ke.PROP_DIALOGPLACEMENT)||(e=this.nodes[t])&&(this.selectedNode!==e&&this.selectNode(t),this.doCommand(e.group)),this.$el.find(".helpful-tip").toggle(i&&"Pop-up"!==this.api.getProperty(ke.PROP_DIALOGPLACEMENT)).find("span").text(n?"Select a data source to begin building a query":"Right-click on a node for more options")},ke.prototype.toggleSaveButton=function(e,t,i){t.toggle(!i),e.toggleClass("auto-save",i)},ke.prototype.toggleSideDialog=function(e){this.sideDialog=e,this.$sideDialog.toggle(e),this.expandSideDialog(e)},ke.prototype.topoSortedNodes=function(i,n){var t=[],a=function(e){var t=[];return n[e]?_.each(n[e],function(e){e=a(e);t.push(e)}):t.push(e),t.sort()[0]},s=function(e){t.push(e);e=_.sortBy(n[e],a);_.each(e,function(e){-1===t.indexOf(e)&&s(e)})};return s("result"),_.reduce(t,function(e,t){return e[t]=i[t],e},{})},ke.prototype.update=function(e){this.isSaving=!e||this.isSaving,this.updateJSON(),e&&!this.isSaving&&this.sideDialog&&this.closeSideDialog(),this.isSaving=!!e&&this.isSaving,this.updateQIPC()},ke.prototype.updateJSON=function(){var e={nodes:this.topoSortedNodes(this.nodes,this.edgesR),edges:_.fromPairs(_.map(this.edges,function(e,t){return[t,_.sortBy(e)]}))},t=this.api.getProperty(ke.PROP_JSON);if(t)try{var i=JSON.parse(t);_.each(e.nodes,function(e,t){i.nodes[t]&&i.nodes[t].subscription&&(e.subscription=i.nodes[t].subscription)})}catch(e){}this.api.setProperty(ke.PROP_JSON,this.decodeHTML(JSON.stringify(e)))},ke.prototype.updateNode=function(e){this.update(),this.updateMeta(e)},ke.prototype.updateQIPC=function(){var e=ke.graphToIPC(this.nodes,this.edges,this.api.getProperty(ke.PROP_SELECTED));this.api.setProperty(ke.PROP_qIPC,e)},ke.getComponentDefinition=g.getComponentDefinition,ke.getSettingsModel=g.getSettingsModel,ke.PROP_DATA="Basics.Data",ke.PROP_CONN="Basics.Connection",ke.PROP_DIRECTION="Basics.Direction",ke.PROP_DIALOGPLACEMENT="Basics.DialogPlacement",ke.PROP_AUTOSAVE="Basics.AutoSave",ke.PROP_READONLY="Basics.ReadOnly",ke.PROP_FORCESELECT="Basics.ForceSelection",ke.PROP_SELECTED="Basics.Selected",ke.PROP_JSON="Basics.JSON",ke.PROP_qIPC="Basics.qIPC",ke.PROP_BINDINGS="Bindings",ke.PROP_LEVELSEPARATION="Style.LevelSeparation",ke.PROP_NODESPACING="Style.NodeSpacing",ke});