define(["Handlebars","QuickBase","moment","xlsx","chartjs","backbone","css!./css/app.css"],function(b,h,s,e,a,i){"use strict";var o,r,n=this&&this.__extends||(o=function(t,e){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var a in e)e.hasOwnProperty(a)&&(t[a]=e[a])})(t,e)},function(t,e){function a(){this.constructor=t}o(t,e),t.prototype=null===e?Object.create(e):(a.prototype=e.prototype,new a)}),l=this&&this.__assign||function(){return(l=Object.assign||function(t){for(var e,a=1,o=arguments.length;a<o;a++)for(var i in e=arguments[a])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)},c=(r=i.DeepModel,n(d,r),d.prototype.initialize=function(){this.labelPlugin={afterDatasetsUpdate:function(e){_.each(e.config.layers.models,function(t){t.setPopoutSegment(e)})},beforeDraw:function(t){function e(c,t,d,p,h,u,f){for(var e=1.2*c.measureText("M").width,a=t?t.split("<br>"):"",g={style:{}},o=0;o<a.length;++o)!function(t){var t=a[t].split("</span>"),l=0;_.each(t,function(t){var e=/(<([^>]+)>)/gi;if(e.test(t)){var a=$(t);if(a&&a.attr("style"))for(var o,i,r,a=a.attr("style"),n=void 0===a?[]:a.split(";"),s=n.length;s--;)o=n[s].split(":"),i=$.trim(o[0]),r=$.trim(o[1]),0<i.length&&0<r.length&&(g.style[i]=r)}e=t.replace(e,"");c.fillStyle=_.get(g,"style.color")?_.get(g,"style.color"):h,c.font=g.style["font-size"]?g.style["font-size"]+" "+f:u+"px "+f,c.fillText(e,d+l,p),l=c.measureText(e).width}),p+=e}(o)}var a,o,i,r,n,s,l,c,d,p;t.config.options.elements.center&&(a=t.chart.ctx,i=(o=t.config.options.elements.center).fontSize,r=o.fontStyle||"Arial",n=o.text,s=o.color||"#000",l=(o.sidePadding||20)/100*(2*t.innerRadius),a.font=i+"px "+r,c=a.measureText(n).width,l=2*t.innerRadius-l,l=Math.floor(i*(l/c)),c=2*t.innerRadius,l=i||Math.min(l,c),a.textAlign="center",a.textBaseline="middle",c=(t.chartArea.left+t.chartArea.right)/2,t=(t.chartArea.top+t.chartArea.bottom)/2,a.font=l+"px "+r,a.fillStyle=s,"fontawesome"===o.fontStyle?a.fillText((d=n,(p=document.createElement("i")).className="fa fa-"+d,p.style.display="none",document.body.appendChild(p),d=window.getComputedStyle(p,":before").getPropertyValue("content"),document.body.removeChild(p),d.replace(/([.\"])/g,"")),c,t):e(a,n,c,t,s,l,r))}}},d.prototype.setPopoutSegment=function(t,e){var a,o=this;this.resetLayerPopout(t),0<t.data.datasets.length&&(e=_.isNaN(e)?e:-1,_.each(t.config.dataSource,function(t){t=_.find(t.getData().models,function(t){return t.get(o.get("Basics.SelectedAttr"))===o.get("Basics.Selected")});t&&null!==t.id&&(e=t.id)}),-1===e||(a=t.getDatasetMeta(0).data[e])&&this.get("Basics.PopoutSelected")&&(a._model.outerRadius=t.outerRadius+parseFloat(this.get("Basics.PopoutSelectedSize")),a._model.innerRadius=t.innerRadius+parseFloat(this.get("Basics.PopoutSelectedSize"))))},d.prototype.resetLayerPopout=function(e){this.get("Basics.PopoutSelected")&&0<e.data.datasets.length&&_.each(e.getDatasetMeta(0).data,function(t){t._model.outerRadius=e.outerRadius,t._model.innerRadius=e.innerRadius})},d.prototype.computeConfigProps=function(){var t=void 0===this.get("DataSet.DonutRatio")?35:this.get("DataSet.DonutRatio"),e=void 0===this.get("DataSet.Circumference")?100:this.get("DataSet.Circumference"),a=void 0===this.get("DataSet.Rotation")?50:this.get("DataSet.Rotation"),o=this.get("InnerLabel.labelPosition");return this.get("InnerLabel.ShowPieceLabel")?{cutoutPercentage:t,circumference:this.calcRange(e,0,2)*Math.PI,rotation:(this.calcRange(a,0,2)-1)*Math.PI,labelPosition:o,pieceLabel:this.computePieceLabel(),elements:this.computeElementCenter()}:{cutoutPercentage:t,circumference:this.calcRange(e,0,2)*Math.PI,rotation:(this.calcRange(a,0,2)-1)*Math.PI,labelPosition:o,elements:this.computeElementCenter()}},d.prototype.updateData=function(i){var e,t,r=this;i?(this.setPreviousChartData(),this.chartData={},this.dataSource=i,void 0!==(t=this.get("DataSet.Label"))&&(t=0===t.indexOf("/")?t.substring(1):"^"+t.replace(/\*/g,"(.*)")+"$",e=new RegExp(t),t=i.getColumnNames().filter(function(t){return t.match(e)}),_.each(t,function(o){_.each(r.get("DataSet.Layers"),function(t){var e,a=t.Segment;void 0!==a&&(a=0===a.indexOf("/")?a.substring(1):"^"+a.replace(/\*/g,"(.*)")+"$",e=new RegExp(a),a=i.getColumnNames().filter(function(t){return t.match(e)}),r.labelData=i.getData().map(function(t){return t.get(i.getPropertyFromColumn(o))}),_.each(a,function(e){r.chartData[r.getDisplayName(e)]={data:_.map(i.getData().models,function(t){return t.get(e)}),color:t.Color||i.api.getProperty("DataSet.Layers.0.Color"),borderColor:t.BorderColor||i.api.getProperty("DataSet.Layers.0.BorderColor"),colorOpacity:t.ColorOpacity||i.api.getProperty("DataSet.Layers.0.ColorOpacity"),usePallette:t.UseColor}}),r.updateVisuals())})})),this.updateVisuals()):this.initialize()},d.prototype.updateVisuals=function(){var t=this.computeDataSetProps(),e=this.computeConfigProps();this.dataset=_.map(t,function(t){return _.extend({},e,t)})},d.prototype.setPreviousChartData=function(){this.previousChartData=_.extend({},this.chartData)},d.prototype.calcRange=function(t,e,a){return e+t/100*(Math.abs(a)-Math.abs(e))},d.prototype.computeDataSetProps=function(){var i=this;return _.map(this.chartData,function(t,e){0;var a=i.getBackgroundColor(t.usePallette,t.color,t.colorOpacity),o=_.isString(t.borderColor)&&""===t.borderColor?a:t.borderColor;return{label:i.labelData,id:i.id,data:t.data,backgroundColor:i.computeHightlightColor(a,t.colorOpacity,t,e),borderColor:o,defaultBackgroundColor:a,defaultBorderColor:o}})},d.prototype.computeElementCenter=function(){return{center:{text:this.get("InnerLabel.Innertitle"),color:this.get("InnerLabel.InnertitleColor"),fontStyle:this.get("InnerLabel.InnertitleFont"),fontSize:this.get("InnerLabel.InnertitleSize"),sidePadding:15}}},d.prototype.computePieceLabel=function(){var t=this.get("InnerLabel"),e=t.Precision,a=t.HideTrailingZeroes,o=t.DateFormat,i=t.Format,r=t.PieceLabelRender,n=t.Prefix,s=t.Suffix,l=t.PieceLabelArc,c=t.PieceLabelOverlap,d=t.ShowZero,p=t.FontSize,h=t.PieceLabelColor,u=t.PieceLabelPosition,f=t.PieceLabelTemplate,g=B.getFormatter(i,e,a,o),m=this.dataSource,y=m?m.getData():null;return{precision:e||0,showZero:d,fontSize:p,fontColor:h,fontStyle:"normal",fontFamily:"'Helvetica Neue', 'Helvetica', 'Arial', sans-serif",arc:l,position:u,overlap:c,render:function(t){var e=t[r];if(f){var a,o,i=b.compile(f);try{y&&0<y.models.length&&y.models[t.index]&&(a=_.assignIn(t,y.models[t.index].attributes),m&&(o=m.api.getTemplateViewStates(f),e=i(_.assignIn(a,o))))}catch(t){console.log("Handlebar Error",t)}return e}if(_.indexOf(["percentage","value","label"],r)<0){i=b.compile(r);e=r;try{y&&0<y.models.length&&y.models[t.index]&&(e=i(y.models[t.index].attributes))}catch(t){console.log("Handlebar Error",t)}t.advanced=e}return"Invalid date"===(e=g(e))&&(e=t[r]),n+e+s}}},d.prototype.getBackgroundColor=function(t,e,a){a=t?this.getColorScheme(a):B.alpha(e,a);return a},d.prototype.computeHightlightColor=function(t,e,a,o){_.extend([],t);return this.computeHighlightRules(t,e,"RuleColor",o)},d.prototype.getColorScheme=function(e){var a=[];if(_.each(_.map(this.get("Style.chartBarColors"),"type"),function(t){a.push(B.alpha(t,e))}),0<a.length&&a.length<this.labelData.length)for(var t=_.extend([],a),o=0;o<=this.labelData.length/t.length+1;o++)a=_.concat(a,t);return a},d.prototype.getDisplayName=function(t){var e=t,a="";return e=(a=_.fromPairs(_.map(this.get("DataSet.Layers"),function(t){return[t.Segment,t.Display]}))[t])?a:e},d.prototype.computeHighlightRules=function(n,s,l,c){var a,o,d=this,p=[],i=0,t=_.map(this.get("DataSet.Layers"),"Segment"),e=this.get("Basics"),r=e.Focus,e=e.Data,r=r?_.first(B.focus2Array(r)):[],h=void 0===r?0:r.length;e.dataSet&&e.dataSet.breakdownColumns&&(o=e.dataSet.breakdownColumns),_.get(o,"attributes")&&(o=o.get("value")),0<=_.indexOf(t,c)?i=_.indexOf(t,c):_.each(t,function(t,e){t.match(c)&&(i=e)});var u,f="DataSet.Layers."+i+".HighlightRules";return this.chartData[c]&&this.dataSource&&(u=this.dataSource,_.each(u.api.getProperty(f),function(t,r){var e=u.api.getProperty(f+"."+r+".RuleSource");e?("{breakdownId}"===t.RuleSource&&(e=o&&o[h]?o[h]:t.RuleSource),d.dataSource&&(a=d.dataSource.getData().pluck(e))):a=_.get(d.chartData[c],"data"),a&&0<a.length&&_.each(a,function(t,e){var a,o,i;d.dataSource&&(a=d.dataSource.api.getProperty(f+"."+r+".RuleValue"),o=d.dataSource.api.getProperty(f+"."+r+"."+l),i=d.dataSource.api.getProperty(f+"."+r+".RuleOperation"),"previous"===a&&(a=d.getPreviousChartData(c,e)),i=B.getConditionResult(t,a,i),p[e]?p[e]=i?B.alpha(o,s):p[e]:i?p.push(B.alpha(o,s)):p.push("string"==typeof n?n:n[e]))})})),0<f.length&&0<p.length?p:n},d.prototype.getPreviousChartData=function(t,e){if(this.previousChartData&&this.previousChartData[t]){e=_.get(this.previousChartData[t],"data")[e];if(e)return e}},d);function d(){var t=null!==r&&r.apply(this,arguments)||this;return t.colorCache={},t.columns=[],t.labels=[],t.chartData={},t.labelData=[],t.chartType="pie",t.previousChartData={},t}var p,u=(p=i.Collection,n(f,p),f.prototype.modelId=function(t){return t},f);function f(){var t=null!==p&&p.apply(this,arguments)||this;return t.model=c,t}var g,m=(g=i.DeepModel,n(y,g),y.prototype.initialize=function(){},y.prototype.toPieJSON=function(){return _.chain(this.toJSON()).toPairs().reduce(function(t,e){return t[e[0].toLowerCase()]=e[1],t},{}).value()},y.Enabled=!1,y);function y(){return null!==g&&g.apply(this,arguments)||this}var S=(v.sourceKey=function(t){return t.getPath()},v.mergeChanges=function(e,a,t,o,i,r){return t&&(e=_.fromPairs(_.map(t,function(t){return[a(t),t]}))),o&&_.each(o,function(t){return _.extend(e[a(t)],t)}),i&&_.each(i,function(t){e[a(t)]=t}),r&&_.each(r,function(t){delete e[a(t)]}),e},v.prototype.setFocus=function(t){this.focus=t,this.updateChildren(),this.childDataSource&&this.childDataSource.setFocus(t)},v.prototype.getColumnNames=function(){if(this.breakdownColumns&&this.breakdownColumns.length)return[v.BREAKDOWN_ID,this.breakdownColumns[0]].concat(_.difference(_.keys(this.meta),this.breakdownColumns));try{return _.map(this.meta,function(t){return[t.id,t.index]}).sort(function(t,e){return t[1]-e[1]}).map(function(t){return t[0]})}catch(t){return _.keys(this.meta)}},v.prototype.getColumnType=function(t){return this.childDataSource?this.childDataSource.getColumnType(t):t===v.BREAKDOWN_ID&&this.primaryKey?this.meta[this.primaryKey].kdbType:this.meta[t]?this.meta[t].kdbType:11},v.prototype.getData=function(){return this.childDataSource?this.childDataSource.getData():this.source.dataSet&&this.source.dataSet.collection},v.prototype.getDepth=function(){return this.childDataSource?this.childDataSource.getDepth():this.depth},v.prototype.getKey=function(){return this.source.cid},v.prototype.getPrimaryKey=function(){return this.childDataSource?this.childDataSource.getPrimaryKey():this.primaryKey},v.prototype.getPropertyFromColumn=function(t){return t===v.BREAKDOWN_ID?this.getPrimaryKey():t},v.prototype.getPath=function(){return this.source.path},v.prototype.getSource=function(){return this.source},v.prototype.hasData=function(){return this.childDataSource?this.childDataSource.hasData():this.hasDataFlag},v.prototype.onData=function(t,e,a){t.primaryKey!==this.primaryKey&&(this.primaryKey=t.primaryKey);var o=t.columns,i=o.reset,r=o.change,n=o.add,o=o.remove;this.meta=v.mergeChanges(this.meta,function(t){return t.id},i,r,n,o),0!==this.depth||_.isEqual(t.breakdownColumns,this.breakdownColumns)||(this.breakdownColumns=t.breakdownColumns,this.removeChild()),e.reset&&0<e.reset.length&&this.removeChild(),a&&this.updateError(this,a),this.hasDataFlag=!0,this.updateChildren()&&this.listener.updateDataSource(this)},v.prototype.subscribe=function(){this.api.subscribe(this.source,this.onData.bind(this))},v.prototype.updateDataSource=function(){this.listener.updateDataSource(this)},v.prototype.updateError=function(t,e){this.listener.updateError(this,e)},v.prototype.unsubscribe=function(){this.childDataSource&&(this.childDataSource.unsubscribe(),delete this.childDataSource),this.api.unsubscribe(this.source)},v.prototype.removeChild=function(){this.childDataSource&&(this.childDataSource.unsubscribe(),delete this.childDataSource)},v.prototype.updateChildren=function(){var t;return!(this.breakdownColumns&&this.breakdownColumns.length&&this.depth<this.breakdownColumns.length-1)||(this.focus.length>this.depth?(this.childDataSource&&this.focus[this.depth]!==this.childDataSource.getSource().id&&this.removeChild(),this.childDataSource||(0!==this.depth&&(this.focus[this.depth-1],this.source.id),(t=this.source.dataSet&&this.source.dataSet.collection.get(this.focus[this.depth]))&&(this.childDataSource=new v(t,this,this.api,this.focus,this.depth+1,this.breakdownColumns),this.childDataSource.subscribe()))):(this.removeChild(),this.focus.length!==this.depth||!this.hasDataFlag||0!==this.depth&&this.focus[this.depth-1].toString()!==this.source.id.toString()||this.listener.updateDataSource(this)),!1)},v.BREAKDOWN_ID="{breakdownId}",v);function v(t,e,a,o,i,r){this.breakdownColumns=[],this.hasDataFlag=!1,this.focus=[],this.meta={},this.source=t,this.listener=e,this.api=a,this.depth=i||0,this.breakdownColumns=r,this.setFocus(o)}var x,C=(x=i.DeepModel,n(D,x),D.prototype.initialize=function(t){this.el=t.el,this.api=t.api,this.computeHighlightRulesHTML()},D.prototype.computeHighlightRulesHTML=function(){var o=[],t="",i=this.api;_.each(this.api.getProperty("DataSet.Layers"),function(t,a){_.each(t.HighlightRules,function(t,e){t.Show&&o.push({layer:i.getProperty("DataSet.Layers."+a+".Basics.Name"),ruleName:i.getProperty("DataSet.Layers."+a+".HighlightRules."+e+".RuleName"),ruleColor:i.getProperty("DataSet.Layers."+a+".HighlightRules."+e+".RuleColor"),ruleBorder:i.getProperty("DataSet.Layers."+a+".HighlightRules."+e+".RuleBorderColor")})})}),0<o.length&&(t=Y.highlighRule(o)),this.el.find(".highlight-rules-dialog").html(t)},D);function D(){return null!==x&&x.apply(this,arguments)||this}var w,P=(w=i.DeepModel,n(L,w),L.prototype.initialize=function(t){this.chart="function"==typeof Chart?Chart:window.Chart,this.externalDiv=t.externalDiv,this.toolsEnabled=!1,this.app=t.app},L.prototype.computeLegendProp=function(){var c=this.chart.helpers,o=this.app,i=this.get("Mode");return{display:!this.get("LegendScroll")&&this.get("Display"),position:this.get("Position")?this.get("Position"):"top",fullWidth:!!this.get("FullWidth"),reverse:!!this.get("Reverse"),labels:{boxWidth:this.get("BoxWidth"),fontSize:parseFloat(this.get("LabelFontSize"))||0,fontColor:this.get("LabelColor"),fontFamily:"'Helvetica Neue', 'Helvetica', 'Arial', sans-serif",padding:this.get("Padding"),usePointStyle:this.get("UsePointStyle"),generateLabels:function(s){var l=s.data;return l.labels.length&&l.datasets.length?l.labels.map(function(t,e){var a=s.getDatasetMeta(0),o=l.datasets[0],i=a.data[e],r=i&&i.custom||{},n=c.getValueAtIndexOrDefault,i=s.options.elements.arc;return{text:t,fillStyle:r.backgroundColor||n(o.defaultBackgroundColor,e,i.backgroundColor),strokeStyle:r.borderColor||n(o.defaultBorderColor,e,i.borderColor),lineWidth:r.borderWidth||n(o.borderWidth,e,i.borderWidth),hidden:isNaN(o.data[e])||a.data[e].hidden,index:e}}):{}}},onClick:function(t,e){var a;"Select Only"===i?o.onClick(e.index):(a=e.index,(e=o.chart).data.datasets.forEach(function(t){_.each(t._meta,function(t){var e=t.data[a];t.data&&t.data[a]&&(e.hidden=!e.hidden)})}),e.update())}}},L.prototype.renderhtmlLegend=function(a){var t=this;this.get("LegendScroll")&&this.get("Display")?(this.externalDiv.html(this.computeLegendHTML(a.legend.legendItems)),this.externalDiv.find("ul > li").on("click",function(){var e=$(t.externalDiv).index();a.options.legend.reverse&&(e=a.legend.legendItems.length-1-e),$(t).toggleClass("strike"),_.each(a.data.datasets,function(t){_.each(t._meta,function(t){t.data[e].hidden=!t.data[e].hidden}),a._meta&&a._meta.data&&a._meta.data[e]}),a.update()}),this.computehtmlLegendStyle()):this.externalDiv.html("")},L.prototype.computePaddingAdjustment=function(){var t=this.get("Position"),e=this.toolsEnabled?30:0;return this.computehtmlLegendStyle(),this.get("LegendScroll")&&this.get("Display")?{top:"top"===t?30+e:50,left:"left"===t?100:0,right:"right"===t?100:0,bottom:"bottom"===t?60:5}:{top:e||5,left:0,right:0,bottom:0}},L.prototype.computehtmlLegendStyle=function(){var t=this.toolsEnabled?30:0;this.get("LegendScroll")?("bottom"===this.get("Position")?this.externalDiv.css({bottom:0,top:"",left:"",right:"",width:"auto",height:"30px"}):"top"===this.get("Position")?this.externalDiv.css({top:t||10,bottom:"",left:"",right:"",width:"auto",height:"30px"}):"left"===this.get("Position")?this.externalDiv.css({top:t||10,bottom:"",left:0,right:"",width:"100px",height:"auto"}):"right"===this.get("Position")&&this.externalDiv.css({top:t||10,bottom:"",left:"",right:5,width:"100px",height:"auto"}),this.externalDiv.css({color:this.get("LabelColor"),"font-size":this.get("LabelFontSize"),"font-family":"'Helvetica Neue', 'Helvetica', 'Arial', sans-serif"}),this.externalDiv.find("span").css({width:this.get("BoxWidth"),"margin-right":this.get("Padding")+"px","margin-left":this.get("Padding")+"px"})):this.externalDiv.css({top:"",bottom:20,left:"",right:""})},L.prototype.computeLegendHTML=function(t){return Y.externalLegend(t)},L);function L(){var t=null!==w&&w.apply(this,arguments)||this;return t.toolsEnabled=!0,t}var E,F=(E=i.DeepModel,n(k,E),k.prototype.toPieJSON=function(){return _.chain(this.toJSON()).toPairs().reduce(function(t,e){return t[e[0].toLowerCase()]=e[1],t},{}).value()},k.prototype.customTooltip=function(t,e,a){var o,i=t._model,r=t._view,n={},s=this.api.getProperty("Style.advancedTooltip"),l=_.get(t,"_chart.active[0]._datasetIndex");this.tooltip&&(this.api.removeTooltip(),delete this.tooltip),i.dataPoints&&(o=i.dataPoints[0].index,i&&(n=this.getHandleBarParams(a,t,o,l)),this.tooltip=this.api.setTooltip({data:n,text:s,anchorEl:t._chart.canvas,position:{left:r.caretX||t._eventPosition.x,top:r.caretY||t._eventPosition.y}}))},k.prototype.getHandleBarParams=function(s,l,c,d){var a={},p=s.get("Basics.Data").dataSet.collection,t=p.models[0],t=_.get(t,"attributes")?t.attributes:{},h=[];return _.each(l._data.datasets,function(t,e){var a=l._chart.getDatasetMeta(e),o=_.sum(_.map(t.data,function(t,e){return a.data[e].hidden?0:parseFloat(t)})),i=parseFloat(t.data[c]),r=Object.keys(s.chartData)[e],n=s.get("DataSet.Layers."+e+".Segment");void 0!==d&&d!==e||(e=p.models[c],h.push({color:_.isArray(t.backgroundColor)?t.backgroundColor[c]:t.backgroundColor,cols:e?e.attributes:{},isLayerEnabled:!0,label:t.label[c],layerData:i,layerDataFormatted:t.label[c],layerName:""===r?n:r,percent:i/o*100,value:i}))}),_.each(t,function(t,e){a[e]=t}),_.extend({dataSet:h,points:h},a)},k.Enabled=!1,k);function k(t){var e=E.call(this,t)||this;return e.api=t,b.registerHelper("toFixed",function(t,e){return parseFloat(t).toFixed(e)}),b.registerHelper("commaFormat",function(t){return t.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}),b.registerHelper("smartNumber",function(t){t=parseFloat(t);return isNaN(t)?t:h.Tools.smartFormatNumber(t,0)}),e}var T,O=(T=i.DeepModel,n(M,T),M.prototype.computeLayoutProp=function(t){var e=void 0===this.get("Padding.Top")?0:this.get("Padding.Top"),a=void 0===this.get("Padding.Left")?0:this.get("Padding.Left"),o=void 0===this.get("Padding.Bottom")?0:this.get("Padding.Bottom"),i=void 0===this.get("Padding.Right")?0:this.get("Padding.Right");return{padding:{top:e+t.top,left:a+t.left,right:i+t.right,bottom:o+t.bottom}}},M);function M(){return null!==T&&T.apply(this,arguments)||this}"function"!=typeof Object.assign&&Object.defineProperty(Object,"assign",{value:function(t){if(null===t)throw new TypeError("Cannot convert undefined or null to object");var a=Object(t);return _.each(arguments,function(t){if(null!==t)for(var e in t)Object.prototype.hasOwnProperty.call(t,e)&&(a[e]=t[e])}),a},writable:!0,configurable:!0});var B=(R.cache=function(l,c,d,p){var t;_.isArray(d.load)&&(t=d.load.reduce(function(t,e,a){if(!l.cache)return t;var o,i,r,n,s=l.cache[e];return s.get("_viewType")&&(s=(o=s).get("value"),i=(n=(c+e).split(".")).pop(),r=n.join("."),n={},i&&(n[i]=o,p.setProperty(r,n,{bypass:!0}))),t[e]=s||d.defaults&&d.defaults[a],t},{}),l.set(t)),_.isArray(d.store)&&(t=d.store.reduce(function(t,e){var a=(c+e).split("."),o=a.pop();return o&&(t[e]=p.getProperty(a.join("."))[o]),t},{}),_.extend(l.cache,t),t=d.store.reduce(function(t,e){return t[e]=void 0,t},{}),l.set(t))},R.expandNestedViewStates=function(t,e){var a=/([a-zA-Z]+)\.[0-9]+\./,o=Object.keys(t),i=[];if((i=_.every(o,function(){var t=e.getPropertyMeta(o[0]);return t&&"viewstate"===t.type})?_.uniq(_.filter(_.map(o,function(t){t=a.exec(t);return t?t[1]:null}))):i).length){var r={};return _.each(i,function(t){return r[t]=e.getProperty(t)}),r}return t},R.focus2Array=function(t){var e=[],a=/"([^"]*)"/g,t=t.toString?t.toString():"",o=/^\[([^\]]*)]$/.exec(t);if(null!==o){if(/^(?:"[^"\\]*(?:\\[\S\s][^"\\]*)*")(?:,"[^"\\]*(?:\\[\S\s][^"\\]*)*")*/.test(o[1]))for(var i=void 0;null!==(i=a.exec(o[1]));)e.push(_.map(i[1].split(","),function(t){return t.replace(/&#44;/g,",")}))}else e.push(t.split(","));return _.filter(e,function(t){return 0<(""+t).length})},R.getConditionResult=function(t,e,a){var o,i,r={isMatch:function(t,e){var a,o=!1,i=t.split(/ +and +| +/);for(_.includes(i,"or")&&(i=_.without(i,"or"),o=!0),a=0;a<i.length;a++)0!==i[a].indexOf("-")&&i[a].indexOf("*")<0&&(i[a]="*"+i[a]+"*");return _[o?"some":"every"](i,function(t){return r.isSimpleMatch(t,e)})},isSimpleMatch:function(t,e){var a=!1;0===t.indexOf("-")&&(t=t.replace("-",""),a=!0);e=new RegExp("^"+t.replace(/\*/g,".*")+"$").test(e);return a?!e:e}},n=!1,s=isNaN(parseFloat(t))||_.isObject(t)?(""+t).toLowerCase():parseFloat(t),l=isNaN(parseFloat(e))||_.isObject(e)?(""+e).toLowerCase():parseFloat(e);switch(t&&t.class&&0<=["1212","1213","1214","1215"].indexOf(t.class)?(s=h.Tools.convertKDBTemporalToMoment(t).unix(),"in"===a?(o=[],_.each(e.toString().split(","),function(t){o.push(h.Tools.convertDateStringValueToMoment(t).unix()),l=o.toString()})):l=h.Tools.convertDateStringValueToMoment(e).unix()):t&&t.class&&0<=["1216","1217","1218","1219"].indexOf(t.class)&&(s=h.Tools.convertKDBTemporalToMoment(t).valueOfNano(),"in"===a?(i=[],_.each(e.toString().split(","),function(t){i.push(h.Tools.convertDateStringValueToMoment(t).valueOfNano()),l=i.toString()})):l=h.Tools.convertDateStringValueToMoment(e).valueOfNano()),a){case"contains":n=0<=s.toString().indexOf(l.toString());break;case"starts with":n=0===s.toString().indexOf(l.toString());break;case"ends with":n=-1!==s.toString().indexOf(l.toString(),s.toString().length-l.toString().length);break;case"==":n=s===l;break;case"<":n=s<l;break;case">":n=l<s;break;case"<=":n=s<=l;break;case">=":n=l<=s;break;case"!=":n=s!==l;break;case"in":n=0<=l.toString().split(",").indexOf(s.toString());break;case"search":n=r.isMatch(l,s);break;case"regexp":n=new RegExp(e.toString()).test(t?t.toString():"")}return n},R.isDuration=function(t){return _.get(t,"_kdbType")&&0<=["1216","1217","1218","1219"].indexOf(t._kdbType)},R.getFormatter=function(o,i,r,n){return"Number"===o||"Formatted Number"===o||"Smart Number"===o||"Datetime"===o||"Currency"===o||"SmartCurrency"===o?function(t){var e=t;if(null==(t=!("Smart Number"!==o&&"Formatted Number"!==o||_.isNumber(t))?_.isNumber(parseFloat(t))?parseFloat(t):t:t))return"";if("Smart Number"===o)e=_.isNumber(t)?h.Tools.smartFormatNumber(t,i):_.escape(t);else{if("Datetime"===o){var a=t;return s.isMoment(t)||s.isDuration(t)?(R.isDuration(t)?h.Tools.convertValueToMoment(t.valueOf()):t).format(n):h.Tools.isKDBTemporal(t)?h.Tools.convertKDBTemporalToMoment(t).format(n):("number"==typeof t&&(a=new Date(t)),h.Tools.convertDateStringValueToMoment(a.toString()).format(n))}e="Formatted Number"===o&&t.toFixed?_.isNaN(t)?"":h.Tools.formatNumber(t,i):t.toFixed?t.toFixed(i):_.escape(e)}if(r&&0<=e.toString().indexOf(".")){for(;"0"===e[e.length-1];)e=e.slice(0,-1);"."===e[e.length-1]&&(e=e.slice(0,-1))}return e}:"Boolean"===o?function(t){return _.escape(t)}:function(t){return s.isMoment(t)||s.isDuration(t)?t.format(n,void 0):_.escape(t)}},R.pump=function(a){if(null==a)return a;if(!_.isObject(a))return a;var t=Object.getPrototypeOf(a);if(_.isObject(a)&&t!==Object.prototype&&t!==Array.prototype)return a;if(t===Array.prototype&&_.isArray(a))return a.map(R.pump);var o=/^(\d+)((?:\.\w+)+)$/;if(Object.keys(a).every(function(t){return o.test(t)}))return Object.keys(a).map(function(t){var e=o.exec(t);return _.isNil(e)?{index:0,tail:void 0,value:void 0}:{index:Number(e[1]),tail:e[2].substring(1),value:a[t]}}).reduce(function(t,e){var a={},o=void 0===e.index?0:e.index;return a[o]={},a[o][e.tail]=e.value,$.extend(!0,t,R.pump(a))},[]);var i={greedy:/^(\w+)((?:\.\w+)*)$/,nonGreedy:/^(\w+)((?:\.\w+)+)$/};return Object.keys(a).some(function(t){return i.nonGreedy.test(t)})?Object.keys(a).map(function(t){var e=i.greedy.exec(t);return{head:_.isNil(e)?null:e[1],tail:_.isNil(e)||""===e[2]?null:e[2].substring(1),value:a[t]}}).reduce(function(t,e){var a={},o=null!==e.tail,i=_.isNil(e.head)?0:e.head,r=_.isNil(e.tail)?0:e.tail;return o?(a[i]={},a[i][r]=e.value):a[i]=e.value,$.extend(!0,t,R.pump(a))},{}):_.mapValues(a,R.pump)},R.replaceViewStatesWithValue=function(t,e,a){return R.replaceViewStates(t,e,function(t,e,a,o){return o.value!==a&&console.warn("viewModel value has changed"),o.value},a)},R.alpha=function(t,e){return new Color(t).alpha(e/100).rgbaString()},R.replaceViewStates=function(a,t,l,c){var d;return d=function(t,e){return function a(t,e,o){o=o?o+".":"";var i=c.getPropertyMeta(o+(e+="")),r=t&&t.has&&t.has("_dataSource")&&t.has("_dataType"),n=(_.isArray(t)||_.isObject(t))&&!r;if(i&&"data"===i.type)return t;if(i&&"viewstate"===i.type){var r=(s=(o+e).split(".")).pop(),s=s.join(".");return l(s,void 0===r?"":r,t,i)}return n?(o+=e,d=function(t,e){return a(t,e,o)},(_.isArray(t)?_.map:_.mapValues)(t,d)):t}(t,e,a||"")},(_.isArray(t)?_.map:_.mapValues)(t,d)},R);function R(){}var I={Trigger:{type:"string",enum:["Click","Hover"],default:"Click",title:"Trigger Action",propertyOrder:2,options:{hidden:!0}}},N=(A.getComponentDefinition=function(t){var e,a,o={id:1,componentName:"PieJS",componentDescription:"",version:"4.5.1",appArgs:{quickStart:[{path:"Basics.Data",message:"populate Data Source"}],json:{version:"4.5.1",Basics:{Data:"",Theme:"Dark",Focus:"",Selected:"",SelectedAttr:"",PopoutSelected:!1,PopoutSelectedSize:10,Actions:[]},DataSet:{Label:"",DonutRatio:50,Rotation:50,Circumference:100,BorderWidth:1,Layers:[{Segment:"",Display:"",UseColor:!0,Color:"#0061FF",BorderColor:"#ffffff",ColorOpacity:85,HighlightRules:[]}]},Legend:{Display:!0,FullWidth:!0,Reverse:!1,Position:"top",LabelColor:"#ffffff",LabelFontFamily:"Helvetica",LabelFontSize:12,BoxWidth:40,Padding:10,UsePointStyle:!0,Mode:"Toggle Hidden",LegendScroll:!1},InnerLabel:{Innertitle:"",InnertitleColor:"#ffffff",InnertitleFont:"Verdana",InnertitleSize:12,ShowPieceLabel:!1,ShowZero:!1,PieceLabelArc:!1,PieceLabelColor:"#ffffff",PieceLabelOverlap:!1,PieceLabelRender:"percentage",PieceLabelPosition:"default",PieceLabelTemplate:"",FontSize:10,Format:"General",Precision:2,HideTrailingZeroes:!1,Prefix:"",Suffix:"",DateFormat:"YYYY-MM-DD"},Padding:{Top:2,Bottom:2,Left:2,Right:2},Animations:{Enabled:!1},Style:{chartBarColors:[{type:"#0061FF"},{type:"#F23A66"},{type:"#009BAB"},{type:"#7647CC"},{type:"#FFC300"},{type:"#9FA3A6"},{type:"#003A99"},{type:"#A90B31"},{type:"#005D67"},{type:"#452481"}],advanced:"",advancedTooltip:'<div> <table>{{#each dataSet}} <tbody> {{#eq @index 0}} <tr> <td colspan="2">{{label}}</td> </tr> {{/eq}} <tr><td>{{xaxis}}</td> <td><svg style="width:20px;height:20px"> <circle fill="{{color}}" stroke-width="2" stroke="white" r="8" cy="10" cx="10"> </circle> </svg></td> <td>{{layerName}} :</td> <td>{{toFixed value 2}} ({{toFixed percent 2}}%)</td> </tr> {{/each}} </tbody> </table> </div>'},FileExport:{ShowScreenshot:!1,ShowExportCsvButton:!1,ShowExportExcelButton:!1,FileName:[]},possibleColumns:[""],possibleLabels:[""]},schema:{type:"object",title:"Properties",properties:{possibleLabels:{type:"array",propertyOrder:1,format:"table",default:["sym"],options:{collapsed:!0,hidden:!0}},possibleColumns:{propertyOrder:2,type:"array",format:"table",default:["sym"],options:{collapsed:!0,hidden:!0}},possibleRules:{type:"array",propertyOrder:1,format:"table",default:[],options:{collapsed:!0,hidden:!0}},Basics:{type:"object",propertyOrder:3,title:"Basics",options:{collapsed:!1},properties:{Data:{type:"data",format:"string",title:"Data Source",default:""},Theme:{type:"string",title:"Theme",options:{hidden:!0},enum:["Light","Dark"]},DashboardTheme:{options:{hidden:!0}},Focus:{type:"viewstate",title:"Focus",default:""},Selected:{type:"viewstate",title:"Selected Value",default:""},SelectedAttr:{type:"string",title:"Selected Value Attribute",enumSource:"possible_labels",watch:{possible_labels:"root.possibleLabels"}},PopoutSelected:{type:"boolean",title:"Popout on selection",default:!1,format:"checkbox"},PopoutSelectedSize:{title:"Popout Size",default:10,minimum:1,maximum:100,type:"number",step:1,format:"range"},FixedColumn:{type:"string",title:"Column Def"},Actions:{type:"actions",options:{collapsed:!0},fields:{map:_.extend({Current:{title:"Source",type:"string",enumSource:"possible_columns",watch:{possible_columns:"root.possibleColumns"}},ViewstateProperty:{title:"Viewstate",type:"viewstate"}},I),nav:I,query:I,url:I}}}},DataSet:{type:"object",propertyOrder:4,title:"Data",options:{collapsed:!0},properties:{Label:{propertyOrder:1,default:"",title:"Series Key",type:"customDropdown",data:"possible_labels",watch:{possible_labels:"root.possibleLabels"}},DonutRatio:{title:"Cut out %",propertyOrder:2,default:35,minimum:1,maximum:100,type:"number",step:1,format:"range"},Rotation:{title:"Rotation",propertyOrder:3,default:50,minimum:0,maximum:100,type:"number",step:1,format:"range"},Circumference:{title:"Circumference",propertyOrder:4,default:100,minimum:0,maximum:100,type:"number",step:1,format:"range"},BorderWidth:{title:"Border Width",propertyOrder:5,default:1,minimum:0,maximum:10,type:"number",step:1,format:"range",options:{hidden:!0}},Layers:{type:"array",propertyOrder:8,format:"object",title:"Layers",uniqueItems:!1,options:{collapsed:!0,reset:!0},items:{type:"object",title:"Layer",properties:{Segment:{default:"",title:"Series Data",type:"customDropdown",data:"possible_columns",watch:{possible_columns:"root.possibleColumns"}},Display:{type:"string",default:"",title:"Display"},UseColor:{type:"boolean",title:"Use Colour Palette",default:!0,format:"checkbox"},Color:{type:"gradient",options:{gradient:!1},title:"Color",default:"#0061FF"},BorderColor:{title:"Border Color",type:"gradient",options:{gradient:!1,noColor:!0},default:"#ffffff"},ColorOpacity:{title:"Color Opacity",default:85,minimum:1,maximum:100,type:"number",step:1,format:"range"},HighlightRules:{type:"array",title:"Highlight Rules",options:{collapsed:!0},items:{type:"object",title:"Highlight Rule",properties:{RuleName:{type:"string",title:"Rule Name",default:""},RuleSource:{type:"string",title:"Rule Source",default:"",enumSource:"possible_cols",watch:{possible_cols:"root.possibleColumns"}},RuleOperation:{type:"string",title:"Rule Operation",default:"",enum:["","search","contains","starts with","ends with","==","<",">","<=",">=","!=","Fill Left-to-Right","Fill Right-to-Left"]},RuleValue:{type:"string",title:"Rule Value",data:"possible_columns",default:""},RuleColor:{title:"Rule Colour",type:"gradient",options:{gradient:!1,noColor:!1},default:"#ffffff"},RuleBorderColor:{title:"Rule Border Color",type:"gradient",options:{gradient:!1,noColor:!1},default:"#ffffff"},Show:{title:"Show Rule in Legend",type:"boolean",format:"checkbox",default:!1}}}}}}}}},Legend:{type:"object",title:"Legend",propertyOrder:5,options:{collapsed:!0},properties:{Display:{type:"boolean",format:"checkbox",default:!0},FullWidth:{type:"boolean",title:"Full Width",format:"checkbox",default:!0},Reverse:{type:"boolean",title:"Reverse Order",format:"checkbox",default:!1},Position:{type:"string",default:"top",enum:["top","bottom","left","right"]},LabelColor:{title:"Label Colour",type:"gradient",options:{gradient:!1},default:"#898989"},LabelFontFamily:{type:"string",title:"Label Font Family",options:{hidden:!0},enum:["Helvetica","Arial","Times New Roman","Times","Courier New","Courier","Verdana","Georgia","Palatino","Garamond","Comic Sans MS"],default:"Helvetica"},LabelFontSize:{type:"number",title:"Label Font Size",default:12},BoxWidth:{type:"number",title:"Legend Box Width",default:40},Padding:{type:"number",title:"Legend Box Padding",default:10},UsePointStyle:{type:"boolean",title:"Use Point Style",format:"checkbox",default:!0},LegendScroll:{type:"boolean",title:"Scrolling legends",format:"checkbox",default:!0},Mode:{type:"string",title:"Mode",enum:["Toggle Hidden","Select Only"],default:"Toggle Hidden"}}},Padding:{type:"object",title:"Padding",propertyOrder:5,options:{collapsed:!0},properties:{Left:{type:"number",default:2},Right:{type:"number",default:2},Top:{type:"number",default:2},Bottom:{type:"number",default:2}}},Style:{type:"object",propertyOrder:7,title:"Style",options:{collapsed:!0},properties:{chartBarColors:{type:"array",format:"table",title:"Colour Palette",propertyOrder:1,options:{collapsed:!1},uniqueItems:!1,items:{type:"object",title:"Bar Colour",properties:{type:{type:"gradient",options:{gradient:!1},title:"color",default:"#ffa500"}}},default:[{type:"#0061FF"},{type:"#7995b8"},{type:"#808387"},{type:"#a69775"},{type:"#749450"},{type:"#51966a"},{type:"#e2c7c0"},{type:"#9acad6"},{type:"#1995a3"},{type:"#484d6e"}]},advanced:{type:"css",title:"Advanced CSS",propertyOrder:2,default:""},advancedTooltip:{data:["xaxis","yaxis","key","color"],default:"",propertyOrder:3,title:"Custom tooltip",templateItems:{points:{type:"array",items:{layerName:"layerName",layerData:"layerData",layerDataFormatted:"layerDataFormatted",colors:{backgroundColor:"backgroundColor",borderColor:"borderColor"},cols:null,isLayerEnabled:"isLayerEnabled"}}},type:"tooltipTemplate"}}},FileExport:{type:"object",propertyOrder:320,title:"File Export",options:{collapsed:!0},properties:{ShowExportCsvButton:{type:"boolean",title:"Show Export Csv Button",default:!1,format:"checkbox"},ShowExportExcelButton:{type:"boolean",title:"Show Export Excel Button",default:!1,format:"checkbox"},ShowScreenshot:{type:"boolean",title:"Show Screenshot Button",default:!1,format:"checkbox"},FileName:{type:"array",format:"table",title:"FileName",options:{hidden:!1,collapsed:!0},items:{type:"object",title:"Filename Part",options:{collapsed:!0},properties:{FileNamePart:{title:"FileName Part",type:"string"}}}}}},Animations:{type:"object",propertyOrder:6,options:{collapsed:!0},properties:{Enabled:{type:"boolean",format:"checkbox",default:!1},Easing:{type:"string",enum:["linear","easeInQuad","easeOutQuad","easeInOutQuad","easeInCubic","easeOutCubic","easeInOutCubic","easeInQuart","easeOutQuart","easeInOutQuart","easeInQuint","easeOutQuint","easeInOutQuint","easeInSine","easeOutSine","easeInOutSine","easeInExpo","easeOutExpo","easeInOutExpo","easeInCirc","easeOutCirc","easeInOutCirc","easeInElastic","easeOutElastic","easeInOutElastic","easeInBack","easeOutBack","easeInOutBack","easeInBounce","easeOutBounce","easeInOutBounce"],default:""},Duration:{type:"number",format:"number",default:0}}},InnerLabel:{type:"object",propertyOrder:5,title:"Labels",options:{collapsed:!0},properties:{Innertitle:{type:"string",title:"Inner Label",propertyOrder:1,default:""},InnertitleFont:{type:"string",title:"Inner Label Font",propertyOrder:2,enum:["Verdana","fontawesome","Arial","Helvetica","Times","Courier"],default:"Verdana"},InnertitleSize:{type:"number",title:"Inner Label Size",propertyOrder:3,default:12},InnertitleColor:{type:"gradient",title:"Inner Label Color",propertyOrder:6,default:"#ffffff"},ShowPieceLabel:{title:"Show Piece Label",propertyOrder:7,type:"boolean",format:"checkbox",default:!1},ShowZero:{title:"Piece Label Show Zero ",propertyOrder:8,type:"boolean",format:"checkbox",default:!1},PieceLabelArc:{title:"Piece Label Arc",propertyOrder:9,type:"boolean",format:"checkbox",default:!1},PieceLabelOverlap:{title:"Piece Label Overlap",propertyOrder:10,type:"boolean",format:"checkbox",default:!1},PieceLabelRender:{title:"Piece Label Type",propertyOrder:11,type:"string",enum:["label","value","percentage"],default:"percentage"},PieceLabelTemplate:{default:"",propertyOrder:12,templateItems:{values:{items:_.keyBy(["percentage","value","label"]),type:"object"}},title:"Piece Label Template",type:"tooltipTemplate"},PieceLabelPosition:{title:"Piece Label Position",propertyOrder:13,type:"string",enum:["default","border","outside"],default:"default"},PieceLabelColor:{title:"Piece Label Colour",propertyOrder:14,type:"gradient",default:"#ffffff"},FontSize:{title:"Piece Font Size",propertyOrder:15,type:"number",default:12},Format:{type:"string",propertyOrder:16,enum:["General","Number","Smart Number","Datetime"],default:"General"},Precision:{type:"number",propertyOrder:17,title:"Decimal Places",format:"number",minimum:0,maximum:10,default:2},HideTrailingZeroes:{type:"boolean",propertyOrder:18,title:"Hide Trailing Zeroes",format:"checkbox",default:!1},DateFormat:{type:"string",propertyOrder:19,title:"Date/Time format",enum:["YYYY-MM-DD","YYYY-MMM-DD","YYYY-MMMM-DD","YYYY-MM","YYYY-MMM","YYYY-MMMM","MMM DD","MMM Do","YYYY-MM-DD HH:mm:ss","YYYY-MM-DD hh:mm:ss","YYYY-MM-DD kk:mm:ss","hh:mm:ss","kk:mm:ss","hh:mm:ss.SS","hh:mm","kk:mm","mm:ss","mm:ss.SS"],default:"YYYY-MM-DD"},Prefix:{type:"string",propertyOrder:20,default:""},Suffix:{type:"string",propertyOrder:21,default:""}}}}}}};if(0<_.keys(t.settingsModel.attributes).length)for(a=A.upgrades.indexOf(_.find(A.upgrades,{version:t.settingsModel.get("version")}))+1;a<A.upgrades.length;a+=1)(e=A.upgrades[a]).fn(t.settingsModel),t.settingsModel.set("version",e.version);return o},A);function A(){}function H(){this.drawDataset=this.drawDataset.bind(this)}function j(t,e){if(function(t){if(t.options.pieceLabel){var e=1;if(Array.isArray(t.options.pieceLabel)&&(e=t.options.pieceLabel.length),!t.pieceLabel||e!==t.pieceLabel.length){t.pieceLabel=[];for(var a=0;a<e;++a)t.pieceLabel.push(new H)}}else t.pieceLabel&&delete t.pieceLabel;return t.pieceLabel}(t))for(var a=0;a<t.pieceLabel.length;++a)t.pieceLabel[a][e](t,a)}N.upgrades=[{version:0,fn:function(){}},{version:"4.1.0.3",fn:function(t){var e=t.get("InnerLabel");e.Format=void 0===e.Format?"General":e.Format,e.Precision=void 0===e.Precision?2:e.Precision,e.HideTrailingZeroes=void 0!==e.HideTrailingZeroes&&e.HideTrailingZeroes,e.Prefix=void 0===e.Prefix?"":e.Prefix,e.Suffix=void 0===e.Suffix?"":e.Suffix,e.DateFormat=void 0===e.DateFormat?"YYYY-MM-DD":e.DateFormat,t.set("InnerLabel",e)}},{version:"4.1.0s4b",fn:function(t){var e=t.get("FileExport"),a=t.get("Padding"),o=t.get("DataSet.Layers");void 0===e?(t.set("FileExport.ShowExportCsvButton",!1),t.set("FileExport.ShowExportExcelButton",!1),t.set("FileExport.ShowScreenshot",!1),t.set("FileExport.FileName",[])):t.set("FileExport",e),void 0===a&&t.set("Padding",{Right:2,Bottom:2,Left:2,Top:2}),_.each(o,function(t){t.BorderColor=void 0===t.BorderColor?"#ffffff":t.BorderColor})}},{version:"4.2.1",fn:function(t){t.set("InnerLabel.InnertitleSize",0)}},{version:"4.3.1",fn:function(t){var e=t.get("Basics"),a=t.get("Legend"),o=t.get("InnerLabel");e.PopoutSelected=void 0!==e.PopoutSelected&&e.PopoutSelected,e.PopoutSelectedSize=void 0===e.PopoutSelectedSize?10:e.PopoutSelectedSize,a.Mode=void 0===a.Mode?"Toggle Hidden":a.Mode;var i=e.SelectedObjectRouting;if(!i)return t.set("Basics.Actions",[]),void t.unset("Basics.SelectedObjectRouting");i=_.map(i,function(t){return{_Type:"map",Trigger:"Click",Current:t.ColumnProperty,Target:t.ViewstateProperty}});t.set("Basics",e),t.set("Legend",a),t.set("Basics.Actions",i),t.unset("Basics.SelectedObjectRouting"),o.FontSize=void 0===o.FontSize?10:o.FontSize,t.set("InnerLabel",o)}},{version:"4.5.1",fn:function(t){var e=t.get("InnerLabel"),a=t.get("Style"),o=t.get("Legend");e.PieceLabelTemplate=void 0===e.PieceLabelTemplate?"":e.PieceLabelTemplate,t.set("InnerLabel",e);'<div><span>{{dataSet.0.label}}</span><br/><table>{{#each dataSet}}<tr><td>{{xaxis}}</td><td><svg style="width:20px;height:20px"><circle cx="10" cy= "10" r="8" stroke="white" stroke-width="2" fill= "{{color}}" > </circle></svg> </td><td>{{layerData}} :</td><td>{{toFixed value 2}} ({{toFixed percent 2}}%)</td> </tr>{{/each}} </table></div>'===a.advancedTooltip?a.advancedTooltip='<div> <table>{{#each dataSet}} <tbody> {{#eq @index 0}} <tr> <td colspan="2">{{label}}</td> </tr> {{/eq}} <tr><td>{{xaxis}}</td> <td><svg style="width:20px;height:20px"> <circle fill="{{color}}" stroke-width="2" stroke="white" r="8" cy="10" cx="10"> </circle> </svg></td> <td>{{layerName}} :</td> <td>{{toFixed value 2}} ({{toFixed percent 2}}%)</td> </tr> {{/each}} </tbody> </table> </div>':(e=new RegExp("{{layerData}}","g"),a.advancedTooltip=a.advancedTooltip.replace(e,"{{layerName}}")),t.set("Style",a),o.Mode="Toogle Hidden"===o.Mode?"Toggle Hidden":o.Mode,t.set("Legend",o)}}],"undefined"!=typeof Chart?(Array.isArray||(Array.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)}),H.prototype.beforeDatasetsUpdate=function(t,e){this.parseOptions(t,e),"outside"===this.position&&(e=1.5*this.fontSize+this.outsidePadding,t.chartArea.top+=e,t.chartArea.bottom-=e)},H.prototype.afterDatasetsDraw=function(t,e){this.parseOptions(t,e),this.labelBounds=[],t.config.data.datasets.forEach(this.drawDataset)},H.prototype.drawDataset=function(t){for(var e=this.ctx,a=this.chartInstance,o=t._meta[Object.keys(t._meta)[0]],i=0,r=0;r<o.data.length;r++){var n,s,l,c,d,p,h,u,f,g=o.data[r],m=g._view,y=void 0;if(0!==m.circumference||this.showZero){switch(this.render){case"value":var b=t.data[r],y=(b=this.format?this.format(b):b).toString();break;case"advanced":b=t.data[r];y=(b=this.format?this.format(b):b).toString();break;case"label":y=a.config.data.labels[r];break;case"image":y=this.images[r]?this.loadImage(this.images[r]):"";break;case"percentage":default:var S=m.circumference/this.options.circumference*100,S=parseFloat(S.toFixed(this.precision));this.showActualPercentages||100<(i+=S)&&(S-=i-100,S=parseFloat(S.toFixed(this.precision))),y=S+"%"}(y="function"==typeof this.render&&"object"==typeof(y=this.render({label:a.config.data.labels[r],value:t.data[r],percentage:S,dataset:t,index:r}))?this.loadImage(y):y)&&(e.save(),e.beginPath(),e.font=Chart.helpers.fontString(this.fontSize,this.fontStyle,this.fontFamily),"outside"===this.position||"border"===this.position?(l=m.outerRadius/2,u=this.fontSize+this.textMargin,h=m.startAngle+(m.endAngle-m.startAngle)/2,"border"===this.position?c=(m.outerRadius-l)/2+l:"outside"===this.position&&(this.arc||(u=this.textMargin),c=m.outerRadius-l+l+u),n={x:m.x+Math.cos(h)*c,y:m.y+Math.sin(h)*c},"outside"===this.position&&(this.arc||(u+=this.measureText(y).width/2),n.x<m.x?n.x-=u:n.x+=u,s=m.outerRadius+u)):(l=m.innerRadius,n=g.tooltipPosition()),"function"==typeof(d=this.fontColor)?d=d({label:a.config.data.labels[r],value:t.data[r],percentage:S,text:y,backgroundColor:t.backgroundColor[r],dataset:t,index:r}):"string"!=typeof d&&(d=d[r]||this.options.defaultFontColor),this.arc?(s=s||(l+m.outerRadius)/2,e.fillStyle=d,e.textBaseline="middle",this.drawArcText(y,s,m,this.overlap)):(f=this.measureText(y),p=n.x-f.width/2,h=n.x+f.width/2,u=n.y-f.height/2,f=n.y+f.height/2,(!!this.overlap||("outside"===this.position?this.checkTextBound(p,h,u,f):g.inRange(p,u)&&g.inRange(p,f)&&g.inRange(h,u)&&g.inRange(h,f)))&&this.fillText(y,n,d)),e.restore())}}},H.prototype.parseOptions=function(t,e){var a=t.options.pieceLabel;Array.isArray(a)&&(a=a[e]),this.chartInstance=t,this.ctx=t.chart.ctx,this.options=t.config.options,this.render=a.render||a.mode,this.position=a.position||"default",this.arc=a.arc,this.format=a.format,this.precision=a.precision||0,this.fontSize=a.fontSize||this.options.defaultFontSize,this.fontColor=a.fontColor||this.options.defaultFontColor,this.fontStyle=a.fontStyle||this.options.defaultFontStyle,this.fontFamily=a.fontFamily||this.options.defaultFontFamily,this.shadowOffsetX=a.shadowOffsetX||3,this.shadowOffsetY=a.shadowOffsetY||3,this.shadowColor=a.shadowColor||"rgba(0,0,0,0.3)",this.shadowBlur=a.shadowBlur||6,this.textShadow=a.textShadow||!1,this.hasTooltip=t.tooltip._active&&t.tooltip._active.length,this.showZero=a.showZero,this.overlap=a.overlap,this.images=a.images||[],this.outsidePadding=a.outsidePadding||2,this.textMargin=a.textMargin||2,this.showActualPercentages=a.showActualPercentages||!1},H.prototype.checkTextBound=function(t,e,a,o){for(var i=this.labelBounds,r=0;r<i.length;++r){for(var n=i[r],s=[[t,a],[t,o],[e,a],[e,o]],l=0;l<s.length;++l){var c=s[l][0],d=s[l][1];if(c>=n.left&&c<=n.right&&d>=n.top&&d<=n.bottom)return!1}for(s=[[n.left,n.top],[n.left,n.bottom],[n.right,n.top],[n.right,n.bottom]],l=0;l<s.length;++l){c=s[l][0],d=s[l][1];if(t<=c&&c<=e&&a<=d&&d<=o)return!1}}return i.push({left:t,right:e,top:a,bottom:o}),!0},H.prototype.measureText=function(t){if("object"==typeof t)return{width:t.width,height:t.height};for(var e=0,a=t.split("\n"),o=0;o<a.length;++o){var i=this.ctx.measureText(a[o]);i.width>e&&(e=i.width)}return{width:e,height:this.fontSize*a.length}},H.prototype.fillText=function(t,e,a){var o=this.ctx;if("object"==typeof t)o.drawImage(t,e.x-t.width/2,e.y-t.height/2,t.width,t.height);else{o.save(),o.fillStyle=a,o.textBaseline="top",o.textAlign="center",this.textShadow&&(o.shadowOffsetX=this.shadowOffsetX,o.shadowOffsetY=this.shadowOffsetY,o.shadowColor=this.shadowColor,o.shadowBlur=this.shadowBlur);for(var i=t.split("\n"),r=0;r<i.length;r++){var n=e.y-this.fontSize/2*i.length+this.fontSize*r;o.fillText(i[r],e.x,n)}o.restore()}},H.prototype.loadImage=function(t){var e=new Image;return e.src=t.src,e.width=t.width,e.height=t.height,e},H.prototype.drawArcText=function(t,e,a,o){var i=this.ctx,r=a.x,n=a.y,s=a.startAngle,a=a.endAngle;i.save(),i.translate(r,n);r=a-s,n=s+=Math.PI/2;if(s+=((a+=Math.PI/2)-((h=this.measureText(t)).width/e+s))/2,!o&&r<a-s)i.restore();else{if("string"==typeof t){i.rotate(s);var l=t.split("\n"),c=0,d=[],p=0;"border"===this.position&&(p=(l.length-1)*this.fontSize/2);for(var h,u=0;u<l.length;++u)(h=i.measureText(l[u])).width>c&&(c=h.width),d.push(h.width);for(u=0;u<l.length;++u){var f=l[u],g=(l.length-1-u)*-this.fontSize+p;i.save();var m=(c-d[u])/2;i.rotate(m/e);for(var y=0;y<f.length;y++){var b=f.charAt(y);h=i.measureText(b),i.save(),i.translate(0,-1*e),i.fillText(b,0,g),i.restore(),i.rotate(h.width/e)}i.restore()}}else i.rotate((n+a)/2),i.translate(0,-1*e),this.fillText(t,{x:0,y:0});i.restore()}},Chart.pluginService.register({beforeDatasetsUpdate:function(t){j(t,"beforeDatasetsUpdate")},afterDatasetsDraw:function(t){j(t,"afterDatasetsDraw")}})):console.warn("Can not find Chart object.");var Y=(z.app=b.template({compiler:[7,">= 4.0.0"],main:function(t,e,a,o,i){return'<div class="chart-container">\r\n    <canvas class="chart"></canvas>\r\n    <div class="chartjs-tooltip" style="display:none"></div>\r\n</div>\r\n<div class="highlight-rules-dialog" title="Highlight Rules"></div>\r\n<div class="chart-legend"></div>'},useData:!0}),z.externalLegend=b.template({1:function(t,e,a,o,i){var r=null!=e?e:t.nullContext||{},n=a.helperMissing,s="function",l=t.escapeExpression;return'        <li><span style="background-color:'+l(typeof(t=null!=(t=a.fillStyle||(null!=e?e.fillStyle:e))?t:n)==s?t.call(r,{name:"fillStyle",hash:{},data:i}):t)+'; border-color:#fffff"></span>'+l(typeof(t=null!=(t=a.text||(null!=e?e.text:e))?t:n)==s?t.call(r,{name:"text",hash:{},data:i}):t)+"</li>\r\n"},compiler:[7,">= 4.0.0"],main:function(t,e,a,o,i){return'<ul class="5-legend">\r\n'+(null!=(i=a.each.call(null!=e?e:t.nullContext||{},e,{name:"each",hash:{},fn:t.program(1,i,0),inverse:t.noop,data:i}))?i:"")+"</ul>"},useData:!0}),z.fileExporter=b.template({compiler:[7,">= 4.0.0"],main:function(t,e,a,o,i){var r=null!=e?e:t.nullContext||{},n=a.helperMissing,t=t.escapeExpression;return'<div class="tools-panel">\r\n    <div class="pnlButtons">\r\n        <span class="lnksExport link-disabled">\r\n            <i class="fa fa-fw fa-download" title="'+t((a.t||e&&e.t||n).call(r,"Data",{name:"t",hash:{},data:i}))+'"></i>\r\n            <a class="lnkExcelExport" title="'+t((a.t||e&&e.t||n).call(r,"Download the current dataset in Excel format",{name:"t",hash:{},data:i}))+'">'+t((a.t||e&&e.t||n).call(r,"Excel",{name:"t",hash:{},data:i}))+'</a>\r\n            <a class="lnkCsvExport" title="'+t((a.t||e&&e.t||n).call(r,"Download the current dataset in CSV format",{name:"t",hash:{},data:i}))+'">'+t((a.t||e&&e.t||n).call(r,"CSV",{name:"t",hash:{},data:i}))+'</a>\r\n            <a class="lnkDownloadScreenshot" title="'+t((a.t||e&&e.t||n).call(r,"Download a PNG image of the chart",{name:"t",hash:{},data:i}))+'">'+t((a.t||e&&e.t||n).call(r,"PNG",{name:"t",hash:{},data:i}))+"</a>\r\n        </span>\r\n    </div>\r\n</div>"},useData:!0}),z.highlighRule=b.template({1:function(t,e,a,o,i){var r=null!=e?e:t.nullContext||{},n=a.helperMissing,s="function",l=t.escapeExpression;return'<div class="highlightRule-menu-item">\r\n    <svg>\r\n        <rect x="2" y="5" width="10" height="10" stroke="'+l(typeof(t=null!=(t=a.ruleBorder||(null!=e?e.ruleBorder:e))?t:n)==s?t.call(r,{name:"ruleBorder",hash:{},data:i}):t)+'" fill="'+l(typeof(t=null!=(t=a.ruleColor||(null!=e?e.ruleColor:e))?t:n)==s?t.call(r,{name:"ruleColor",hash:{},data:i}):t)+'" stroke-width="2"></rect>\r\n    </svg>\r\n    <span>&nbsp;'+l(typeof(t=null!=(t=a.layer||(null!=e?e.layer:e))?t:n)==s?t.call(r,{name:"layer",hash:{},data:i}):t)+"&nbsp;("+l(typeof(t=null!=(t=a.ruleName||(null!=e?e.ruleName:e))?t:n)==s?t.call(r,{name:"ruleName",hash:{},data:i}):t)+")</span>\r\n</div>\r\n"},compiler:[7,">= 4.0.0"],main:function(t,e,a,o,i){return null!=(i=a.each.call(null!=e?e:t.nullContext||{},e,{name:"each",hash:{},fn:t.program(1,i,0),inverse:t.noop,data:i}))?i:""},useData:!0}),z.htmlLegend=b.template({1:function(t,e,a,o,i){var r=null!=e?e:t.nullContext||{},n=a.helperMissing,s="function",l=t.escapeExpression;return'        <li><span style="background-color:'+l(typeof(t=null!=(t=a.fillStyle||(null!=e?e.fillStyle:e))?t:n)==s?t.call(r,{name:"fillStyle",hash:{},data:i}):t)+'; border-color:#fffff"></span>'+l(typeof(t=null!=(t=a.text||(null!=e?e.text:e))?t:n)==s?t.call(r,{name:"text",hash:{},data:i}):t)+"</li>\r\n"},compiler:[7,">= 4.0.0"],main:function(t,e,a,o,i){return'<ul class="5-legend">\r\n'+(null!=(i=a.each.call(null!=e?e:t.nullContext||{},e,{name:"each",hash:{},fn:t.program(1,i,0),inverse:t.noop,data:i}))?i:"")+"</ul>"},useData:!0}),z);function z(){}var V=(K.getConfig=function(t){var a,o=this,e={".csv":"Csv",".xlsx":"Excel"}[t.fileFormat],i={configSets:{},fileFormat:t.fileFormat,fileName:h.ExportTools.getExportFileName(t.fileName,"",e),workSheetTitle:t.workSheetTitle,metaData:[],dataSet:{}},r=t.columnsConfig,n=r.dataSource;return i.fileName=h.ExportTools.getExportFileName(t.fileName,"",e),i.fileFormat=t.fileFormat,i.workSheetTitle=t.workSheetTitle,n&&(i.dataSet=n.getData().toJSON(),a=r.formats.PieceLabelRender,i.metaData=[this.getExportMetaData({colId:r.labelColId,colFormats:r.formats,kdbType:n.getColumnType(r.labelColId)},"label")],_.each(r.layersIds,function(t){var e="label"===a?r.labelColId:t,t=h.ExportTools.regExValidateColumnIDs(e,n.getColumnNames());0<t.length?(i.metaData=[],t.forEach(function(t){i.metaData.push(o.getExportMetaData({colId:t,colFormats:r.formats,kdbType:n.getColumnType(t)},"layers"))})):console.log("Column with id: '"+e+"' not found")})),i},K.getExportMetaData=function(t,e){var a,o={},i=t.kdbType,r="",n="",s="",l=!1;if("label"===e)switch(i){case 1:a="Boolean";break;case 4:case 5:case 6:case 7:case 8:case 9:a="Number";break;case 15:a="Datetime",s="YYYY-MM-DD HH:mm:ss.SSS";break;case 13:a="Datetime",s="MMM YYYY";break;case 14:case 16:a="Datetime",s="YYYY-MM-DD";break;case 17:a="Datetime",s="HH:mm";break;case 18:a="Datetime",s="HH:mm:ss";break;case 19:a="Datetime",s="HH:mm:ss.SSS";break;default:a="String"}else r=t.colFormats.Prefix,n=t.colFormats.Suffix,a=t.colFormats.Format,s=t.colFormats.DateFormat,l=t.colFormats.HideTrailingZeroes;i=this.resolveColumnTypeAndFormat(a,s,t.colFormats.Precision,i);return o.colId=t.colId,o.colName=t.colId,o.dataType=i.dataType,o.dataKdbType=i.dataKdbType,o.dataFormat=i.dataFormat,o.hideTrailingZeroes=l,o.prefix=r,"percentage"===t.colFormats.PieceLabelRender?o.suffix="":o.suffix=n,o},K.resolveColumnTypeAndFormat=function(t,e,a,o){var i=11<o&&o<20,r=a?"."+Array(a+1).join("0"):"";switch((3===o||o<1||19<o)&&(o=11,e="TO_STRING",t="String"),t){case"Number":e="#0"+r;break;case"Smart Number":t="Number",e="SmartNumber"+r;break;case"Datetime":t=h.ExportTools.getTemporalTypeFromFormat(e),e=h.ExportTools.CHARTS_DATE_FORMAT_MAP[e],e=i?e||"":(t="String","");break;case"General":default:t="String",e=""}return{dataType:t=1===o?"Boolean":t,dataFormat:e,dataKdbType:o}},K.getValidPrecission=function(t){var e=void 0!==t?t:0;return e<0?(e=0,console.info("Invalid precission, should be between in range of 0 and 10, got: ",t)):10<e&&(e=10,console.info("Invalid precission, should be between in range of 0 and 10, got: ",t)),e},K);function K(){}var W,Z,U=(W=i.View,n(Q,W),Q.prototype.remove=function(){return this.$lnkCsvExport&&this.$lnkCsvExport.off(),this.$lnkExcelExport&&this.$lnkExcelExport.off(),this.$lnkDownloadScreenshot&&this.$lnkDownloadScreenshot.off(),this.stopListening(),i.View.prototype.remove.apply(this)},Q.prototype.initializeEvents=function(){this.listenTo(this.model,"change",this.displayChoiceLinkButtons.bind(this)),this.$lnkCsvExport&&this.$lnkExcelExport&&this.$lnkDownloadScreenshot&&(this.$lnkCsvExport.click(_.bind(this.fileExport.bind(this),this,".csv")),this.$lnkExcelExport.click(_.bind(this.fileExport.bind(this),this,".xlsx")),this.$lnkDownloadScreenshot.click(_.bind(this.downloadImage.bind(this),this,".png")))},Q.prototype.displayChoiceLinkButtons=function(){var t=this.model.get("FileExport");!t||_.keys(t).length<5||(t.ShowExportCsvButton||t.ShowExportExcelButton||t.ShowScreenshot?(this.$lnkCsvExport&&this.$lnkExcelExport&&this.$lnkDownloadScreenshot&&this.$lnksExport&&(this.$lnksExport.removeClass("link-disabled"),this.$lnkCsvExport.toggleClass("link-disabled",!t.ShowExportCsvButton),this.$lnkExcelExport.toggleClass("link-disabled",!t.ShowExportExcelButton),this.$lnkDownloadScreenshot.toggleClass("link-disabled",!t.ShowScreenshot)),this.$chartContainer.toggleClass("links-enabled",!this.$chartContainer.hasClass("links-enabled")),t.Enabled||this.model.set("FileExport.Enabled",!0)):(this.$lnksExport&&this.$lnksExport.addClass("link-disabled"),this.$chartContainer.removeClass("links-enabled"),t.Enabled&&this.model.set("FileExport.Enabled",!1)))},Q.prototype.downloadImage=function(t){var a=("string"==typeof(a=h.ExportTools.getExportFileName(this.getExportConfig().fileName,"","Screenshot"))?a:"Screenshot")+t;this.generateImage(function(t,e){h.Tools.fileSave(a,t,e)})},Q.prototype.fileExport=function(t){var e=h.ExportTools,t=V.getConfig(_.extend(this.getExportConfig(),{fileFormat:t}));e.openFileExportDialog(t)},Q.prototype.generateImage=function(e){var t,a=this.getCanvas(),o=a.width,i=a.height,r=document.createElement("canvas"),n="Light"===this.getTheme()?"#F8F8F8":"#282828";a&&(r.width=o,r.height=i,(t=r.getContext("2d"))&&(t.fillStyle=n,t.fillRect(0,0,o,i),t.drawImage(a,0,0),this.isIE?(r=r.toDataURL("image/png"),e(h.Tools.convertDataUrlToBlob(r),"image/png")):t.canvas.toBlob(function(t){e(t,"application/octet-stream")})))},Q.prototype.getTheme=function(){return this.appView.dashboardViewModel.get("DashboardTheme")},Q.prototype.renderLinks=function(){this.$lnksExport=this.$el.find(".lnksExport"),this.$lnkCsvExport=this.$el.find("a.lnkCsvExport"),this.$lnkExcelExport=this.$el.find("a.lnkExcelExport"),this.$lnkDownloadScreenshot=this.$el.find("a.lnkDownloadScreenshot")},Q);function Q(t){var e=W.call(this,t)||this;return e.api=t.api,e.getCanvas=t.getCanvas,e.appView=t.appView,e.getExportConfig=t.getExportConfig,e.isIE=!1,HTMLCanvasElement&&HTMLCanvasElement.prototype&&_.get(HTMLCanvasElement.prototype,"msToBlob")&&(e.isIE=!0),e.$chartContainer=e.appView.$el.find(".chart-container"),e.render(),e.renderLinks(),e.initializeEvents(),e}function G(t){var o=Z.call(this,t)||this;o.focus=[],o.isReadyForThemeChange=!1,o.layers=new u,o.dataSources={},o.errors={},_.extend(o,_.pick(t,["api","dashboardViewModel"])),o.api=t.api;var a=o.onSettingsChange.bind(o);return o.onSettingsChange=function(t){var e=this.onSettingsChange!==(this.onSettingsChange=a);this.onSettingsChange(t),e&&(this.isReadyForThemeChange=!0,this.setThemeAccordingToDashboardSettings())}.bind(o),o.$el.html(Y.app({id:o.id})),o.ctx=o.$el.find(".chart-container")[0].querySelector("canvas").getContext("2d"),o.defaultOptions={maintainAspectRatio:!1,responsive:!0,animation:{duration:0}},o.listenTo(o.layers,"add",function(){this.setThemeAccordingToDashboardSettings()}),o.listenTo(o.layers,"reset",function(){this.setThemeAccordingToDashboardSettings()}),o.listenTo(o.layers,"remove",function(t){t.stopListening()}),o.listenTo(o.layers,"update",function(t,e){o.updatePossibleLayers();var a=0<e.changes.added.length+e.changes.removed.length;_.throttle(function(){!a&&o.animation&&o.animation.get("Enabled")?o.updateChart():o.initializeChart()})}),o.highlightRulesModel=new C({el:o.$el,api:o.api}),o.legendModel=new P({externalDiv:o.$el.find(".chart-legend"),app:o}),o.listenTo(o.legendModel,"change",o.initializeChart.bind(o)),o.layoutModel=new O,o.listenTo(o.layoutModel,"change",o.initializeChart.bind(o)),o.animation=new m,o.listenTo(o.animation,"change",o.updateChart.bind(o)),o.tooltips=new F(o.api),o.fileExportModel=new i.DeepModel,o.fileExporterView=new U({model:o.fileExportModel,el:Y.fileExporter({id:o.id}),api:o.api,appView:o,getCanvas:function(){return o.ctx.canvas},getExportConfig:function(){var t=o.layers.at(0);return{columnsConfig:{dataSource:o.dataSources[t.get("Basics.Data").cid],layersIds:_.map(t.get("DataSet.Layers"),"Segment"),labelColId:t.get("DataSet.Label"),formats:t.get("InnerLabel")},fileName:o.fileExportModel.get("FileExport.FileName"),altFileName:"",workSheetTitle:"ChartJs"}}}),o.$el.prepend(o.fileExporterView.$el),o.listenTo(o.fileExportModel,"change:FileExport.Enabled",o.toggleToolsPanel.bind(o)),o}return Z=i.View,n(G,Z),G.prototype.onSettingsChange=function(t){t=B.expandNestedViewStates(t,this.api),t=B.replaceViewStatesWithValue("",t,this.api),t=B.pump(t);this.onSettingsChangeProcessed.call(this,t)},G.prototype.updateError=function(t,e){var a=this,t=t.getKey();e?this.errors[t]=e:delete this.errors[t];function o(t){return"Error"===t?3:"Loading"===t?2:"NoResults"===t?1:0}e=_.reduce(this.errors,function(t,e){e=e.type;return o(e)>o(t)?e:t},"");e&&("NoResults"!==e||Object.keys(this.dataSources).length===Object.keys(this.errors).length)?(t=_.map(this.errors,function(t,e){t=t.error,e=a.dataSources[e];return t?"["+e.getPath()+"]: "+t:null}).filter(function(t){return t}),this.api.showQueryStatus({error:t.join("\n"),type:e})):this.api.hideQueryStatus()},G.prototype.updateDataSource=function(a){var o=this,i="DataSet.Layers.0.Segment";if(this.dataSources[a.getKey()]){var r=!1,e=this.layers.filter(function(t){t=t.get("Basics.Data");return t&&t.cid===a.getKey()}),n=h.HeuristicHelpers.getNumericColumns(a),s=h.HeuristicHelpers.getStringColumns(a),l=h.HeuristicHelpers.getListColumns(a),c=0===n.length?l:n,d=this.errors[a.getKey()],p=0===s.length?0===l.length?n:l:s;if(0===c.length&&(!d||"Loading"===_.get(d,"type")))return void this.api.showErrorMessage({error:t("Data Source provided is not valid for Pie Chart"),type:"Warning"});e.forEach(function(t,e){t.updateData(a),t.set("possibleColumns",a.getColumnNames()),t.set("possibleRules",a.getColumnNames()),t.set("possibleLabels",a.getColumnNames()),o.api.setProperty("possibleColumns",t.get("possibleColumns")),o.api.setProperty("possibleRules",t.get("possibleRules")),o.api.setProperty("possibleLabels",t.get("possibleLabels")),0===e&&""===o.api.getProperty(i)&&(t.set(i,c[0]),o.api.setProperty(i,c[0]),r=!0),0===e&&""===o.api.getProperty("DataSet.Label")&&(t.set("DataSet.Label",p[0]),o.api.setProperty("DataSet.Label",p[0]),r=!0)}),r&&this.api.setProperty("DataSet",{Label:p[0],DonutRatio:50,Rotation:50,Circumference:100,BorderWidth:1,Layers:[{Segment:c[0],Display:"",UseColor:!0,Color:"#0061FF",BorderColor:"#ffffff",ColorOpacity:85,HighlightRules:[]}]})}(this.animation&&this.animation.get("Enabled")?this.updateChart:this.initializeChart).bind(this).call(this)},G.prototype.onSettingsChangeProcessed=function(t){_.isObject(t.Basics)&&this.onSettingsBasicsChanged.call(this,t.Basics),_.isObject(t.Basics)&&t.Basics.Data&&this.onSettingsLayersChanged.call(this,t),_.isObject(t.DataSet)&&this.onSettingsOnData(t),_.isObject(t.InnerLabel)&&this.onSettingsOnInnerLabel(t),_.isObject(t.Legend)&&this.onSettingsLegendChanged.call(this,t.Legend),_.isObject(t.Style)&&this.onSettingsStyleChanged.call(this,t.Style),_.isObject(t.Padding)&&this.onSettingsPaddingChanged.call(this,t),_.isObject(t.FileExport)&&this.onSettingsFileExportChanged.call(this,t.FileExport),_.isObject(t.Animations)&&this.onSettingsAnimationChanged.call(this,t.Animations)},G.prototype.onSettingsFileExportChanged=function(t){var a=this;this.fileExportModel&&(_.each(t,function(t,e){a.fileExportModel.set("FileExport."+e,t)}),4===_.keys(t).length&&void 0===this.fileExportModel.get("FileExport.Enabled")&&(t.ShowExportCsvButton||t.ShowExportExcelButton||t.ShowScreenshot?this.fileExportModel.set("FileExport.Enabled",!0):this.fileExportModel.set("FileExport.Enabled",!1)))},G.prototype.onSettingsAnimationChanged=function(t){this.animation&&this.animation.set(t)},G.prototype.onSettingsPaddingChanged=function(t){this.layoutModel.set("Padding",t.Padding)},G.prototype.onSettingsLegendChanged=function(t){this.legendModel.set(t),this.chart&&this.legendModel.renderhtmlLegend(this.chart)},G.prototype.onSettingsStyleChanged=function(t){this.layers&&0<this.layers.models.length&&(this.layers.models[0].set("Style",t),t.chartBarColors&&this.layers.models[0].updateVisuals(),this.initializeChart())},G.prototype.onSettingsLayersChanged=function(t){this.layers.set(t);var e=t.Basics.Data,t=this.dataSources[e.cid];t?t.hasData()&&this.updateDataSource(t):(t=new S(e,this,this.api,this.focus),(this.dataSources[e.cid]=t).subscribe())},G.prototype.onSettingsOnData=function(t){var e=this,o=this.layers.models[0];_.each(t.DataSet,function(t,e){o&&"Layers"===e&&_.each(t,function(t,a){_.each(t,function(t,e){o.set("DataSet.Layers."+a+"."+e,t)})}),o&&"Label"===e&&o.set("DataSet.Label",t),o&&"DonutRatio"===e&&o.set("DataSet.DonutRatio",t),o&&"Rotation"===e&&o.set("DataSet.Rotation",t),o&&"Circumference"===e&&o.set("DataSet.Circumference",t),o&&"BorderWidth"===e&&o.set("DataSet.BorderWidth",t)}),_.each(this.dataSources,function(t){o.chartData={},void 0===o.get("Style")&&o.set("Style",e.api.getProperty("Style")),void 0===o.get("InnerLabel")&&o.set("InnerLabel",e.api.getProperty("InnerLabel")),o.dataSource=t,o.updateData(t)}),o&&o.set("Basics.Focus",this.api.getProperty("Basics.Focus")),this.initializeChart(),this.highlightRulesModel.computeHighlightRulesHTML()},G.prototype.onSettingsOnInnerLabel=function(t){var a=this.layers.models[0];a&&(_.each(t.InnerLabel,function(t,e){a.set("InnerLabel."+e,t)}),this.initializeChart())},G.prototype.toggleToolsPanel=function(){var t;this.fileExportModel.has("FileExport")&&this.legendModel&&(t=this.fileExportModel.get("FileExport.Enabled"),!this.legendModel.toolsEnabled&&t?(this.legendModel.toolsEnabled=!0,this.$el.find(".tools-panel").removeClass("disabled"),this.initializeChart()):t||(this.legendModel.toolsEnabled=!1,this.$el.find(".tools-panel").toggleClass("disabled",!this.$el.find(".tools-panel").hasClass("disabled")),this.initializeChart()))},G.prototype.onSettingsAnimationsChanged=function(t){var e=this;t.hasOwnProperty("Enabled")?(t.Enabled?B.cache(this.animation,"Animations.",{load:["Duration","Easing"],defaults:[0,"easeOutQuart"]},this.api):B.cache(this.animation,"Animations.",{store:["Duration","Easing"]},this.api),this.animation.set(t),_.defer(function(){e.api.setProperty("Animations",i.Model.prototype.toJSON.apply(e.animation))})):this.animation.set(t)},G.prototype.onSettingsTooltipsChanged=function(t){var e=this;t.hasOwnProperty("Enabled")?(t.Enabled?B.cache(this.tooltips,"Tooltips.",{load:["Mode"],defaults:[0,"index"]},this.api):B.cache(this.tooltips,"Tooltips.",{store:["Mode"]},this.api),this.tooltips.set(t),_.defer(function(){e.api.setProperty("Tooltips",i.Model.prototype.toJSON.apply(e.tooltips))})):this.tooltips.set(t)},G.prototype.onSettingsBasicsChanged=function(t){var e=this;void 0!==t.Focus&&(this.focus=_.first(B.focus2Array(t.Focus))||[],_.each(this.dataSources,function(t){t.setFocus(e.focus)})),void 0!==t.Selected&&0<this.layers.models.length&&this.api.getProperty("Basics.PopoutSelected")&&(this.layers.models[0].set("Basics.Selected",t.Selected),this.updateChart())},G.prototype.initializeChart=function(){this.chart&&(this.chart.destroy(),delete this.chart);var t=this.prepareChart(),e=t.datasets,a=t.labels,t=t.options;e&&a&&t&&(t={type:"doughnut",layers:this.layers,dataSource:this.dataSources,data:{datasets:e,labels:a},plugins:[this.layers.models[0].labelPlugin],options:$.extend(t,this.layers.models[0].computeConfigProps())},window.layers=this.layers,window.dataSources=this.dataSources,this.chart=new Chart(this.ctx,t),this.legendModel.renderhtmlLegend(this.chart))},G.prototype.updateChart=function(){var o=this;if(this.chart){var t=this.prepareChart(),e=t.datasets,a=t.labels,t=t.options;if(e&&a&&t){$.extend(!0,this.chart.options,t),e.forEach(function(t){var e,a=_.find(o.chart.data.datasets,{id:t.id});a?(e=t.data,$.extend(!0,a,t),a.data=e):o.chart.data.datasets.push(t)});for(var i=_.fromPairs(_.map(e,function(t){return[t.id,!0]})),r=0;r<this.chart.data.datasets.length;r++)i[this.chart.data.datasets[r].id]||(this.chart.data.datasets.splice(r,1),r--);_.get(this.chart,"config.data.labels")&&(this.chart.config.data.labels=a),this.chart.update()}}else this.initializeChart.bind(this).call(this)},G.prototype.prepareChart=function(){var a=this;if(!this.layers.length)return{};var t=_.flatten(_.map(this.layers.models,"dataset").filter(_.negate(_.isEmpty))),e=_.flatten(_.map(this.layers.models,"labelData").filter(_.negate(_.isEmpty))),o=this.layers.models[0],i=this.tooltips,r=this.legendModel.computePaddingAdjustment();return{datasets:t,labels:e,options:$.extend(!0,{},this.defaultOptions,{animation:this.animation.toPieJSON(),legend:this.legendModel.computeLegendProp(),layout:this.layoutModel.computeLayoutProp(r),onClick:function(t,e){e&&e.length&&(a.onClick(e[0]._index,t),a.chart.update())},tooltips:{enabled:!1,mode:"point",custom:function(t){i.customTooltip(this,t,o)}}})}},G.prototype.onClick=function(t,e){var a=this.layers.models[0],o=a.get("Basics.Data"),i=this.dataSources[o.cid],r=i.getData().at(t);a.setPopoutSegment(this.chart,t),void 0!==r&&(o=i.getPropertyFromColumn(a.get("Basics.SelectedAttr")),(t=r.get(o))===this.api.getProperty("Basics.Selected")&&(t=""),this.api.setProperty("Basics.Selected",t,!0),o=i.getDepth(),t=_.clone(this.focus),a=i.getPropertyFromColumn(a.get("DataSet.Label")),a=r.get(a),t[o]=a&&a.toString?a.toString():""+a,this.api.setProperty("Basics.Focus",t.join(","),!0),this.doActions(e))},G.prototype.doActions=function(t){var e,a=this.chart.getElementAtEvent(t);a.length&&(a=(t=a[0])._datasetIndex,t=t._index,((a=this.layers.models.length-1-a)<0||a>this.layers.models.length-1)&&(a=this.layers.models.length-1),a=this.layers.models[a].get("Basics.Data"),e=this.dataSources[a.cid].getData().at(t),t=this.api.getProperty("Basics.Actions").map(function(t){return l(l({},t),{Current:e.get(t.Current)})}),this.api.doActions(t,"Basics.Actions"))},G.prototype.onLayerDataEvents=function(t){var e=t.get("Basics.Data"),e=e?this.dataSources[e.cid]:void 0;e&&(t.updateData(e),t.set("_Hidden._PossibleColumns",e?e.getColumnNames():[]))},G.prototype.onLayerVisualEvents=function(t){t.updateVisuals()},G.prototype.setTheme=function(t){var e,a,o=this;if("Light"===t)e="#FFFFFF",a="#000000";else{if("Dark"!==t)return;e="#000000",a="#FFFFFF"}var t=t.toLowerCase(),i=this.layers.models[0];_.each(["Legend.LabelColor","InnerLabel.InnertitleColor","InnerLabel.PieceLabelColor"],function(t){i&&i.get(t)&&i.get(t).toLowerCase()===e.toLowerCase()&&i.set(t,a),o.api.getProperty(t).toLowerCase()&&e.toLowerCase()&&o.api.setProperty(t,a)}),this.$el.removeClass("dark light"),this.$el.addClass(t)},G.prototype.setThemeAccordingToDashboardSettings=function(){this.isReadyForThemeChange&&this.setTheme(this.dashboardViewModel.get("DashboardTheme"))},G.prototype.updatePossibleLayers=function(){this.layers.filter(function(t){return"Line"===t.get("_Hidden._Type")}).forEach(function(o){var t=o.collection.reduceRight(function(t,e,a){return[o===e?"nofill":"Layer "+(a+1)].concat(t)},["origin"]);o.set("_Hidden._PossibleLayers",t)}.bind(this))},G.getComponentDefinition=N.getComponentDefinition,G});